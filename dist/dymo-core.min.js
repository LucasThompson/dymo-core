function DymoManager(a,b,c){var d=new Scheduler(a,function(){});c||(c="bower_components/dymo-core/audio/impulse_rev.wav");d.setReverbFile(c);d.setScheduleAheadTime(b);var e,g={};this.loadDymoAndRendering=function(a,b,c){var m=new DymoLoader;m.loadDymoFromJson(a,function(a){m.loadRenderingFromJson(b,a[1],function(b){e=b[0];e.dymo=a[0];for(var f in b[1]){var k=b[1][f];0<=UI_CONTROLS.indexOf(k.getType())&&(g[f]=new UIControl(k))}d.loadBuffers(e.dymo);c&&c()})})};this.loadDymoFromJson=function(a,b){(new DymoLoader(d)).loadDymoFromJson(a,
function(a){b&&b(a[0])})};this.parseDymoFromJson=function(a,b){(new DymoLoader(d)).parseDymoFromJson(a,function(a){b(a[0])})};this.startPlaying=function(){d.play(e.dymo)};this.stopPlaying=function(){d.stop(e.dymo)};this.getTopDymo=function(){return e.dymo};this.getUIControl=function(a){return g[a]}};function AudioProcessor(a){function b(a){return{extract:function(b,e,g){for(var f=[],k=0;k<a.numberOfChannels;k++)f.push(a.getChannelData(k));for(k=0;k<e;k++)for(var l=0;l<f.length;l++)b[k*f.length+l%f.length]=f[l][k+g];return Math.min(e,f[0].length-g)}}}this.timeStretch=function(c,d){var e=new SoundTouch(c.sampleRate);e.tempo=d;for(var g=b(c),e=new SimpleFilter(g,e),g=a.createBuffer(c.numberOfChannels,1/d*c.length,c.sampleRate),f=[],k=0;k<c.numberOfChannels;k++)f.push(g.getChannelData(k));for(var l=
new Float32Array(2048),m=e.extract(l,1024),p=0;m;){for(k=0;k<m;k++)for(var r=0;r<f.length;r++)f[r][k+p]=l[k*f.length+r%f.length];p+=m;m=e.extract(l,1024)}return g}};function AudioProcessorSource(a,b,c){var d=this,e=new SoundTouch(b.sampleRate);this.stretchRatio={setValue:function(a){e.tempo=a},getValue:function(){return e.tempo}};this.playbackRate={setValue:function(a){e.rate=a},getValue:function(){return e.rate}};var g=new SimpleFilter({extract:function(a,c,d){for(var e=[],g=0;g<b.numberOfChannels;g++)e.push(b.getChannelData(g));for(g=0;g<c;g++)for(var f=0;f<e.length;f++)a[g*e.length+f%e.length]=e[f][g+d];return Math.min(c,e[0].length-d)}},e),f=a.createScriptProcessor(1024,
2,b.numberOfChannels),k=new Float32Array(2048);f.onaudioprocess=function(a){for(var c=[],e=0;e<b.numberOfChannels;e++)c.push(a.outputBuffer.getChannelData(e));a=g.extract(k,1024);0==a&&d.stop();for(e=0;e<a;e++)for(var f=0;f<c.length;f++)c[f][e]=k[e*c.length+f%c.length]};this.start=function(a){setTimeout(function(){f.connect(c)},a)};this.stop=function(){f.disconnect()}};function Scheduler(a,b,c){function d(){0<x&&x--;0==x&&b&&b(x)}function e(b){var c=b.getUri(),d;if(v[c])for(d=w[c],n=0;n<d.length;n++)g(c,d[n].getDymo().getUri(),d[n]);else{d=m(b);v[c]={};for(var n=0;n<d.length;n++){var f=d[n].getDymo();g(c,f.getUri(),d[n]);h[c]=f.getParameter(ONSET).getValue()}}var x;x=t[c]?t[c]-a.currentTime:q;f=a.currentTime+x;for(n=0;n<d.length;n++)d[n].play(f);setTimeout(function(){for(var a=[],b=0;b<d.length;b++)a.push(d[b].getDymo());l(a)},x);(n=m(b))?(w[c]=n,n=n[0].getDymo().getParameter(ONSET).getValue(),
x=n-h[c],-1!=n?(t[c]=f+x,h[c]=n):t[c]=f+d[0].getDuration()/d[0].getDymo().getParameter(PLAYBACK_RATE).getValue(),t[c]&&(D=setTimeout(function(){e(b)},1E3*(t[c]-a.currentTime-q)))):(t[c]=f+d[0].getDuration()/d[0].getDymo().getParameter(PLAYBACK_RATE).getValue(),D=setTimeout(function(){k(b)},1E3*(t[c]-a.currentTime)))}function g(a,b,c){v[a][b]=c}function f(a,b){var c=v[a.getUri()];if(c){for(var h in c)c[h][b].call(c[h]);return!0}}function k(a){window.clearTimeout(D);var b=a.getUri();v[b]=null;w[b]=
null;t[b]=null;a.resetPartsPlayed();l([])}function l(a){for(var b=[],h=0;h<a.length;h++)for(var d=a[h];null!=d;)0>b.indexOf(d.getUri())&&b.push(d.getUri()),d=d.getParent();r.urisOfPlayingDymos=b;c&&c()}function m(b){if(b=b.getNextParts()){for(var c=[],h=0;h<b.length;h++)if(b[h].getSourcePath()){var d=u[b[h].getSourcePath()];c.push(new Source(b[h],a,d,n))}return c}}function p(b,c){x++;var h=new XMLHttpRequest;h.open("GET",b,!0);h.responseType="arraybuffer";h.onload=function(){a.decodeAudioData(h.response,
function(a){c?c(a):(u[b]=a,d())})};h.error=function(){};h.send()}var r=this,q=.1,u={},v={},w={},t={},h={};this.urisOfPlayingDymos=[];this.listenerOrientation=new Parameter(this,0);var n=a.createConvolver();n.connect(a.destination);var x=0,D;this.setReverbFile=function(a){p(a,function(a){n.buffer=a;d()})};this.setScheduleAheadTime=function(a){q=a};this.loadBuffers=function(a){a=a.getAllSourcePaths();for(var b=0,h=a.length;b<h;b++){var c=a[b];u[c]||p(c)}};this.getBuffer=function(a){return u[a.getSourcePath()]};
this.play=function(a){a.updatePartOrder(ONSET);e(a)};this.getSources=function(a){return v[a.getUri()]};this.pause=function(a){f(a,"pause")};this.stop=function(a){f(a,"stop")&&k(a)};this.updateListenerOrientation=function(){var b=this.listenerOrientation.getValue()/180*Math.PI;a.listener.setOrientation(Math.sin(b),0,-Math.cos(b),0,1,0)}};function Source(a,b,c,d,e){function g(){var d=a.getParameter(TIME_STRETCH_RATIO).getValue();if(1!=d){if(0!=A||y<c.duration)c=p(c,m(A,c),m(y+.3,c));c=(new AudioProcessor(b)).timeStretch(c,d);d=y/d;c=p(c,0,m(d+.02,c));y=d}else if(0!=A||y<c.duration)c=p(c,m(A,c),m(y+.02,c));r(c,c.length);z.buffer=c;h[PLAYBACK_RATE]=z.playbackRate;f(PLAYBACK_RATE,a.getParameter(PLAYBACK_RATE))}function f(a,b){k(a,b.getValue());b.addObserver(v)}function k(a,b,c){c&&(b+=v.getParameterValue(a));0>b&&0<=x.indexOf(a)&&(b=
0);c=b;h[a]&&(h[a].value||0==h[a].value?h[a].value=c:h[a].setValue(c));0<=D.indexOf(a)?(0==h[DISTANCE].value&&(h[DISTANCE].value=-.01),E.setPosition(h[PAN].value,h[HEIGHT].value,h[DISTANCE].value)):a==LOOP&&(z.loop=1==b)}function l(){w=!1;var a=b.currentTime;h[AMPLITUDE].setValueAtTime(h[AMPLITUDE].value,a);h[AMPLITUDE].linearRampToValueAtTime(0,a+.02);z.stop(a+.04)}function m(a,b){if(a||0==a)return Math.round(a*b.sampleRate)}function p(a,c,h){h=Math.min(a.length-c,h);for(var d=b.createBuffer(a.numberOfChannels,
h,a.sampleRate),n=0;n<a.numberOfChannels;n++)for(var e=d.getChannelData(n),f=a.getChannelData(n),g=0;g<h;g++)e[g]=f[c+g];return d}function r(a,b){for(var c=.02*a.sampleRate,h=0;h<a.numberOfChannels;h++)for(var d=a.getChannelData(h),n=0;n<c;n++)d[n]*=n/c,d[b-n-1]*=n/c}function q(a,b,c,h){var d=a.lastIndexOf("/");d&&(a=a.substring(d+1));u("http://localhost:8060/getAudioChunk?filename="+a+"&fromSecond="+b+"&toSecond="+c,function(a){h(a)})}function u(a,c){var h=new XMLHttpRequest;h.open("GET",a,!0);h.responseType=
"arraybuffer";h.onload=function(){b.decodeAudioData(h.response,function(a){c(a)},function(a){console.log("audio from server is faulty")})};h.send()}var v=this,w,t,h={},n=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER,PAN,HEIGHT,DISTANCE,LOOP],x=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER],D=[PAN,HEIGHT,DISTANCE],z=b.createBufferSource(),B=b.createGain();B.connect(b.destination);var C=b.createGain();C.connect(d);C.gain.value=0;B.connect(C);var E=b.createPanner();E.connect(B);
d=b.createBiquadFilter();d.type="lowpass";d.frequency.value=2E4;d.connect(E);z.connect(d);var F=a.getSegment(),A=F[0],y=F[1];A||(A=0);!y&&c&&(y=c.duration-A);c?g():q(a.getSourcePath(),A,A+y+.3,function(h){c=h;h=a.getParameter(TIME_STRETCH_RATIO).getValue();1!=h?(c=(new AudioProcessor(b)).timeStretch(c,h),h=y/h,c=p(c,0,m(h+.02,c)),y=h):c=p(c,0,m(y+.02,c));r(c,c.length);z.buffer=c});h[AMPLITUDE]=B.gain;h[TIME_STRETCH_RATIO]={value:0};h[REVERB]=C.gain;h[FILTER]=d.frequency;h[PAN]={value:0};h[HEIGHT]=
{value:0};h[DISTANCE]={value:0};h[LOOP]={value:0};f(AMPLITUDE,a.getParameter(AMPLITUDE));f(TIME_STRETCH_RATIO,a.getParameter(TIME_STRETCH_RATIO));f(REVERB,a.getParameter(REVERB));f(PAN,a.getParameter(PAN));f(HEIGHT,a.getParameter(HEIGHT));f(DISTANCE,a.getParameter(DISTANCE));f(LOOP,a.getParameter(LOOP));this.observedParameterChanged=function(a){k(a.getName(),a.getChange(),!0)};this.getDymo=function(){return a};this.getDuration=function(){return y};this.isLoopingAndPlaying=function(){return z.loop&&
w};this.getParameterValue=function(a){if(h[a])return h[a].value||0==h[a].value?h[a].value:h[a].getValue()};this.play=function(b){z.onended=function(){for(var b=0;b<n.length;b++){var h=a.getParameter(n[b]);h&&h.removeObserver(v)}z.disconnect();B.disconnect();C.disconnect();e&&e()};z.start(b);w=!0};this.pause=function(){w?(l(),t=!0):t&&(t=!1,this.play())};this.stop=function(){w&&l()}};function AutoControl(a,b,c){function d(a){var b=a.getName();g[b]=a;g[b].addObserver(e)}var e=this,g={};d(new Parameter(AUTO_CONTROL_FREQUENCY,100));d(new Parameter(AUTO_CONTROL_TRIGGER,0));Control.call(this,a,AUTO_CONTROL,g);var f;this.addParameter=d;this.getParameter=function(a){return g[a]};this.startUpdate=function(){f=setInterval(b,g[AUTO_CONTROL_FREQUENCY].getValue())};this.reset=function(){clearInterval(f);f=null;c&&c()};this.observedParameterChanged=function(a){a==g[AUTO_CONTROL_FREQUENCY]?
f&&(this.reset(),this.startUpdate()):a==g[AUTO_CONTROL_TRIGGER]&&(f?this.reset():this.startUpdate())}}inheritPrototype(AutoControl,Control);function BrownianControl(a){var b=this;a||(a=.5);AutoControl.call(this,BROWNIAN,function(){var a=b.getParameter(BROWNIAN_MAX_STEP_SIZE).getValue(),a=2*a*Math.random()-a,a=b.getValue()+a,a=Math.min(Math.max(a,0),1);b.update(a)});this.addParameter(new Parameter(BROWNIAN_MAX_STEP_SIZE,.1));this.update(a);this.startUpdate()}inheritPrototype(BrownianControl,AutoControl);function RampControl(a,b){var c=this;a||(a=1E4);var d=0;b&&(d=b);var e=1!=d;AutoControl.call(this,RAMP,function(){var b=1/a*c.getParameter(AUTO_CONTROL_FREQUENCY).getValue();e||(b*=-1);d+=b;0<d&&1>d?c.update(d):1<=d?(c.update(1),c.reset()):0>=d&&(c.update(0),c.reset())},function(){e=!e});this.update(d)}inheritPrototype(RampControl,AutoControl);function RandomControl(){var a=this;AutoControl.call(this,RANDOM,function(){a.update(Math.random())});this.startUpdate()}inheritPrototype(RandomControl,AutoControl);function UIControl(a,b){var c=this;this.value=a.getValue();a.setUpdateFunction(function(a){c.value=a;b&&setTimeout(function(){b.$apply()},10)});this.getName=function(){return a.getName()};this.getType=function(){return a.getType()};this.update=function(){a.getType()==BUTTON&&(this.value=1-this.value);1==this.value?a.update(1):0==this.value?a.update(0):a.update(this.value)}};function OntologyLoader2(a,b,c){};function DymoLoader(a){function b(a,d,e,f,g){var k=new XMLHttpRequest;k.open("GET",t+a,!0);k.onload=function(){var k;if(k=d)a:{try{JSON.parse(this.responseText)}catch(l){k=!1;break a}k=!0}d=k?d.replace('"'+a+'"',this.responseText):this.responseText;(k=c(d))?b(k,d,e,f,g):(k=g(JSON.parse(d),e),f(k))};k.error=function(a){console.log(a)};k.send()}function c(a){var b=a.indexOf(".json");if(0<=b){if(b!=a.indexOf("context.json")+7){var d=a.substring(0,b).lastIndexOf('"');return a.substring(d+1,b+5)}return c(a.substring(b+
1))}}function d(a,b){var c=e(a,b);g(a,b);return[c,b]}function e(a,b){var c=new DynamicMusicObject(a["@id"],a.ct);b[a["@id"]]=c;a.source&&c.setSourcePath(t+a.source);a.navigator&&c.setNavigator(r(a.navigator,c));for(var d in a)0>w.indexOf(d)&&(a[d].type==FEATURE?c.setFeature(d,a[d].value):a[d].type==PARAMETER&&m(c,d,a[d].value));if(a.parts)for(d=0;d<a.parts.length;d++)c.addPart(e(a.parts[d],b));return c}function g(a,b){var c=b[a["@id"]];if(a.similars)for(var d=0;d<a.similars.length;d++)c.addSimilar(b[a.similars[d]]);
if(a.mappings)for(d=0;d<a.mappings.length;d++)c.addMapping(k(a.mappings[d],b,c));if(a.parts)for(d=0;d<a.parts.length;d++)g(a.parts[d],b)}function f(a,b){for(var c=new Rendering(b[a.topDymo]),d={},e=0;e<a.mappings.length;e++)c.addMapping(k(a.mappings[e],b,void 0,d));return[c,d]}function k(a,b,c,d){if(a.controls){for(var e=[],f=0;f<a.controls.length;f++)e.push(d[a.controls[f]]);return l(a,b,c,e,d)}if(a.dymos){var e=[],g;if(a.dymos instanceof Array)for(f=0;f<a.dymos.length;f++)e.push(b[a.dymos[f]]);
else g=Function.apply(null,a.dymos.args.concat(a.dymos.body)),f=Object.keys(b).map(function(a){return b[a]}),Array.prototype.push.apply(e,f.filter(g));return l(a,b,c,e,d,g)}}function l(a,b,c,d,e,f){b=a.relative;for(var g=[],k=0;k<a.domainDims.length;k++){var l=a.domainDims[k],p=l.name,u=l.type;u==FEATURE?g.push(p):u==PARAMETER?(p=c?m(c,p,0):new Parameter(p,0),g.push(p)):(l=e&&e[p]?e[p]:q(l),e&&!e[p]&&(e[p]=l),g.push(l))}return new Mapping(g,b,a["function"],d,a.parameter,f)}function m(a,b,c){var d=
a.getParameter(b);d?d.update(c):(d=new Parameter(b,c),a.addParameter(d));return d}function p(a,b){for(var c=0;c<a.length;c++)if(a[c])for(var d=0;d<a[c].length;d++){var e=b["dymo"+c],f=b["dymo"+a[c][d]];e&&f&&e.addSimilar(f)}}function r(a,b){return a==SIMILARITY_NAVIGATOR?new SimilarityNavigator(b):new SequentialNavigator(b)}function q(b){var c=b.type,d=b.name;if(c==ACCELEROMETER_X)return u(0);if(c==ACCELEROMETER_Y)return u(1);if(c==ACCELEROMETER_Z)return u(2);if(c==TILT_X)return u(3);if(c==TILT_Y)return u(4);
if(c==GEOLOCATION_LATITUDE)return v(0);if(c==GEOLOCATION_LONGITUDE)return v(1);if(c==GEOLOCATION_DISTANCE)return v(2);if(c==COMPASS_HEADING)return a.compassWatcher||(a.compassWatcher=new CompassWatcher),b=a.compassWatcher.headingControl,b;if(c==SLIDER||c==TOGGLE||c==BUTTON)return new Control(d,c);if(c==RANDOM)return new RandomControl;if(c==BROWNIAN)return new BrownianControl(parseFloat(b.value));if(c==RAMP)return c=Math.round(1E3*parseFloat(b.duration)),new RampControl(c,parseFloat(b.value))}function u(b){a.accelerometerWatcher||
(a.accelerometerWatcher=new AccelerometerWatcher);if(0==b)return a.accelerometerWatcher.xControl;if(1==b)return a.accelerometerWatcher.yControl;if(2==b)return a.accelerometerWatcher.zControl;if(3==b)return a.accelerometerWatcher.tiltXControl;if(4==b)return a.accelerometerWatcher.tiltYControl}function v(b){a.geolocationWatcher||(a.geolocationWatcher=new GeolocationWatcher);return 0==b?a.geolocationWatcher.latitudeControl:1==b?a.geolocationWatcher.longitudeControl:a.geolocationWatcher.distanceControl}
var w="@id @type ct source navigator similars mappings parts".split(" "),t="";this.loadDymoFromJson=function(a,c){var e=a.lastIndexOf("/")+1;t=a.substring(0,e);a=a.substring(e);b(a,"",{},c,d)};this.parseDymoFromJson=function(a,b){b(d(a,{}))};this.loadRenderingFromJson=function(a,c,d){b(a,"",c,d,f)};this.loadGraphFromJson=function(a,c,d){b(a,"",c,d,p)}};function DymoWriter(a){function b(a){a.addTriple("_:","http://www.w3.org/1999/02/22-rdf-syntax-ns#type","dmo:DMO");a.addTriple("_:","ch:hasPart","ch:test2")}function c(a,b){var c=new XMLHttpRequest;c.send(b);c.addEventListener("save",function(){console.log("saved "+a)});c.addEventListener("error",function(){console.log("saving "+a+" failed")});c.open("POST",a);c.send()}this.writeDymoToJson=function(a,b,g){a["@context"]="http://purl.org/ontology/dymo/context.json";g||(g="dymo.json");c(b+g,a)};this.writeRenderingToJson=
function(a,b){c(b+"rendering.json",a)};this.writeDmoToRdf=function(a){a=N3.Writer({prefixes:{ch:"rdf/charm.n3#",dmo:"rdf/dmo.n3#",mb:"rdf/mobile.n3#"}});b(a);a.end(function(a,b){console.log(b)})}};var DYMO="Dymo",PARALLEL="parallel",SEQUENTIAL="sequential",DYMO_TYPES=[PARALLEL,SEQUENTIAL],FEATURE="Feature",PARAMETER="Parameter",SEQUENTIAL_NAVIGATOR="SequentialNavigator",SIMILARITY_NAVIGATOR="SimilarityNavigator",PLAY="Play",LOOP="Loop",ONSET="Onset",DURATION_RATIO="DurationRatio",AMPLITUDE="Amplitude",PLAYBACK_RATE="PlaybackRate",TIME_STRETCH_RATIO="TimeStretchRatio",PAN="Pan",DISTANCE="Distance",HEIGHT="Height",REVERB="Reverb",FILTER="Filter",PART_INDEX="PartIndex",PART_COUNT="PartCount",
PART_ORDER="PartOrder",LISTENER_ORIENTATION="ListenerOrientation",AUTO_CONTROL_FREQUENCY="AutoControlFrequency",AUTO_CONTROL_TRIGGER="AutoControlTrigger",BROWNIAN_MAX_STEP_SIZE="BrownianMaxStepSize",LEAPING_PROBABILITY="LeapingProbability",CONTINUE_AFTER_LEAPING="ContinueAfterLeaping",PARAMETERS=[PLAY,LOOP,ONSET,DURATION_RATIO,AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,PAN,DISTANCE,HEIGHT,REVERB,FILTER,PART_INDEX,PART_COUNT,PART_ORDER,LISTENER_ORIENTATION,AUTO_CONTROL_FREQUENCY,AUTO_CONTROL_TRIGGER],
LEVEL="level",INDEX="index",ONSET_FEATURE="onset",PITCH_FEATURE="pitch",DURATION_FEATURE="duration",AUTO_CONTROL="AutoControl",SLIDER="Slider",TOGGLE="Toggle",BUTTON="Button",ACCELEROMETER_X="AccelerometerX",ACCELEROMETER_Y="AccelerometerY",ACCELEROMETER_Z="AccelerometerZ",TILT_X="TiltX",TILT_Y="TiltY",GEOLOCATION_LATITUDE="GeolocationLatitude",GEOLOCATION_LONGITUDE="GeolocationLongitude",GEOLOCATION_DISTANCE="GeolocationDistance",COMPASS_HEADING="CompassHeading",RANDOM="Random",BROWNIAN="Brownian",
RAMP="Ramp",CONTROLS=[SLIDER,TOGGLE,ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,COMPASS_HEADING,RANDOM,BROWNIAN,RAMP],UI_CONTROLS=[SLIDER,TOGGLE,BUTTON];function Control(a,b,c){function d(a,b){if(void 0==g||1E-6<Math.abs(a-g))g=a,e(b)}function e(a){for(var b=0;b<l.length;b++)l[b]!=a&&l[b].updateParameter(g,this)}var g,f,k,l=[],m,p,r;this.getName=function(){return a};this.getParameter=function(a){if(c)return c[a]};this.getValue=function(){return g};this.getType=function(){return b};this.getReferenceValue=function(){return f};this.setReferenceAverageCount=function(a){k=a;this.resetReferenceValue()};this.resetReferenceValue=function(){f=g=void 0;p=m=
0};this.setUpdateFunction=function(a){r=a};this.addMapping=function(a){l.push(a);a.updateParameter(g,this)};this.removeMapping=function(a){a=l.indexOf(a);-1<a&&l.splice(a,1)};this.backpropagate=function(a,b){isFinite(a)&&(d(a,b),r&&r(g))};this.update=function(a){k&&m<k?(p+=a,m++,m==k&&(f=p/=k)):isNaN(a)||(f&&(a-=f),d(a))}};function DynamicMusicObject(a,b){function c(a,b){b[a.getUri()]=a;for(var d=0;d<a.getParts().length;d++)c(a.getParts()[d],b)}function d(a,b,c,e){var f=a-b,g=e.getParts();if(e.getLevel()==c&&0==f)return e;if(e.getLevel()>=c-1)return f<g.length?g[f]:b+g.length;for(e=0;e<g.length;e++)if(b=d(a,b,c,g[e]),isNaN(b))return b}function e(a,b){var c=a.getSourcePath();0>b.indexOf(c)&&b.push(c);for(var c=a.getParts(),d=0,f=c.length;d<f;d++)e(c[d],b)}function g(a,b,c){var d=b.toFlatJson();a.nodes.push(d);c&&a.links.push(k(c,
d));for(c=0;c<b.getParts().length;c++)g(a,b.getParts()[c],d)}function f(a,b,c){c||(c={});c[b.getUri()]||(c[b.getUri()]=b.toFlatJson());var d=c[b.getUri()];a.nodes.push(d);for(var e=0;e<b.getSimilars().length;e++){var g=b.getSimilars()[e];c[g.getUri()]||(c[g.getUri()]=g.toFlatJson());a.links.push(k(d,c[g.getUri()]))}for(e=0;e<b.getParts().length;e++)f(a,b.getParts()[e],c)}function k(a,b){return{source:a,target:b,value:1}}var l=null,m=[],p=[],r={},q={},u=[],v=[],w;q[PLAY]=new Parameter(PLAY,0,!0);q[LOOP]=
new Parameter(LOOP,0,!0);q[ONSET]=new Parameter(ONSET,-1);q[DURATION_RATIO]=new Parameter(DURATION_RATIO,1);q[AMPLITUDE]=new Parameter(AMPLITUDE,1);q[PLAYBACK_RATE]=new Parameter(PLAYBACK_RATE,1);q[TIME_STRETCH_RATIO]=new Parameter(TIME_STRETCH_RATIO,1);q[PAN]=new Parameter(PAN,0);q[DISTANCE]=new Parameter(DISTANCE,0);q[HEIGHT]=new Parameter(HEIGHT,0);q[REVERB]=new Parameter(REVERB,0);q[FILTER]=new Parameter(FILTER,0);q[PART_INDEX]=new Parameter(PART_INDEX,0,!0);q[PART_COUNT]=new Parameter(PART_COUNT,
Number.POSITIVE_INFINITY,!0);q[PLAY].addObserver(this);q[PART_INDEX].addObserver(this);q[PART_COUNT].addObserver(this);var t=new SequentialNavigator(this);this.setType=function(a){b=a};this.getType=function(){return b};this.getUri=function(){return a};this.setParent=function(a){l=a;for(var b in q)b!=PLAY&&b!=PART_COUNT&&b!=PART_INDEX&&v.push(new Mapping([a.getParameter(b)],!0,void 0,[this],b));a=l.getMappings();var c=this.getDymoMap(),c=Object.keys(c).map(function(a){return c[a]});for(b=0;b<a.length;b++){var d=
a[b].getDymoConstraint();d&&(d=a[b].getTargets().concat(c.filter(d)),a[b].setTargets(d))}};this.removeParent=function(){for(var a=0;a<v.length;a++)v[a].disconnect();v=[];for(var b=l.getMappings(),c=this,a=0;a<b.length;a++){var d=b[a].getTargets(),d=d.filter(function(a){return!a.isSubDymoOf(c)});b[a].setTargets(d)}l=null};this.getParent=function(){return l};this.isSubDymoOf=function(a){for(var b=this;b;){if(b==a)return!0;b=b.getParent()}return!1};this.getDymoMap=function(){var a={};c(this,a);return a};
this.getLevel=function(){return l?l.getLevel()+1:0};this.getIndex=function(){if(l)return l.getParts().indexOf(this)};this.addPart=function(a){m.push(a);a.setParent(this)};this.removePart=function(a){m.splice(m.indexOf(a));a.removeParent(this)};this.replacePart=function(a,b){m[a]&&m[a].removeParent(this);m[a]=b;b.setParent(this)};this.getPart=function(a){return m[a]};this.getParts=function(){return m};this.getNthPart=function(a,b){return d(a,0,b,this)};this.setSourcePath=function(a){w=a};this.getSourcePath=
function(){return l&&!w?l.getSourcePath():w};this.getAllSourcePaths=function(a){var b=[];e(a,b);return b};this.addSimilar=function(a){p.push(a)};this.getSimilars=function(a){return p};this.getFeatures=function(){return r};this.setFeature=function(a,b){r[a]=b};this.getFeature=function(a){if(a===LEVEL)return this.getLevel();if(a===INDEX)return this.getIndex();if(r.hasOwnProperty(a))return r[a];if(l)return l.getFeature(a);for(var b=[],c=0;c<m.length;c++)if(m[c]){var d=m[c].getFeatureWithoutLookingFurther(a);
isNaN(d)||b.push(d)}if(0<b.length)return b};this.getFeatureWithoutLookingFurther=function(a){if(r[a])return r[a]};this.getMappings=function(){return u};this.getSegment=function(){return[this.getFeature("time"),q[DURATION_RATIO].getValue()*this.getFeature("duration")]};this.addParameter=function(a){q[a.getName()]=a};this.getParameter=function(a){return q[a]};this.addMapping=function(a){u.push(a)};this.observedParameterChanged=function(a){a.getName()==PLAY&&a.getChange()};this.setNavigator=function(a){t=
a};this.getNavigator=function(){return t};this.resetPartsPlayed=function(){t.resetPartsPlayed();for(var a=0;a<m.length;a++)m[a].resetPartsPlayed()};this.updatePartOrder=function(a){m&&m[0]&&!isNaN(m[0].getFeature(a))?m.sort(function(b,c){return b.getFeature(a)-c.getFeature(a)}):m&&m.sort(function(b,c){return b.getParameter(a).getValue()-c.getParameter(a).getValue()})};this.getNextParts=function(){return t.getNextParts()};this.toJsonHierarchy=function(){for(var a=this.toFlatJson(),b=0;b<m.length;b++)a.parts.push(m[b].toJsonHierarchy());
return a};this.toJsonHierarchyGraph=function(){var a={nodes:[],links:[]};g(a,this);return a};this.toJsonSimilarityGraph=function(){var a={nodes:[],links:[]};f(a,this);return a};this.toFlatJson=function(){var c={"@id":a,"@type":DYMO};b&&(c.ct=b);w&&(c.source=w);t instanceof SimilarityNavigator&&(c.navigator=SIMILARITY_NAVIGATOR);for(var d in r)c[d]=this.getFeatureJson(d);if(0<u.length)for(c.mappings=[],d=0;d<u.length;d++)c.mappings.push(u[d].toJson());0<m.length&&(c.parts=[]);if(0<p.length)for(c.similars=
[],d=0;d<p.length;d++)c.similars.push(p[d].getUri());return c};this.getFeatureJson=function(a){return{value:r[a],type:FEATURE,adt:a.charAt(0).toUpperCase()+a.slice(1)}}};function Mapping(a,b,c,d,e,g){this.domainDims=a;this.relative=b;this.functionJson=c;this.parameterName=e;this.dymoConstraint=g;this.setTargets(d);this.init()}
Mapping.prototype.init=function(){this.functionJson||(this.functionJson=FunctionTools.IDENTITY_JSON);this.mappingFunction=FunctionTools.createFunction(this.functionJson.args,this.functionJson.body);this.inverseFunction=FunctionTools.invertFunction(this.functionJson.body);for(var a=0;a<this.domainDims.length;a++)this.domainDims[a].addMapping?this.domainDims[a].addMapping(this):this.domainDims[a].addObserver&&this.domainDims[a].addObserver(this)};
Mapping.prototype.setTargets=function(a){if(this.targets)for(var b=0,c=this.targetParameters.length;b<c;b++)this.targetParameters[b].removeUpdater(this);this.targets=a;this.targetParameters=[];b=0;for(c=this.targets.length;b<c;b++)this.targetParameters[b]=this.targets[b].getParameter(this.parameterName),this.targetParameters[b].addUpdater(this)};Mapping.prototype.getTargets=function(){return this.targets};Mapping.prototype.getDymoConstraint=function(){return this.dymoConstraint};
Mapping.prototype.disconnect=function(){for(var a=0;a<this.domainDims.length;a++)this.domainDims[a].removeMapping?this.domainDims[a].removeMapping(this):this.domainDims[a].removeObserver&&this.domainDims[a].removeObserver(this);for(a=0;a<this.targetParameters.length;a++)this.targetParameters[a].removeUpdater(this)};
Mapping.prototype.updateParameter=function(){for(var a=0;a<this.targetParameters.length;a++)this.relative?this.targetParameters[a].relativeUpdate(this.calculateParameter(this.targets[a]),this):this.targetParameters[a].update(this.calculateParameter(this.targets[a]),this)};Mapping.prototype.observedParameterChanged=function(a){this.updateParameter()};
Mapping.prototype.updatedParameterChanged=function(a){this.domainDims[0].backpropagate&&!this.relative&&(this.inverseFunction&&(a=this.inverseFunction(a)),this.domainDims[0].backpropagate(a,this))};Mapping.prototype.requestValue=function(a){for(var b=0;b<this.domainDims.length;b++)this.domainDims[b].requestValue&&this.domainDims[b].requestValue();return this.calculateParameter(a)};
Mapping.prototype.toJson=function(){for(var a=[],b=0;b<this.domainDims.length;b++)this.domainDims[b]instanceof Control?a.push({name:this.domainDims[b].getName(),type:this.domainDims[b].getType()}):this.domainDims[b]instanceof Parameter?a.push({name:this.domainDims[b].getName(),type:"Parameter"}):a.push({name:this.domainDims[b],type:"Feature"});var a={domainDims:a,"function":this.functionJson},b=this.targets.filter(function(a){return a instanceof DynamicMusicObject}).map(function(a){return a.getUri()}),
c=this.targets.filter(function(a){return!(a instanceof DynamicMusicObject)}).map(function(a){return a.getUri()});0<b.length&&(a.dymos=b);0<c.length&&(a.controls=c);a.parameter=this.parameterName;return a};
Mapping.prototype.calculateParameter=function(a){for(var b=[],c=0;c<this.domainDims.length;c++){var d;d="string"===typeof this.domainDims[c]||this.domainDims[c]instanceof String?a.getFeature(this.domainDims[c]):this.relative?this.domainDims[c].getChange():this.domainDims[c].getValue();b[c]=d}return this.mappingFunction.apply(this,b)};function Parameter(a,b,c){this.name=a;this.value=b;this.change=0;this.isInteger=c;this.updaters=[];this.observers=[]}Parameter.prototype.getName=function(){return this.name};Parameter.prototype.getValue=function(){return this.value};Parameter.prototype.getChange=function(){return this.change};Parameter.prototype.addUpdater=function(a){0>this.updaters.indexOf(a)&&(this.updaters.push(a),a.updatedParameterChanged(this.value))};
Parameter.prototype.removeUpdater=function(a){a=this.updaters.indexOf(a);-1<a&&this.updaters.splice(a,1)};Parameter.prototype.addObserver=function(a){this.observers.push(a)};Parameter.prototype.removeObserver=function(a){a=this.observers.indexOf(a);-1<a&&this.observers.splice(a,1)};Parameter.prototype.getObservers=function(){return this.observers};Parameter.prototype.update=function(a,b){this.setValueAndNotify(b,a)};Parameter.prototype.relativeUpdate=function(a,b){this.update(this.value+a,b)};
Parameter.prototype.requestValue=function(){for(var a=0;a<this.updaters.length;a++){var b=this.updaters[a].requestValue();if(b&&b!=this.value){this.setValueAndNotify(this.updaters[a],b);break}}return this.value};Parameter.prototype.notifyObservers=function(){for(var a=0;a<this.observers.length;a++)this.observers[a].observedParameterChanged(this)};
Parameter.prototype.setValueAndNotify=function(a,b){if(!isNaN(b)&&(this.isInteger&&(b=Math.round(b)),1E-6<Math.abs(b-this.value))){this.change=b-this.value;this.value=b;for(var c=0;c<this.updaters.length;c++)this.updaters[c]!=a&&this.updaters[c].updatedParameterChanged(this.value);this.change&&this.notifyObservers()}};function Rendering(a){var b=[];this.play=function(){a&&a.getParameter(PLAY).update(1)};this.stop=function(){a&&a.getParameter(PLAY).update(0)};this.addMapping=function(a){b.push(a);a.updateParameter()};this.getMappings=function(){return b};this.toJson=function(){var c={mappings:[]};a&&(c.topDymo=a.getUri());for(var d=0;d<b.length;d++)c.mappings.push(b[d].toJson());return c}};function FunctionTools(){}FunctionTools.IDENTITY_JSON={args:["a"],body:"return a;"};FunctionTools.inverted={};FunctionTools.created={};FunctionTools.createFunction=function(a,b){FunctionTools.created[b]||(FunctionTools.created[b]=Function.apply(null,a.concat(b)));return FunctionTools.created[b]};
FunctionTools.invertFunction=function(a){var b=FunctionTools.toReturnValueString(a);FunctionTools.inverted[a]||(FunctionTools.inverted[a]=FunctionTools.toJavaScriptFunction(FunctionTools.invertReturnValue(b)));return FunctionTools.inverted[a]};
FunctionTools.invertReturnValue=function(a){var b;try{b=math.parse(a)}catch(e){e instanceof SyntaxError||console.log(e);return}for(var c=a=new math.expression.node.SymbolNode("a");b;)if(b.isSymbolNode)a.name=b.name,b=void 0;else if(b.isParenthesisNode)b=b.content;else if(b.isOperatorNode){var d=FunctionTools.getInvertedOperator(b.op);if("+"==b.op||"*"==b.op)if(b.args[0].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[0]]),b=FunctionTools.ifNextNode(b.args[1]);
else if(b.args[1].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[1]]),b=FunctionTools.ifNextNode(b.args[0]);else return;else if("-"==b.op||"/"==b.op)if(b.args[0].isConstantNode)c=new math.expression.node.OperatorNode(b.op,FunctionTools.getOperatorName(b.op),[b.args[0],c]),b=FunctionTools.ifNextNode(b.args[1]);else if(b.args[1].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[1]]),b=FunctionTools.ifNextNode(b.args[0]);
else return}else return;return c.toString()};FunctionTools.toJavaScriptFunction=function(a){return new Function("a","return "+a+";")};FunctionTools.toReturnValueString=function(a){return a.substring(a.indexOf("return ")+7,a.indexOf(";"))};FunctionTools.ifNextNode=function(a){if(a.isOperatorNode||a.isParenthesisNode||a.isSymbolNode)return a};FunctionTools.getInvertedOperator=function(a){if("+"==a)return"-";if("-"==a)return"+";if("*"==a)return"/";if("/"==a)return"*"};
FunctionTools.getOperatorName=function(a){if("+"==a)return"add";if("-"==a)return"subtract";if("*"==a)return"multiply";if("/"==a)return"divide"};function PolygonTools(){}PolygonTools.isPointInPolygon=function(a,b){for(var c=!1,d=-1,e=a.length,g=e-1;++d<e;g=d)(a[d][1]<=b[1]&&b[1]<a[g][1]||a[g][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[g][0]-a[d][0])*(b[1]-a[d][1])/(a[g][1]-a[d][1])+a[d][0]&&(c=!c);return c};PolygonTools.getArea=function(a){var b=0,c,d,e=0;for(d=a.length-1;e<a.length;d=e,e++)c=a[e],d=a[d],b+=c[0]*d[1],b-=c[1]*d[0];return b/2};
PolygonTools.getCentroid=function(a){var b,c,d,e=0,g=0,f=0;for(c=a.length-1;f<a.length;c=f,f++)b=a[f],c=a[c],d=b[0]*c[1]-c[0]*b[1],e+=(b[0]+c[0])*d,g+=(b[1]+c[1])*d;d=6*PolygonTools.getArea(a);return{0:e/d,1:g/d}};function sqDist(a,b){return Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2)}
PolygonTools.getDistanceFromSegment=function(a,b,c){var d=sqDist(b,c);if(0==d)return sqDist(a,b);d=((a[0]-b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return 0>d?sqDist(a,b):1<d?sqDist(a,c):Math.sqrt(sqDist(a,{0:b[0]+d*(c[0]-b[0]),1:b[1]+d*(c[1]-b[1])}))};PolygonTools.getMinDistanceFromEdge=function(a,b){for(var c=Number.POSITIVE_INFINITY,d=0;d<a.length;d++)var e=PolygonTools.getDistanceFromSegment(b,a[d],a[(d+1)%a.length]),c=Math.min(e,c);return c};
PolygonTools.howFarIsPointInPolygon=function(a,b,c){return PolygonTools.isPointInPolygon(a,c)?(b=Math.sqrt(Math.pow(c[0]-b[0],2)+Math.pow(c[1]-b[1],2)),a=PolygonTools.getMinDistanceFromEdge(a,c),Math.sqrt((1-b)*a/Math.abs(b+a))):0};PolygonTools.getPolygonFunctionArgs=function(a){return["a","b","return PolygonTools.isPointInPolygon("+getPolygonOrPointString(a)+", {0:a, 1:b});"]};
PolygonTools.getInterpolatedPolygonFunctionArgs=function(a){var b=getPolygonOrPointString(a);a=getPolygonOrPointString(PolygonTools.getCentroid(a));return["a","b","return PolygonTools.howFarIsPointInPolygon("+b+","+a+", {0:a, 1:b});"]};function getPolygonOrPointString(a){return JSON.stringify(a).replace(/"/g,"'")};function SequentialNavigator(a){var b=!1,c=0;this.resetPartsPlayed=function(){c=0};this.setPartsPlayed=function(a){c=a};this.getPartsPlayed=function(){return c};this.getNextParts=function(){var d=a.getParts();if(0<d.length){if(a.getType()==PARALLEL){for(var e=[],g=0;g<d.length;g++){var f=d[g].getNextParts();f&&(!f.length||0<f.length)&&(e=e.concat(f))}if(0<e.length)return console.log(e.map(function(a){return a.getIndex()})),e}else for(b=!0;c<d.length&&c<a.getParameter(PART_COUNT).getValue();){if((f=
d[c].getNextParts())&&(!f.length||0<f.length))return f instanceof Array||(f=[f]),f;c++}c=0;b=!1;return null}if(b)return b=!1,null;b=!0;return[a]}};function SimilarityNavigator(a){function b(b){for(var d=0;d<b.length;d++)if(0<b[d].getSimilars().length&&Math.random()<c.leapingProbability.getValue()){var k=b[d].getSimilars(),l=Math.floor(Math.random()*k.length);if(c.continueAfterLeaping.getValue()){var m=a.getParts().indexOf(l);m&&(e=m+1)}b[d]=k[l]}}var c=this,d=!1,e=0;this.leapingProbability=new Parameter(LEAPING_PROBABILITY,.5);this.continueAfterLeaping=new Parameter(CONTINUE_AFTER_LEAPING,0,!0);this.resetPartsPlayed=function(){e=0};this.getNextParts=
function(){var c=a.getParts();if(0<c.length){if(a.getType()==PARALLEL){for(var f=[],k=0;k<c.length;k++){var l=c[k].getNextParts();l&&(!l.length||0<l.length)&&(f=f.concat(l))}if(0<f.length)return b(f),f}else for(d=!0;e<c.length&&e<a.getParameter(PART_COUNT).getValue();){if((l=c[e].getNextParts())&&(!l.length||0<l.length))return l instanceof Array||(l=[l]),b(l),l;e++}e=0;d=!1;return null}if(d)return d=!1,null;d=!0;return[a]}};function inheritPrototype(a,b){var c=Object.create(b.prototype);c.constructor=a;a.prototype=c};function SoundTouch(a){this.rateTransposer=new RateTransposer(!1);this.tdStretch=new Stretch(!1,a);this._inputBuffer=new FifoSampleBuffer;this._intermediateBuffer=new FifoSampleBuffer;this._outputBuffer=new FifoSampleBuffer;this.tempo=this._rate=0;this.virtualTempo=this.virtualRate=this.virtualPitch=1;this._calculateEffectiveRateAndTempo()}
extend(SoundTouch.prototype,{clear:function(){this.rateTransposer.clear();this.tdStretch.clear()},clone:function(){var a=new SoundTouch;a.rate=this._rate;a.tempo=this.tempo;return a},get rate(){return this._rate},set rate(a){this.virtualRate=a;this._calculateEffectiveRateAndTempo()},set rateChange(a){this.rate=1+.01*a},get tempo(){return this._tempo},set tempo(a){this.virtualTempo=a;this._calculateEffectiveRateAndTempo()},set tempoChange(a){this.tempo=1+.01*a},set pitch(a){this.virtualPitch=a;this._calculateEffectiveRateAndTempo()},
set pitchOctaves(a){this.pitch=Math.exp(.69314718056*a);this._calculateEffectiveRateAndTempo()},set pitchSemitones(a){this.pitchOctaves=a/12},get inputBuffer(){return this._inputBuffer},get outputBuffer(){return this._outputBuffer},_calculateEffectiveRateAndTempo:function(){var a=this._tempo,b=this._rate;this._tempo=this.virtualTempo/this.virtualPitch;this._rate=this.virtualRate*this.virtualPitch;testFloatEqual(this._tempo,a)&&(this.tdStretch.tempo=this._tempo);testFloatEqual(this._rate,b)&&(this.rateTransposer.rate=
this._rate);1<this._rate?this._outputBuffer!=this.rateTransposer.outputBuffer&&(this.tdStretch.inputBuffer=this._inputBuffer,this.tdStretch.outputBuffer=this._intermediateBuffer,this.rateTransposer.inputBuffer=this._intermediateBuffer,this.rateTransposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.tdStretch.outputBuffer&&(this.rateTransposer.inputBuffer=this._inputBuffer,this.rateTransposer.outputBuffer=this._intermediateBuffer,this.tdStretch.inputBuffer=this._intermediateBuffer,this.tdStretch.outputBuffer=
this._outputBuffer)},process:function(){1<this._rate?(this.tdStretch.process(),this.rateTransposer.process()):(this.rateTransposer.process(),this.tdStretch.process())}});function FifoSampleBuffer(){this._vector=new Float32Array;this._frameCount=this._position=0}
FifoSampleBuffer.prototype={get vector(){return this._vector},get position(){return this._position},get startIndex(){return 2*this._position},get frameCount(){return this._frameCount},get endIndex(){return 2*(this._position+this._frameCount)},clear:function(){this.receive();this.rewind()},put:function(a){this._frameCount+=a},putSamples:function(a,b,c){b=2*(b||0);0<=c||(c=(a.length-b)/2);var d=2*c;this.ensureCapacity(c+this._frameCount);var e=this.endIndex;this._vector.set(a.subarray(b,b+d),e);this._frameCount+=
c},putBuffer:function(a,b,c){b=b||0;0<=c||(c=a.frameCount-b);this.putSamples(a.vector,a.position+b,c)},receive:function(a){if(!(0<=a)||a>this._frameCount)a=this._frameCount;this._frameCount-=a;this._position+=a},receiveSamples:function(a,b){var c=this.startIndex;a.set(this._vector.subarray(c,c+2*b));this.receive(b)},extract:function(a,b,c){b=this.startIndex+2*b;a.set(this._vector.subarray(b,b+2*c))},ensureCapacity:function(a){a*=2;this._vector.length<a?(a=new Float32Array(a),a.set(this._vector.subarray(this.startIndex,
this.endIndex)),this._vector=a,this._position=0):this.rewind()},ensureAdditionalCapacity:function(a){this.ensureCapacity(this.frameCount+a)},rewind:function(){0<this._position&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}};function extend(a,b){for(var c in b){var d=b.__lookupGetter__(c),e=b.__lookupSetter__(c);d||e?(d&&a.__defineGetter__(c,d),e&&a.__defineSetter__(c,e)):a[c]=b[c]}return a}function testFloatEqual(a,b){return 1E-10<(a>b?a-b:b-a)}
function FilterSupport(a){this._pipe=a}
FilterSupport.prototype={get pipe(){return this._pipe},get inputBuffer(){return this._pipe.inputBuffer},get outputBuffer(){return this._pipe.outputBuffer},fillOutputBuffer:function(a){for(;this.outputBuffer.frameCount<a;){this.fillInputBuffer(16-this.inputBuffer.frameCount);if(16>this.inputBuffer.frameCount)break;this._pipe.process()}},clear:function(){this._pipe.clear();this.outputBufferPosition=0},get position(){return this._position},set position(a){if(a>this._position)throw new RangeError("New position may not be greater than current position");
var b=this.outputBufferPosition-(this._position-a);if(0>b)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=b;this._position=a},get sourcePosition(){return this._sourcePosition},set sourcePosition(a){this.clear();this._sourcePosition=a},fillInputBuffer:function(a){var b=new Float32Array(2*a);a=this.sourceSound.extract(b,a,this._sourcePosition);this._sourcePosition+=a;this.inputBuffer.putSamples(b,0,a)},extract:function(a,b){this.fillOutputBuffer(this.outputBufferPosition+
b);var c=Math.min(b,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(a,this.outputBufferPosition,c);var d=this.outputBufferPosition+c;this.outputBufferPosition=Math.min(this.historyBufferSize,d);this.outputBuffer.receive(Math.max(d-this.historyBufferSize,0));this._position+=c;return c},handleSampleData:function(a){this.extract(a.data,4096)}};
function SimpleFilter(a,b){FilterSupport.call(this,b);this.sourceSound=a;this.historyBufferSize=22050;this._position=this.outputBufferPosition=this._sourcePosition=0}extend(SimpleFilter.prototype,FilterSupport.prototype);function AbstractFifoSamplePipe(a){a?(this.inputBuffer=new FifoSampleBuffer,this.outputBuffer=new FifoSampleBuffer):this.inputBuffer=this.outputBuffer=null}
AbstractFifoSamplePipe.prototype={get inputBuffer(){return this._inputBuffer},set inputBuffer(a){this._inputBuffer=a},get outputBuffer(){return this._outputBuffer},set outputBuffer(a){this._outputBuffer=a},clear:function(){this._inputBuffer.clear();this._outputBuffer.clear()}};function RateTransposer(a){AbstractFifoSamplePipe.call(this,a);this._reset();this.rate=1}extend(RateTransposer.prototype,AbstractFifoSamplePipe.prototype);
extend(RateTransposer.prototype,{set rate(a){this._rate=a},_reset:function(){this.prevSampleR=this.prevSampleL=this.slopeCount=0},clone:function(){var a=new RateTransposer;a.rate=this._rate;return a},process:function(){var a=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(a/this._rate+1);a=this._transpose(a);this._inputBuffer.receive();this._outputBuffer.put(a)},_transpose:function(a){if(0==a)return 0;for(var b=this._inputBuffer.vector,c=this._inputBuffer.startIndex,d=this._outputBuffer.vector,
e=this._outputBuffer.endIndex,g=0,f=0;1>this.slopeCount;)d[e+2*f]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*b[c],d[e+2*f+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*b[c+1],f++,this.slopeCount+=this._rate;--this.slopeCount;if(1!=a)a:for(;;){for(;1<this.slopeCount;)if(--this.slopeCount,g++,g>=a-1)break a;var k=c+2*g;d[e+2*f]=(1-this.slopeCount)*b[k]+this.slopeCount*b[k+2];d[e+2*f+1]=(1-this.slopeCount)*b[k+1]+this.slopeCount*b[k+3];f++;this.slopeCount+=this._rate}this.prevSampleL=
b[c+2*a-2];this.prevSampleR=b[c+2*a-1];return f}});
var USE_AUTO_SEQUENCE_LEN=0,DEFAULT_SEQUENCE_MS=USE_AUTO_SEQUENCE_LEN,USE_AUTO_SEEKWINDOW_LEN=0,DEFAULT_SEEKWINDOW_MS=USE_AUTO_SEEKWINDOW_LEN,DEFAULT_OVERLAP_MS=8,_SCAN_OFFSETS=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],AUTOSEQ_TEMPO_LOW=.5,AUTOSEQ_TEMPO_TOP=2,
AUTOSEQ_AT_MIN=125,AUTOSEQ_AT_MAX=50,AUTOSEQ_K=(AUTOSEQ_AT_MAX-AUTOSEQ_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEQ_C=AUTOSEQ_AT_MIN-AUTOSEQ_K*AUTOSEQ_TEMPO_LOW,AUTOSEEK_AT_MIN=25,AUTOSEEK_AT_MAX=15,AUTOSEEK_K=(AUTOSEEK_AT_MAX-AUTOSEEK_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEEK_C=AUTOSEEK_AT_MIN-AUTOSEEK_K*AUTOSEQ_TEMPO_LOW;
function Stretch(a,b){AbstractFifoSamplePipe.call(this,a);this.bQuickSeek=!0;this.bMidBufferDirty=!1;this.pMidBuffer=null;this.overlapLength=0;this.bAutoSeekSetting=this.bAutoSeqSetting=!0;this._tempo=1;this.setParameters(b,DEFAULT_SEQUENCE_MS,DEFAULT_SEEKWINDOW_MS,DEFAULT_OVERLAP_MS)}extend(Stretch.prototype,AbstractFifoSamplePipe.prototype);
extend(Stretch.prototype,{clear:function(){AbstractFifoSamplePipe.prototype.clear.call(this);this._clearMidBuffer()},_clearMidBuffer:function(){this.bMidBufferDirty&&(this.bMidBufferDirty=!1,this.pMidBuffer=null)},setParameters:function(a,b,c,d){0<a&&(this.sampleRate=a);0<d&&(this.overlapMs=d);0<b?(this.sequenceMs=b,this.bAutoSeqSetting=!1):this.bAutoSeqSetting=!0;0<c?(this.seekWindowMs=c,this.bAutoSeekSetting=!1):this.bAutoSeekSetting=!0;this.calcSeqParameters();this.calculateOverlapLength(this.overlapMs);
this.tempo=this._tempo},set tempo(a){this._tempo=a;this.calcSeqParameters();this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength);this.skipFract=0;this.sampleReq=Math.max(Math.floor(this.nominalSkip+.5)+this.overlapLength,this.seekWindowLength)+this.seekLength},get inputChunkSize(){return this.sampleReq},get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)},calculateOverlapLength:function(a){a=this.sampleRate*a/1E3;16>a&&(a=16);this.overlapLength=
a-a%8;this.pRefMidBuffer=new Float32Array(2*this.overlapLength);this.pMidBuffer=new Float32Array(2*this.overlapLength)},checkLimits:function(a,b,c){return a<b?b:a>c?c:a},calcSeqParameters:function(){var a;this.bAutoSeqSetting&&(a=AUTOSEQ_C+AUTOSEQ_K*this._tempo,a=this.checkLimits(a,AUTOSEQ_AT_MAX,AUTOSEQ_AT_MIN),this.sequenceMs=Math.floor(a+.5));this.bAutoSeekSetting&&(a=AUTOSEEK_C+AUTOSEEK_K*this._tempo,a=this.checkLimits(a,AUTOSEEK_AT_MAX,AUTOSEEK_AT_MIN),this.seekWindowMs=Math.floor(a+.5));this.seekWindowLength=
Math.floor(this.sampleRate*this.sequenceMs/1E3);this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1E3)},set quickSeek(a){this.bQuickSeek=a},clone:function(){var a=new Stretch;a.tempo=this.tempo;a.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs);return a},seekBestOverlapPosition:function(){return this.bQuickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()},seekBestOverlapPositionStereo:function(){var a,b,c,d;this.precalcCorrReferenceStereo();
b=Number.MIN_VALUE;for(d=a=0;d<this.seekLength;d++)c=this.calcCrossCorrStereo(2*d,this.pRefMidBuffer),c>b&&(b=c,a=d);return a},seekBestOverlapPositionStereoQuick:function(){var a,b,c,d,e,g,f;this.precalcCorrReferenceStereo();c=Number.MIN_VALUE;for(e=g=b=0;4>e;e++){for(a=0;_SCAN_OFFSETS[e][a];){f=g+_SCAN_OFFSETS[e][a];if(f>=this.seekLength)break;d=this.calcCrossCorrStereo(2*f,this.pRefMidBuffer);d>c&&(c=d,b=f);a++}g=b}return b},precalcCorrReferenceStereo:function(){var a,b,c;for(a=0;a<this.overlapLength;a++)c=
a*(this.overlapLength-a),b=2*a,this.pRefMidBuffer[b]=this.pMidBuffer[b]*c,this.pRefMidBuffer[b+1]=this.pMidBuffer[b+1]*c},calcCrossCorrStereo:function(a,b){var c=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var d,e,g;d=0;for(e=2;e<2*this.overlapLength;e+=2)g=e+a,d+=c[g]*b[e]+c[g+1]*b[e+1];return d},overlap:function(a){this.overlapStereo(2*a)},overlapStereo:function(a){var b=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var c=this._outputBuffer.vector,d=this._outputBuffer.endIndex,
e,g,f,k,l,m,p;k=1/this.overlapLength;for(e=0;e<this.overlapLength;e++)f=(this.overlapLength-e)*k,l=e*k,g=2*e,m=g+a,p=g+d,c[p+0]=b[m+0]*l+this.pMidBuffer[g+0]*f,c[p+1]=b[m+1]*l+this.pMidBuffer[g+1]*f},process:function(){var a,b;if(null==this.pMidBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.pMidBuffer=new Float32Array(2*this.overlapLength);this._inputBuffer.receiveSamples(this.pMidBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;)a=this.seekBestOverlapPosition(),
this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(a)),this._outputBuffer.put(this.overlapLength),b=this.seekWindowLength-2*this.overlapLength,0<b&&this._outputBuffer.putBuffer(this._inputBuffer,a+this.overlapLength,b),a=this.inputBuffer.startIndex+2*(a+this.seekWindowLength-this.overlapLength),this.pMidBuffer.set(this._inputBuffer.vector.subarray(a,a+2*this.overlapLength)),this.skipFract+=this.nominalSkip,a=Math.floor(this.skipFract),this.skipFract-=a,this._inputBuffer.receive(a)}});
extend(Stretch.prototype,{get tempo(){return this._tempo}});
