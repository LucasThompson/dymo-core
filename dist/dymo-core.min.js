var $jscomp={scope:{},getGlobal:function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a}};$jscomp.global=$jscomp.getGlobal(this);$jscomp.initSymbol=function(){$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol);$jscomp.initSymbol=function(){}};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return"jscomp_symbol_"+a+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();$jscomp.global.Symbol.iterator||($jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));$jscomp.initSymbolIterator=function(){}};
$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();if(a[$jscomp.global.Symbol.iterator])return a[$jscomp.global.Symbol.iterator]();if(!(a instanceof Array||"string"==typeof a||a instanceof String))throw new TypeError(a+" is not iterable");var b=0;return{next:function(){return b==a.length?{done:!0}:{done:!1,value:a[b++]}}}};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.arrayFromArguments=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b};$jscomp.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.prototype=new c;a.prototype.constructor=a;for(var d in b)if($jscomp.global.Object.defineProperties){var e=$jscomp.global.Object.getOwnPropertyDescriptor(b,d);$jscomp.global.Object.defineProperty(a,d,e)}else a[d]=b[d]};
$jscomp.array=$jscomp.array||{};$jscomp.array.done_=function(){return{done:!0,value:void 0}};$jscomp.array.arrayIterator_=function(a,b){a instanceof String&&(a=String(a));var c=0;$jscomp.initSymbol();$jscomp.initSymbolIterator();var d={},e=(d.next=function(){if(c<a.length){var d=c++;return{value:b(d,a[d]),done:!1}}e.next=$jscomp.array.done_;return $jscomp.array.done_()},d[Symbol.iterator]=function(){return e},d);return e};
$jscomp.array.findInternal_=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};
$jscomp.array.from=function(a,b,c){b=void 0===b?function(a){return a}:b;var d=[];$jscomp.initSymbol();$jscomp.initSymbolIterator();if(a[Symbol.iterator]){$jscomp.initSymbol();$jscomp.initSymbolIterator();a=a[Symbol.iterator]();for(var e;!(e=a.next()).done;)d.push(b.call(c,e.value))}else{e=a.length;for(var f=0;f<e;f++)d.push(b.call(c,a[f]))}return d};$jscomp.array.of=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c-0]=arguments[c];return $jscomp.array.from(b)};
$jscomp.array.entries=function(){return $jscomp.array.arrayIterator_(this,function(a,b){return[a,b]})};$jscomp.array.entries$install=function(){Array.prototype.entries||(Array.prototype.entries=$jscomp.array.entries)};$jscomp.array.keys=function(){return $jscomp.array.arrayIterator_(this,function(a){return a})};$jscomp.array.keys$install=function(){Array.prototype.keys||(Array.prototype.keys=$jscomp.array.keys)};$jscomp.array.values=function(){return $jscomp.array.arrayIterator_(this,function(a,b){return b})};
$jscomp.array.values$install=function(){Array.prototype.values||(Array.prototype.values=$jscomp.array.values)};$jscomp.array.copyWithin=function(a,b,c){var d=this.length;a=Number(a);b=Number(b);c=Number(null!=c?c:d);if(a<b)for(c=Math.min(c,d);b<c;)b in this?this[a++]=this[b++]:(delete this[a++],b++);else for(c=Math.min(c,d+b-a),a+=c-b;c>b;)--c in this?this[--a]=this[c]:delete this[a];return this};$jscomp.array.copyWithin$install=function(){Array.prototype.copyWithin||(Array.prototype.copyWithin=$jscomp.array.copyWithin)};
$jscomp.array.fill=function(a,b,c){null!=c&&a.length||(c=this.length||0);c=Number(c);for(b=Number((void 0===b?0:b)||0);b<c;b++)this[b]=a;return this};$jscomp.array.fill$install=function(){Array.prototype.fill||(Array.prototype.fill=$jscomp.array.fill)};$jscomp.array.find=function(a,b){return $jscomp.array.findInternal_(this,a,b).v};$jscomp.array.find$install=function(){Array.prototype.find||(Array.prototype.find=$jscomp.array.find)};
$jscomp.array.findIndex=function(a,b){return $jscomp.array.findInternal_(this,a,b).i};$jscomp.array.findIndex$install=function(){Array.prototype.findIndex||(Array.prototype.findIndex=$jscomp.array.findIndex)};$jscomp.Map=function(a){a=void 0===a?[]:a;this.data_={};this.head_=$jscomp.Map.createHead_();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next())b=b.value,this.set(b[0],b[1])}};
$jscomp.Map.checkBrowserConformance_=function(){var a=$jscomp.global.Map;if(!a||!a.prototype.entries||!Object.seal)return!1;try{var b=Object.seal({x:4}),c=new a($jscomp.makeIterator([[b,"s"]]));if("s"!=c.get(b)||1!=c.size||c.get({x:4})||c.set({x:4},"t")!=c||2!=c.size)return!1;var d=c.entries(),e=d.next();if(e.done||e.value[0]!=b||"s"!=e.value[1])return!1;e=d.next();return e.done||4!=e.value[0].x||"t"!=e.value[1]||!d.next().done?!1:!0}catch(f){return!1}};
$jscomp.Map.createHead_=function(){var a={};return a.previous=a.next=a.head=a};$jscomp.Map.getId_=function(a){if(!(a instanceof Object))return String(a);$jscomp.Map.key_ in a||a instanceof Object&&Object.isExtensible&&Object.isExtensible(a)&&$jscomp.Map.defineProperty_(a,$jscomp.Map.key_,++$jscomp.Map.index_);return $jscomp.Map.key_ in a?a[$jscomp.Map.key_]:" "+a};
$jscomp.Map.prototype.set=function(a,b){var c=this.maybeGetEntry_(a),d=c.id,e=c.list,c=c.entry;e||(e=this.data_[d]=[]);c?c.value=b:(c={next:this.head_,previous:this.head_.previous,head:this.head_,key:a,value:b},e.push(c),this.head_.previous.next=c,this.head_.previous=c,this.size++);return this};
$jscomp.Map.prototype["delete"]=function(a){var b=this.maybeGetEntry_(a);a=b.id;var c=b.list,d=b.index;return(b=b.entry)&&c?(c.splice(d,1),c.length||delete this.data_[a],b.previous.next=b.next,b.next.previous=b.previous,b.head=null,this.size--,!0):!1};$jscomp.Map.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=$jscomp.Map.createHead_();this.size=0};$jscomp.Map.prototype.has=function(a){return!!this.maybeGetEntry_(a).entry};
$jscomp.Map.prototype.get=function(a){return(a=this.maybeGetEntry_(a).entry)&&a.value};$jscomp.Map.prototype.maybeGetEntry_=function(a){var b=$jscomp.Map.getId_(a),c=this.data_[b];if(c)for(var d=0;d<c.length;d++){var e=c[d];if(a!==a&&e.key!==e.key||a===e.key)return{id:b,list:c,index:d,entry:e}}return{id:b,list:c,index:-1,entry:void 0}};$jscomp.Map.prototype.entries=function(){return this.iter_(function(a){return[a.key,a.value]})};$jscomp.Map.prototype.keys=function(){return this.iter_(function(a){return a.key})};
$jscomp.Map.prototype.values=function(){return this.iter_(function(a){return a.value})};$jscomp.Map.prototype.forEach=function(a,b){for(var c=$jscomp.makeIterator(this.entries()),d=c.next();!d.done;d=c.next())d=d.value,a.call(b,d[1],d[0],this)};
$jscomp.Map.prototype.iter_=function(a){var b=this,c=this.head_;$jscomp.initSymbol();$jscomp.initSymbolIterator();var d={};return d.next=function(){if(c){for(;c.head!=b.head_;)c=c.previous;for(;c.next!=c.head;)return c=c.next,{done:!1,value:a(c)};c=null}return{done:!0,value:void 0}},d[Symbol.iterator]=function(){return this},d};$jscomp.Map.index_=0;$jscomp.Map.defineProperty_=Object.defineProperty?function(a,b,c){Object.defineProperty(a,b,{value:String(c)})}:function(a,b,c){a[b]=String(c)};
$jscomp.Map.Entry_=function(){};$jscomp.Map.ASSUME_NO_NATIVE=!1;$jscomp.Map$install=function(){$jscomp.initSymbol();$jscomp.initSymbolIterator();!$jscomp.Map.ASSUME_NO_NATIVE&&$jscomp.Map.checkBrowserConformance_()?$jscomp.Map=$jscomp.global.Map:($jscomp.initSymbol(),$jscomp.initSymbolIterator(),$jscomp.Map.prototype[Symbol.iterator]=$jscomp.Map.prototype.entries,$jscomp.initSymbol(),$jscomp.Map.key_=Symbol("map-id-key"));$jscomp.Map$install=function(){}};$jscomp.math=$jscomp.math||{};
$jscomp.math.clz32=function(a){a=Number(a)>>>0;if(0===a)return 32;var b=0;0===(a&4294901760)&&(a<<=16,b+=16);0===(a&4278190080)&&(a<<=8,b+=8);0===(a&4026531840)&&(a<<=4,b+=4);0===(a&3221225472)&&(a<<=2,b+=2);0===(a&2147483648)&&b++;return b};$jscomp.math.imul=function(a,b){a=Number(a);b=Number(b);var c=a&65535,d=b&65535;return c*d+((a>>>16&65535)*d+c*(b>>>16&65535)<<16>>>0)|0};$jscomp.math.sign=function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1};
$jscomp.math.log10=function(a){return Math.log(a)/Math.LN10};$jscomp.math.log2=function(a){return Math.log(a)/Math.LN2};$jscomp.math.log1p=function(a){a=Number(a);if(.25>a&&-.25<a){for(var b=a,c=1,d=a,e=0,f=1;e!=d;)b*=a,f*=-1,d=(e=d)+f*b/++c;return d}return Math.log(1+a)};$jscomp.math.expm1=function(a){a=Number(a);if(.25>a&&-.25<a){for(var b=a,c=1,d=a,e=0;e!=d;)b*=a/++c,d=(e=d)+b;return d}return Math.exp(a)-1};$jscomp.math.cosh=function(a){a=Number(a);return(Math.exp(a)+Math.exp(-a))/2};
$jscomp.math.sinh=function(a){a=Number(a);return 0===a?a:(Math.exp(a)-Math.exp(-a))/2};$jscomp.math.tanh=function(a){a=Number(a);if(0===a)return a;var b=Math.exp(2*-Math.abs(a)),b=(1-b)/(1+b);return 0>a?-b:b};$jscomp.math.acosh=function(a){a=Number(a);return Math.log(a+Math.sqrt(a*a-1))};$jscomp.math.asinh=function(a){a=Number(a);if(0===a)return a;var b=Math.log(Math.abs(a)+Math.sqrt(a*a+1));return 0>a?-b:b};
$jscomp.math.atanh=function(a){a=Number(a);return($jscomp.math.log1p(a)-$jscomp.math.log1p(-a))/2};
$jscomp.math.hypot=function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];a=Number(a);b=Number(b);for(var f=Math.max(Math.abs(a),Math.abs(b)),g=$jscomp.makeIterator(d),e=g.next();!e.done;e=g.next())f=Math.max(f,Math.abs(e.value));if(1E100<f||1E-100>f){a/=f;b/=f;g=a*a+b*b;d=$jscomp.makeIterator(d);for(e=d.next();!e.done;e=d.next())e=e.value,e=Number(e)/f,g+=e*e;return Math.sqrt(g)*f}f=a*a+b*b;d=$jscomp.makeIterator(d);for(e=d.next();!e.done;e=d.next())e=e.value,f+=e*e;return Math.sqrt(f)};
$jscomp.math.trunc=function(a){a=Number(a);if(isNaN(a)||Infinity===a||-Infinity===a||0===a)return a;var b=Math.floor(Math.abs(a));return 0>a?-b:b};$jscomp.math.cbrt=function(a){if(0===a)return a;a=Number(a);var b=Math.pow(Math.abs(a),1/3);return 0>a?-b:b};$jscomp.number=$jscomp.number||{};$jscomp.number.isFinite=function(a){return"number"!==typeof a?!1:!isNaN(a)&&Infinity!==a&&-Infinity!==a};$jscomp.number.isInteger=function(a){return $jscomp.number.isFinite(a)?a===Math.floor(a):!1};
$jscomp.number.isNaN=function(a){return"number"===typeof a&&isNaN(a)};$jscomp.number.isSafeInteger=function(a){return $jscomp.number.isInteger(a)&&Math.abs(a)<=$jscomp.number.MAX_SAFE_INTEGER};$jscomp.number.EPSILON=Math.pow(2,-52);$jscomp.number.MAX_SAFE_INTEGER=9007199254740991;$jscomp.number.MIN_SAFE_INTEGER=-9007199254740991;$jscomp.object=$jscomp.object||{};
$jscomp.object.assign=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c[d-1]=arguments[d];c=$jscomp.makeIterator(c);for(d=c.next();!d.done;d=c.next()){var d=d.value,e;for(e in d)Object.prototype.hasOwnProperty.call(d,e)&&(a[e]=d[e])}return a};$jscomp.object.is=function(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b};$jscomp.Set=function(a){a=void 0===a?[]:a;this.map_=new $jscomp.Map;if(a){a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next())this.add(b.value)}this.size=this.map_.size};
$jscomp.Set.checkBrowserConformance_=function(){var a=$jscomp.global.Set;if(!a||!a.prototype.entries||!Object.seal)return!1;var b=Object.seal({x:4}),a=new a($jscomp.makeIterator([b]));if(a.has(b)||1!=a.size||a.add(b)!=a||1!=a.size||a.add({x:4})!=a||2!=a.size)return!1;var a=a.entries(),c=a.next();if(c.done||c.value[0]!=b||c.value[1]!=b)return!1;c=a.next();return c.done||c.value[0]==b||4!=c.value[0].x||c.value[1]!=c.value[0]?!1:a.next().done};
$jscomp.Set.prototype.add=function(a){this.map_.set(a,a);this.size=this.map_.size;return this};$jscomp.Set.prototype["delete"]=function(a){a=this.map_["delete"](a);this.size=this.map_.size;return a};$jscomp.Set.prototype.clear=function(){this.map_.clear();this.size=0};$jscomp.Set.prototype.has=function(a){return this.map_.has(a)};$jscomp.Set.prototype.entries=function(){return this.map_.entries()};$jscomp.Set.prototype.values=function(){return this.map_.values()};
$jscomp.Set.prototype.forEach=function(a,b){var c=this;this.map_.forEach(function(d){return a.call(b,d,d,c)})};$jscomp.Set.ASSUME_NO_NATIVE=!1;$jscomp.Set$install=function(){!$jscomp.Set.ASSUME_NO_NATIVE&&$jscomp.Set.checkBrowserConformance_()?$jscomp.Set=$jscomp.global.Set:($jscomp.Map$install(),$jscomp.initSymbol(),$jscomp.initSymbolIterator(),$jscomp.Set.prototype[Symbol.iterator]=$jscomp.Set.prototype.values);$jscomp.Set$install=function(){}};$jscomp.string=$jscomp.string||{};
$jscomp.string.noRegExp_=function(a,b){if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");};
$jscomp.string.fromCodePoint=function(a){for(var b=[],c=0;c<arguments.length;++c)b[c-0]=arguments[c];for(var c="",b=$jscomp.makeIterator(b),d=b.next();!d.done;d=b.next()){d=d.value;d=+d;if(0>d||1114111<d||d!==Math.floor(d))throw new RangeError("invalid_code_point "+d);65535>=d?c+=String.fromCharCode(d):(d-=65536,c+=String.fromCharCode(d>>>10&1023|55296),c+=String.fromCharCode(d&1023|56320))}return c};
$jscomp.string.repeat=function(a){var b=this.toString();if(0>a||1342177279<a)throw new RangeError("Invalid count value");a|=0;for(var c="";a;)if(a&1&&(c+=b),a>>>=1)b+=b;return c};$jscomp.string.repeat$install=function(){String.prototype.repeat||(String.prototype.repeat=$jscomp.string.repeat)};
$jscomp.string.codePointAt=function(a){var b=this.toString(),c=b.length;a=Number(a)||0;if(0<=a&&a<c){a|=0;var d=b.charCodeAt(a);if(55296>d||56319<d||a+1===c)return d;a=b.charCodeAt(a+1);return 56320>a||57343<a?d:1024*(d-55296)+a+9216}};$jscomp.string.codePointAt$install=function(){String.prototype.codePointAt||(String.prototype.codePointAt=$jscomp.string.codePointAt)};
$jscomp.string.includes=function(a,b){b=void 0===b?0:b;$jscomp.string.noRegExp_(a,"includes");return-1!==this.toString().indexOf(a,b)};$jscomp.string.includes$install=function(){String.prototype.includes||(String.prototype.includes=$jscomp.string.includes)};
$jscomp.string.startsWith=function(a,b){b=void 0===b?0:b;$jscomp.string.noRegExp_(a,"startsWith");var c=this.toString();a+="";for(var d=c.length,e=a.length,f=Math.max(0,Math.min(b|0,c.length)),g=0;g<e&&f<d;)if(c[f++]!=a[g++])return!1;return g>=e};$jscomp.string.startsWith$install=function(){String.prototype.startsWith||(String.prototype.startsWith=$jscomp.string.startsWith)};
$jscomp.string.endsWith=function(a,b){$jscomp.string.noRegExp_(a,"endsWith");var c=this.toString();a+="";void 0===b&&(b=c.length);for(var d=Math.max(0,Math.min(b|0,c.length)),e=a.length;0<e&&0<d;)if(c[--d]!=a[--e])return!1;return 0>=e};$jscomp.string.endsWith$install=function(){String.prototype.endsWith||(String.prototype.endsWith=$jscomp.string.endsWith)};
var SCHEDULE_AHEAD_TIME=.1,DYMO="Dymo",PARALLEL="parallel",SEQUENTIAL="sequential",DYMO_TYPES=[PARALLEL,SEQUENTIAL],FEATURE="Feature",PARAMETER="Parameter",ONE_SHOT_NAVIGATOR="OneShotNavigator",SEQUENTIAL_NAVIGATOR="SequentialNavigator",SIMILARITY_NAVIGATOR="SimilarityNavigator",PLAY="Play",LOOP="Loop",ONSET="Onset",DURATION_RATIO="DurationRatio",AMPLITUDE="Amplitude",PLAYBACK_RATE="PlaybackRate",TIME_STRETCH_RATIO="TimeStretchRatio",PAN="Pan",DISTANCE="Distance",HEIGHT="Height",REVERB="Reverb",DELAY=
"Delay",FILTER="Filter",PART_INDEX="PartIndex",PART_COUNT="PartCount",PART_ORDER="PartOrder",LISTENER_ORIENTATION="ListenerOrientation",AUTO_CONTROL_FREQUENCY="AutoControlFrequency",AUTO_CONTROL_TRIGGER="AutoControlTrigger",BROWNIAN_MAX_STEP_SIZE="BrownianMaxStepSize",LEAPING_PROBABILITY="LeapingProbability",CONTINUE_AFTER_LEAPING="ContinueAfterLeaping",PARAMETERS=[PLAY,LOOP,ONSET,DURATION_RATIO,AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,PAN,DISTANCE,HEIGHT,REVERB,DELAY,FILTER,PART_INDEX,PART_COUNT,
PART_ORDER,LISTENER_ORIENTATION,AUTO_CONTROL_FREQUENCY,AUTO_CONTROL_TRIGGER],LEVEL="level",INDEX="index",ONSET_FEATURE="onset",PITCH_FEATURE="pitch",DURATION_FEATURE="duration",AUTO_CONTROL="AutoControl",SLIDER="Slider",TOGGLE="Toggle",BUTTON="Button",CUSTOM="Custom",ACCELEROMETER_X="AccelerometerX",ACCELEROMETER_Y="AccelerometerY",ACCELEROMETER_Z="AccelerometerZ",TILT_X="TiltX",TILT_Y="TiltY",GEOLOCATION_LATITUDE="GeolocationLatitude",GEOLOCATION_LONGITUDE="GeolocationLongitude",GEOLOCATION_DISTANCE=
"GeolocationDistance",COMPASS_HEADING="CompassHeading",BEACON="Beacon",RANDOM="Random",BROWNIAN="Brownian",RAMP="Ramp",CONTROLS=[SLIDER,TOGGLE,BUTTON,CUSTOM,ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,COMPASS_HEADING,RANDOM,BROWNIAN,RAMP],UI_CONTROLS=[SLIDER,TOGGLE,BUTTON,CUSTOM],SENSOR_CONTROLS=[ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,
COMPASS_HEADING,BEACON];function DymoManager(a,b,c,d){var e=new Scheduler(a,function(){});c||(c="bower_components/dymo-core/audio/impulse_rev.wav");e.setReverbFile(c);isNaN(b)||(SCHEDULE_AHEAD_TIME=b);var f,g={},l={};this.loadDymoAndRendering=function(a,b,c){var m=new DymoLoader(e);m.loadDymoFromJson(a,function(a){m.loadRenderingFromJson(b,a[1],function(b){f=b[0];f.dymo=a[0];for(var p in b[1]){var h=b[1][p];0<=UI_CONTROLS.indexOf(h.getType())&&(g[p]=new UIControl(h,d));0<=SENSOR_CONTROLS.indexOf(h.getType())&&(l[p]=h)}e.loadBuffers(f.dymo);
c&&c()})})};this.loadDymoFromJson=function(a,b){(new DymoLoader(e)).loadDymoFromJson(a,function(a){b&&b(a[0])})};this.parseDymoFromJson=function(a,b){(new DymoLoader(e)).parseDymoFromJson(a,function(a){b(a[0])})};this.replacePartOfTopDymo=function(a,b){var c=f.dymo.getPart(a);f.dymo.replacePart(a,b);e.stop(c)};this.updateNavigatorPosition=function(a,b,c){e.updateNavigatorPosition(a,b,c)};this.getNavigatorPosition=function(a,b){return e.getNavigatorPosition(a,b)};this.syncNavigators=function(a,b,c){e.syncNavigators(a,
b,c)};this.startPlaying=function(){f.dymo.updatePartOrder(ONSET);e.play(f.dymo)};this.stopPlaying=function(){e.stop(f.dymo)};this.getTopDymo=function(){return f.dymo};this.getRendering=function(){return f};this.getUIControls=function(){return g};this.getUIControl=function(a){return g[a]};this.getSensorControls=function(){return l}};function AudioProcessor(a){function b(a){return{extract:function(b,e,f){for(var g=[],l=0;l<a.numberOfChannels;l++)g.push(a.getChannelData(l));for(l=0;l<e;l++)for(var h=0;h<g.length;h++)b[l*g.length+h%g.length]=g[h][l+f];return Math.min(e,g[0].length-f)}}}this.timeStretch=function(c,d){var e=new SoundTouch(c.sampleRate);e.tempo=d;for(var f=b(c),e=new SimpleFilter(f,e),f=a.createBuffer(c.numberOfChannels,1/d*c.length,c.sampleRate),g=[],l=0;l<c.numberOfChannels;l++)g.push(f.getChannelData(l));for(var h=
new Float32Array(2048),t=e.extract(h,1024),n=0;t;){for(l=0;l<t;l++)for(var m=0;m<g.length;m++)g[m][l+n]=h[l*g.length+m%g.length];n+=t;t=e.extract(h,1024)}return f}};function AudioProcessorSource(a,b,c){var d=this,e=new SoundTouch(b.sampleRate);this.stretchRatio={setValue:function(a){e.tempo=a},getValue:function(){return e.tempo}};this.playbackRate={setValue:function(a){e.rate=a},getValue:function(){return e.rate}};var f=new SimpleFilter({extract:function(a,c,d){for(var e=[],f=0;f<b.numberOfChannels;f++)e.push(b.getChannelData(f));for(f=0;f<c;f++)for(var q=0;q<e.length;q++)a[f*e.length+q%e.length]=e[q][f+d];return Math.min(c,e[0].length-d)}},e),g=a.createScriptProcessor(1024,
2,b.numberOfChannels),l=new Float32Array(2048);g.onaudioprocess=function(a){for(var c=[],e=0;e<b.numberOfChannels;e++)c.push(a.outputBuffer.getChannelData(e));a=f.extract(l,1024);0==a&&d.stop();for(e=0;e<a;e++)for(var g=0;g<c.length;g++)c[g][e]=l[e*c.length+g%c.length]};this.start=function(a){setTimeout(function(){g.connect(c)},a)};this.stop=function(){g.disconnect()}};function Scheduler(a,b,c){function d(){0<q&&q--;0==q&&b&&b(q)}function e(a){h.splice(h.indexOf(a),1)}function f(){for(var a=[],b=0;b<h.length;b++)for(var d=$jscomp.makeIterator(h[b].getSources().keys()),e=d.next();!e.done;e=d.next())for(e=e.value;null!=e;)0>a.indexOf(e.getUri())&&a.push(e.getUri()),e=e.getParent();a.sort();t=a;c&&c()}function g(b,c){q++;var e=new XMLHttpRequest;e.open("GET",b,!0);e.responseType="arraybuffer";e.onload=function(){a.decodeAudioData(e.response,function(a){c?c(a):(l[b]=
a,d())})};e.error=function(){};e.send()}var l={},h=[],t=[];this.listenerOrientation=new Parameter(LISTENER_ORIENTATION,0);this.listenerOrientation.addObserver(this);var n=a.createConvolver();n.connect(a.destination);var m=a.createDelay();m.delayTime.value=.5;m.connect(a.destination);var r=a.createGain();r.gain.value=.6;m.connect(r);r.connect(m);var q=0;this.setReverbFile=function(a){g(a,function(a){n.buffer=a;d()})};this.loadBuffers=function(a){a=a.getAllSourcePaths();for(var b=0,c=a.length;b<c;b++)l[a[b]]||
g(a[b])};this.getBuffer=function(a){return l[a.getSourcePath()]};this.getParameter=function(a){if(a==LISTENER_ORIENTATION)return this.listenerOrientation};this.updateNavigatorPosition=function(a,b,c){for(var d=0,e=h.length;d<e;d++)h[d].hasDymo(a)&&h[d].getNavigator().setPosition(c,b,a)};this.getNavigatorPosition=function(a,b){for(var c=0,d=h.length;c<d;c++)if(h[c].hasDymo(a))return h[c].getNavigator().getPosition(b,a)};this.syncNavigators=function(a,b,c){for(var d,e,k=0,f=h.length;k<f;k++)h[k].hasDymo(a)&&
(d=h[k].getNavigator()),h[k].hasDymo(b)&&(e=h[k].getNavigator());e&&(b=e.getPosition(c,b),d.setPosition(b+1,c,a))};this.play=function(b){b=new SchedulerThread(b,void 0,a,l,n,m,f,e);h.push(b)};this.pause=function(a){if(a)for(var b=0;b<h.length;b++)h[b].pause(a)};this.stop=function(a){if(a)for(var b=0;b<h.length;b++)h[b].stop(a)};this.getSources=function(a){for(var b=[],c=0;c<h.length;c++){var d=h[c].getSource(a);d&&b.push(d)}return b};this.getUrisOfPlayingDymos=function(){return t};this.observedParameterChanged=
function(b){b=this.listenerOrientation.getValue()/180*Math.PI;a.listener.setOrientation(Math.sin(b),0,-Math.cos(b),0,1,0)}};function Source(a,b,c,d,e,f){function g(a,c){var d=b.createGain();d.connect(c);d.gain.value=0;a.connect(d);return d}function l(){var d=a.getParameter(TIME_STRETCH_RATIO).getValue();if(1!=d){if(0!=A||x<c.duration)c=r(c,m(A,c),m(x+.3,c));c=(new AudioProcessor(b)).timeStretch(c,d);d=x/d;c=r(c,0,m(d+.02,c));x=d}else if(0!=A||x<c.duration)c=r(c,m(A,c),m(x+.02,c));q(c,c.length);z.buffer=c;k[PLAYBACK_RATE]=z.playbackRate;h(PLAYBACK_RATE,a.getParameter(PLAYBACK_RATE))}function h(a,b){t(a,b.getValue());b.addObserver(u)}
function t(a,b,c){c&&(b+=u.getParameterValue(a));0>b&&0<=G.indexOf(a)&&(b=0);c=b;k[a]&&(k[a].value||0==k[a].value?k[a].value=c:k[a].setValue(c));0<=H.indexOf(a)?(0==k[DISTANCE].value&&(k[DISTANCE].value=-.01),D.setPosition(k[PAN].value,k[HEIGHT].value,k[DISTANCE].value)):a==LOOP&&(z.loop=1==b)}function n(){v=!1;var a=b.currentTime;k[AMPLITUDE].setValueAtTime(k[AMPLITUDE].value,a);k[AMPLITUDE].linearRampToValueAtTime(0,a+.02);z.stop(a+.04)}function m(a,b){if(a||0==a)return Math.round(a*b.sampleRate)}
function r(a,c,d){d=Math.min(a.length-c,d);for(var e=b.createBuffer(a.numberOfChannels,d,a.sampleRate),k=0;k<a.numberOfChannels;k++)for(var f=e.getChannelData(k),q=a.getChannelData(k),B=0;B<d;B++)f[B]=q[c+B];return e}function q(a,b){for(var c=.02*a.sampleRate,d=0;d<a.numberOfChannels;d++)for(var e=a.getChannelData(d),k=0;k<c;k++)e[k]*=k/c,e[b-k-1]*=k/c}function p(a,b,c,d){var e=a.lastIndexOf("/");e&&(a=a.substring(e+1));y("http://localhost:8060/getAudioChunk?filename="+a+"&fromSecond="+b+"&toSecond="+
c,function(a){d(a)})}function y(a,c){var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onload=function(){b.decodeAudioData(d.response,function(a){c(a)},function(a){console.log("audio from server is faulty")})};d.send()}var u=this,v,w,k={},B=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,DELAY,FILTER,PAN,HEIGHT,DISTANCE,LOOP],G=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,DELAY,FILTER],H=[PAN,HEIGHT,DISTANCE],z=b.createBufferSource(),C=b.createGain();C.connect(b.destination);
var E=g(C,d);d=g(C,e);var D=b.createPanner();D.connect(C);e=b.createBiquadFilter();e.type="lowpass";e.frequency.value=2E4;e.connect(D);z.connect(e);var F=a.getSegment(),A=F[0],x=F[1];A||(A=0);!x&&c&&(x=c.duration-A);c?l():p(a.getSourcePath(),A,A+x+.3,function(d){c=d;d=a.getParameter(TIME_STRETCH_RATIO).getValue();1!=d?(c=(new AudioProcessor(b)).timeStretch(c,d),d=x/d,c=r(c,0,m(d+.02,c)),x=d):c=r(c,0,m(x+.02,c));q(c,c.length);z.buffer=c});k[AMPLITUDE]=C.gain;k[TIME_STRETCH_RATIO]={value:0};k[REVERB]=
E.gain;k[DELAY]=d.gain;k[FILTER]=e.frequency;k[PAN]={value:0};k[HEIGHT]={value:0};k[DISTANCE]={value:0};k[LOOP]={value:0};h(AMPLITUDE,a.getParameter(AMPLITUDE));h(TIME_STRETCH_RATIO,a.getParameter(TIME_STRETCH_RATIO));h(REVERB,a.getParameter(REVERB));h(DELAY,a.getParameter(DELAY));h(FILTER,a.getParameter(FILTER));h(PAN,a.getParameter(PAN));h(HEIGHT,a.getParameter(HEIGHT));h(DISTANCE,a.getParameter(DISTANCE));h(LOOP,a.getParameter(LOOP));this.observedParameterChanged=function(a){t(a.getName(),a.getChange(),
!0)};this.getDymo=function(){return a};this.getDuration=function(){return x};this.isLoopingAndPlaying=function(){return z.loop&&v};this.getParameterValue=function(a){if(k[a])return k[a].value||0==k[a].value?k[a].value:k[a].getValue()};this.play=function(b){z.onended=function(){for(var b=0;b<B.length;b++){var c=a.getParameter(B[b]);c&&c.removeObserver(u)}z.disconnect();C.disconnect();E.disconnect();f&&f(u)};b||(b=0);z.start(b);v=!0};this.pause=function(){v?(n(),w=!0):w&&(w=!1,this.play())};this.stop=
function(){v&&n()}};function SchedulerThread(a,b,c,d,e,f,g,l){function h(){u=w?w:q();n(u);k||(k=u[0].getDymo().getParameter(ONSET).getValue());var a;a=v?v-c.currentTime:SCHEDULE_AHEAD_TIME;for(var b=c.currentTime+a,d=0;d<u.length;d++)u[d].play(b);setTimeout(function(){g()},a);(w=q())?(v=r(b),a=1E3*(v-c.currentTime-SCHEDULE_AHEAD_TIME),y=setTimeout(function(){h()},a)):(v=r(b),a=1E3*(v-c.currentTime),setTimeout(function(){t()},a+100))}function t(){0==p.size&&(window.clearTimeout(y),b.reset(),l&&l())}function n(a){for(var b=
0;b<a.length;b++)p.set(a[b].getDymo(),a[b])}function m(a){p.delete(a.getDymo());g();t()}function r(a){if(w){var b=w[0].getDymo().getParameter(ONSET).getValue(),c=b-k;k=b;if(!isNaN(b))return a+c}b=u[0];c=b.getDymo().getParameter(PLAYBACK_RATE).getValue();b=b.getDuration()/c;return a+b}function q(){var a=b.getNextParts();if(a){console.log(a.map(function(a){return a.getIndex()}));for(var k=[],q=0;q<a.length;q++)if(a[q].getSourcePath()){var p=d[a[q].getSourcePath()];k.push(new Source(a[q],c,p,e,f,m))}return k}}
var p=new Map,y,u=[],v,w,k;b||(b=new DymoNavigator(a,new SequentialNavigator(a)));h();this.hasDymo=function(b){if(a.getAllDymosInHierarchy().indexOf(b))return!0};this.getNavigator=function(){return b};this.pause=function(a){a=a.getAllDymosInHierarchy();for(var b=0,c=a.length;b<c;b++){var d=p.get(a[b]);d&&d.pause()}};this.stop=function(a){a=a.getAllDymosInHierarchy();for(var b=0,c=a.length;b<c;b++){var d=p.get(a[b]);d&&d.stop()}};this.getSources=function(){return p};this.getSource=function(a){return p.get(a)}}
;function AutoControl(a,b,c){function d(a){var b=a.getName();f[b]=a;f[b].addObserver(e)}var e=this,f={};d(new Parameter(AUTO_CONTROL_FREQUENCY,100));d(new Parameter(AUTO_CONTROL_TRIGGER,0));Control.call(this,a,AUTO_CONTROL,f);var g;this.addParameter=d;this.getParameter=function(a){return f[a]};this.startUpdate=function(){g=setInterval(b,f[AUTO_CONTROL_FREQUENCY].getValue())};this.reset=function(){clearInterval(g);g=null;c&&c()};this.observedParameterChanged=function(a){a==f[AUTO_CONTROL_FREQUENCY]?
g&&(this.reset(),this.startUpdate()):a==f[AUTO_CONTROL_TRIGGER]&&(g?this.reset():this.startUpdate())}}inheritPrototype(AutoControl,Control);function BrownianControl(a){var b=this;a||(a=.5);AutoControl.call(this,BROWNIAN,function(){var a=b.getParameter(BROWNIAN_MAX_STEP_SIZE).getValue(),a=2*a*Math.random()-a,a=b.getValue()+a,a=Math.min(Math.max(a,0),1);b.update(a)});this.addParameter(new Parameter(BROWNIAN_MAX_STEP_SIZE,.1));this.update(a);this.startUpdate()}inheritPrototype(BrownianControl,AutoControl);function RampControl(a,b){var c=this;a||(a=1E4);var d=0;b&&(d=b);var e=1!=d;AutoControl.call(this,RAMP,function(){var b=1/a*c.getParameter(AUTO_CONTROL_FREQUENCY).getValue();e||(b*=-1);d+=b;0<d&&1>d?c.update(d):1<=d?(c.update(1),c.reset()):0>=d&&(c.update(0),c.reset())},function(){e=!e});this.update(d)}inheritPrototype(RampControl,AutoControl);function RandomControl(){var a=this;AutoControl.call(this,RANDOM,function(){a.update(Math.random())});this.startUpdate()}inheritPrototype(RandomControl,AutoControl);function UIControl(a,b){var c=this;this.value=a.getValue();a.setUpdateFunction(function(a){c.value=a;b&&setTimeout(function(){b.$apply()},10)});this.getName=function(){return a.getName()};this.getType=function(){return a.getType()};this.update=function(){a.getType()==BUTTON&&(isNaN(this.value)&&(this.value=0),this.value=1-this.value);1==this.value?a.update(1):0==this.value?a.update(0):a.update(this.value)}};function OntologyLoader2(a,b,c){};function DymoLoader(a){function b(a,d,e,f,h){var g=new XMLHttpRequest;g.open("GET",a,!0);g.onload=function(){if(0>this.responseText.indexOf("Cannot GET")){var k;a:{try{JSON.parse(this.responseText)}catch(g){k=!1;break a}k=!0}k&&(d?(0<=a.indexOf(r)&&(a=a.replace(r,"")),d=d.replace('"'+a+'"',this.responseText)):d=this.responseText);(k=c(d))?(0>k.indexOf(r)&&(k=r+k),b(k,d,e,f,h)):d&&(k=h(JSON.parse(d),e),f(k))}};g.error=function(a){console.log(a)};g.send()}function c(a){var b=a.indexOf(".json");if(0<=
b){if(b!=a.indexOf("context.json")+7){var d=a.substring(0,b).lastIndexOf('"');return a.substring(d+1,b+5)}return c(a.substring(b+1))}}function d(a,b){var c=e(a,b);f(a,b);return[c,b]}function e(b,c){var d=new DynamicMusicObject(b["@id"],b.cdt,a);d.setBasePath(r);c[b["@id"]]=d;b.source&&d.setSourcePath(b.source);if(b.features)for(var f=0;f<b.features.length;f++)d.setFeature(b.features[f]["@id"],b.features[f].value);if(b.presets)for(f=0;f<b.presets.length;f++)t(d,b.presets[f].parameter,b.presets[f].value);
if(b.parts)for(f=0;f<b.parts.length;f++)d.addPart(e(b.parts[f],c));return d}function f(a,b){var c=b[a["@id"]];if(a.similars)for(var d=0;d<a.similars.length;d++)c.addSimilar(b[a.similars[d]]);if(a.mappings)for(d=0;d<a.mappings.length;d++)c.addMapping(l(a.mappings[d],b,c));if(a.parts)for(d=0;d<a.parts.length;d++)f(a.parts[d],b)}function g(a,b){for(var c=new Rendering(b[a.dymo]),d={},e=0;e<a.mappings.length;e++)c.addMapping(l(a.mappings[e],b,void 0,d));a.navigator&&(e=Function.apply(null,a.navigator.dymos.args.concat(a.navigator.dymos.body)),
c.addNavigator(a.navigator["@type"]==SIMILARITY_NAVIGATOR?new SimilarityNavigator(void 0):new SequentialNavigator(void 0),e));return[c,d]}function l(b,c,d,e){if(b.controls){for(var f=[],g=0;g<b.controls.length;g++)f.push(e[b.controls[g]]);return h(b,c,d,f,e)}if(b.dymos){var f=[],k;if(b.dymos instanceof Array)for(g=0;g<b.dymos.length;g++)f.push(c[b.dymos[g]]);else k=Function.apply(null,b.dymos.args.concat(b.dymos.body)),g=Object.keys(c).map(function(a){return c[a]}),Array.prototype.push.apply(f,g.filter(k));
return h(b,c,d,f,e,k)}return h(b,c,d,[a],e)}function h(a,b,c,d,e,f){b=a.relative;for(var k=[],g=0;g<a.domainDims.length;g++){var h=a.domainDims[g],l=h.name,r=h["@type"];r==FEATURE?k.push(l):r==PARAMETER?(h=c?t(c,l,0):new Parameter(l,0),k.push(h)):(r=e&&e[l]?e[l]:m(h),"value"in h&&r.update(h.value),e&&!e[l]&&(e[l]=r),k.push(r))}return new Mapping(k,b,a["function"],d,a.range,f)}function t(a,b,c){var d=a.getParameter(b);d?d.update(c):(d=new Parameter(b,c),a.addParameter(d));return d}function n(a,b){for(var c=
0;c<a.length;c++)if(a[c])for(var d=0;d<a[c].length;d++){var e=b["dymo"+c],f=b["dymo"+a[c][d]];e&&f&&e.addSimilar(f)}}function m(a){var b=a["@type"],c=a.name;if(b==ACCELEROMETER_X||b==ACCELEROMETER_Y||b==ACCELEROMETER_Z)return new AccelerometerControl(b);if(b==TILT_X||b==TILT_Y)return new TiltControl(b);if(b==GEOLOCATION_LATITUDE||b==GEOLOCATION_LONGITUDE)return new GeolocationControl(b);if(b==GEOLOCATION_DISTANCE)return new DistanceControl;if(b==COMPASS_HEADING)return new CompassControl;if(b==BEACON)return b=
a.uuid,c=parseInt(a.major,10),a=parseInt(a.minor,10),new BeaconControl(b,c,a);if(b==SLIDER||b==TOGGLE||b==BUTTON||b==CUSTOM)return new Control(c,b);if(b==RANDOM)return new RandomControl;if(b==BROWNIAN)return new BrownianControl(parseFloat(a.value));if(b==RAMP)return b=Math.round(1E3*parseFloat(a.duration)),new RampControl(b,parseFloat(a.value))}var r="";this.loadDymoFromJson=function(a,c){var e=a.lastIndexOf("/")+1;r=a.substring(0,e);b(a,"",{},c,d)};this.parseDymoFromJson=function(a,b){b(d(a,{}))};
this.loadRenderingFromJson=function(a,c,d){b(a,"",c,d,g)};this.loadGraphFromJson=function(a,c,d){b(a,"",c,d,n)}};function DymoWriter(a){function b(a){a.addTriple("_:","http://www.w3.org/1999/02/22-rdf-syntax-ns#type","dmo:DMO");a.addTriple("_:","ch:hasPart","ch:test2")}function c(a,b){var c=new XMLHttpRequest;c.send(b);c.addEventListener("save",function(){console.log("saved "+a)});c.addEventListener("error",function(){console.log("saving "+a+" failed")});c.open("POST",a);c.send()}this.writeDymoToJson=function(a,b,f){a["@context"]="http://purl.org/ontology/dymo/context.json";f||(f="dymo.json");c(b+f,a)};this.writeRenderingToJson=
function(a,b){c(b+"rendering.json",a)};this.writeDmoToRdf=function(a){a=N3.Writer({prefixes:{ch:"rdf/charm.n3#",dmo:"rdf/dmo.n3#",mb:"rdf/mobile.n3#"}});b(a);a.end(function(a,b){console.log(b)})}};function Control(a,b,c){function d(a,b){if(void 0==f||1E-6<Math.abs(a-f))f=a,e(b)}function e(a){for(var b=0;b<h.length;b++)h[b]!=a&&h[b].updateParameter(f,this)}var f,g,l,h=[],t,n,m;this.getName=function(){return a};this.getParameter=function(a){if(c)return c[a]};this.getValue=function(){return f};this.getType=function(){return b};this.getReferenceValue=function(){return g};this.setReferenceAverageCount=function(a){l=a;this.resetReferenceValue()};this.resetReferenceValue=function(){g=f=void 0;n=t=
0};this.setUpdateFunction=function(a){m=a};this.addMapping=function(a){h.push(a);a.updateParameter(f,this)};this.removeMapping=function(a){a=h.indexOf(a);-1<a&&h.splice(a,1)};this.backpropagate=function(a,b){isFinite(a)&&(d(a,b),m&&m(f))};this.update=function(a){l&&t<l?(n+=a,t++,t==l&&(g=n/=l)):isNaN(a)||(g&&(a-=g),d(a))}};function DynamicMusicObject(a,b,c){function d(a,b){b[a.getUri()]=a;for(var c=0;c<a.getParts().length;c++)d(a.getParts()[c],b)}function e(a,b,c,d){var f=a-b,h=d.getParts();if(d.getLevel()==c&&0==f)return d;if(d.getLevel()>=c-1)return f<h.length?h[f]:b+h.length;for(d=0;d<h.length;d++)if(b=e(a,b,c,h[d]),isNaN(b))return b}function f(a,b,c){c(a,b);a=a.getParts();for(var d=0,e=a.length;d<e;d++)f(a[d],b,c)}function g(a,b,c){var d=b.toFlatJson();a.nodes.push(d);c&&a.links.push(h(c,d));for(c=0;c<b.getParts().length;c++)g(a,
b.getParts()[c],d)}function l(a,b,c){c||(c={});c[b.getUri()]||(c[b.getUri()]=b.toFlatJson());var d=c[b.getUri()];a.nodes.push(d);for(var e=0;e<b.getSimilars().length;e++){var f=b.getSimilars()[e];c[f.getUri()]||(c[f.getUri()]=f.toFlatJson());a.links.push(h(d,c[f.getUri()]))}for(e=0;e<b.getParts().length;e++)l(a,b.getParts()[e],c)}function h(a,b){return{source:a,target:b,value:1}}var t=this,n=null,m=[],r=[],q={},p={},y=[],u=[],v="",w;p[PLAY]=new Parameter(PLAY,0,!0);p[LOOP]=new Parameter(LOOP,0,!0);
p[ONSET]=new Parameter(ONSET,void 0);p[DURATION_RATIO]=new Parameter(DURATION_RATIO,1);p[AMPLITUDE]=new Parameter(AMPLITUDE,1);p[PLAYBACK_RATE]=new Parameter(PLAYBACK_RATE,1);p[TIME_STRETCH_RATIO]=new Parameter(TIME_STRETCH_RATIO,1);p[PAN]=new Parameter(PAN,0);p[DISTANCE]=new Parameter(DISTANCE,0);p[HEIGHT]=new Parameter(HEIGHT,0);p[REVERB]=new Parameter(REVERB,0);p[DELAY]=new Parameter(DELAY,0);p[FILTER]=new Parameter(FILTER,2E4);p[PART_INDEX]=new Parameter(PART_INDEX,0,!0);p[PART_COUNT]=new Parameter(PART_COUNT,
Number.POSITIVE_INFINITY,!0);p[PLAY].addObserver(t);p[PART_INDEX].addObserver(t);p[PART_COUNT].addObserver(t);this.setType=function(a){b=a};this.getType=function(){return b};this.getUri=function(){return a};this.setParent=function(a){n=a;for(var b in p)b!=PLAY&&b!=PART_COUNT&&b!=PART_INDEX&&u.push(new Mapping([a.getParameter(b)],!0,void 0,[this],b));a=n.getMappings();var c=this.getDymoMap(),c=Object.keys(c).map(function(a){return c[a]});for(b=0;b<a.length;b++){var d=a[b].getDymoConstraint();d&&(d=
a[b].getTargets().concat(c.filter(d)),a[b].setTargets(d))}};this.removeParent=function(){for(var a=0;a<u.length;a++)u[a].disconnect();u=[];for(var b=n.getMappings(),c=this,a=0;a<b.length;a++){var d=b[a].getTargets(),d=d.filter(function(a){return!a.isSubDymoOf(c)});b[a].setTargets(d)}n=null};this.getParent=function(){return n};this.isSubDymoOf=function(a){for(var b=this;b;){if(b==a)return!0;b=b.getParent()}return!1};this.getDymoMap=function(){var a={};d(this,a);return a};this.getLevel=function(){return n?
n.getLevel()+1:0};this.getIndex=function(){if(n)return n.getParts().indexOf(this)};this.addPart=function(a){m.push(a);a.setParent(this)};this.removePart=function(a){m.splice(m.indexOf(a));a.removeParent(this)};this.replacePart=function(a,b){m[a]&&m[a].removeParent(this);m[a]=b;b.setParent(this)};this.getPart=function(a){return m[a]};this.getParts=function(){return m};this.hasParts=function(){return 0<m.length};this.getNthPart=function(a,b){return e(a,0,b,this)};this.setBasePath=function(a){v=a};this.getBasePath=
function(){return n&&!v?n.getBasePath():v};this.setSourcePath=function(a){w=a};this.getSourcePath=function(){if(n&&!w)return n.getSourcePath();if(w)return this.getBasePath()+w};this.getAllSourcePaths=function(){var a=[];f(this,a,function(b,c){var d=b.getSourcePath();d&&0>a.indexOf(d)&&c.push(d)});return a};this.getAllDymosInHierarchy=function(){var a=[];f(this,a,function(a,b){b.push(a)});return a};this.addSimilar=function(a){r.push(a)};this.getSimilars=function(a){return r};this.getFeatures=function(){return q};
this.setFeature=function(a,b){q[a]=b};this.getFeature=function(a){if(a===LEVEL)return this.getLevel();if(a===INDEX)return this.getIndex();if(q.hasOwnProperty(a))return q[a];if(n)return n.getFeature(a);for(var b=[],c=0;c<m.length;c++)if(m[c]){var d=m[c].getFeatureWithoutLookingFurther(a);isNaN(d)||b.push(d)}if(0<b.length)return b};this.getFeatureWithoutLookingFurther=function(a){if(q[a])return q[a]};this.getMappings=function(){return y};this.getSegment=function(){return[this.getFeature("time"),p[DURATION_RATIO].getValue()*
this.getFeature("duration")]};this.addParameter=function(a){p[a.getName()]=a};this.getParameter=function(a){return p[a]};this.addMapping=function(a){y.push(a)};this.observedParameterChanged=function(a){a.getName()==PLAY&&c&&(0<a.getChange()?c.play(t):c.stop(t))};this.updatePartOrder=function(a){m&&m[0]&&!isNaN(m[0].getFeature(a))?m.sort(function(b,c){return b.getFeature(a)-c.getFeature(a)}):m&&m.sort(function(b,c){return b.getParameter(a).getValue()-c.getParameter(a).getValue()})};this.toJsonHierarchy=
function(){for(var a=this.toFlatJson(),b=0;b<m.length;b++)a.parts.push(m[b].toJsonHierarchy());return a};this.toJsonHierarchyGraph=function(){var a={nodes:[],links:[]};g(a,this);return a};this.toJsonSimilarityGraph=function(){var a={nodes:[],links:[]};l(a,this);return a};this.toFlatJson=function(){var c={"@id":a,"@type":DYMO};b&&(c.ct=b);w&&(c.source=w);for(var d in q)c[d]=this.getFeatureJson(d);if(0<y.length)for(c.mappings=[],d=0;d<y.length;d++)c.mappings.push(y[d].toJson());0<m.length&&(c.parts=
[]);if(0<r.length)for(c.similars=[],d=0;d<r.length;d++)c.similars.push(r[d].getUri());return c};this.getFeatureJson=function(a){return{value:q[a],type:FEATURE,adt:a.charAt(0).toUpperCase()+a.slice(1)}}};function Mapping(a,b,c,d,e,f){this.relative=b;this.functionJson=c;this.parameterName=e;this.setTargets(d);this.domainDims=a;this.dymoConstraint=f;this.init()}
Mapping.prototype.init=function(){this.functionJson||(this.functionJson=FunctionTools.IDENTITY_JSON);this.mappingFunction=FunctionTools.createFunction(this.functionJson.args,this.functionJson.body);this.inverseFunction=FunctionTools.invertFunction(this.functionJson.body);for(var a=0;a<this.domainDims.length;a++)this.domainDims[a].addMapping?this.domainDims[a].addMapping(this):this.domainDims[a].addObserver&&this.domainDims[a].addObserver(this)};
Mapping.prototype.setTargets=function(a){if(this.targets)for(var b=0,c=this.targetParameters.length;b<c;b++)this.targetParameters[b].removeUpdater(this);this.targets=a;this.targetParameters=[];b=0;for(c=this.targets.length;b<c;b++)this.targetParameters[b]=this.targets[b].getParameter(this.parameterName),this.targetParameters[b].addUpdater(this)};Mapping.prototype.getTargets=function(){return this.targets};Mapping.prototype.getDymoConstraint=function(){return this.dymoConstraint};
Mapping.prototype.disconnect=function(){for(var a=0;a<this.domainDims.length;a++)this.domainDims[a].removeMapping?this.domainDims[a].removeMapping(this):this.domainDims[a].removeObserver&&this.domainDims[a].removeObserver(this);for(a=0;a<this.targetParameters.length;a++)this.targetParameters[a].removeUpdater(this)};
Mapping.prototype.updateParameter=function(){for(var a=0;a<this.targetParameters.length;a++)this.relative?this.targetParameters[a].relativeUpdate(this.calculateParameter(this.targets[a]),this):this.targetParameters[a].update(this.calculateParameter(this.targets[a]),this)};Mapping.prototype.observedParameterChanged=function(a){this.updateParameter()};
Mapping.prototype.updatedParameterChanged=function(a){this.domainDims&&this.domainDims[0].backpropagate&&!this.relative&&(this.inverseFunction&&(a=this.inverseFunction(a)),this.domainDims[0].backpropagate(a,this))};Mapping.prototype.requestValue=function(a){for(var b=0;b<this.domainDims.length;b++)this.domainDims[b].requestValue&&this.domainDims[b].requestValue();return this.calculateParameter(a)};
Mapping.prototype.toJson=function(){for(var a=[],b=0;b<this.domainDims.length;b++)this.domainDims[b]instanceof Control?a.push({name:this.domainDims[b].getName(),type:this.domainDims[b].getType()}):this.domainDims[b]instanceof Parameter?a.push({name:this.domainDims[b].getName(),type:"Parameter"}):a.push({name:this.domainDims[b],type:"Feature"});var a={domainDims:a,"function":this.functionJson},b=this.targets.filter(function(a){return a instanceof DynamicMusicObject}).map(function(a){return a.getUri()}),
c=this.targets.filter(function(a){return!(a instanceof DynamicMusicObject)}).map(function(a){return a.getUri()});0<b.length&&(a.dymos=b);0<c.length&&(a.controls=c);a.parameter=this.parameterName;return a};
Mapping.prototype.calculateParameter=function(a){for(var b=[],c=0;c<this.domainDims.length;c++){var d;d="string"===typeof this.domainDims[c]||this.domainDims[c]instanceof String?a.getFeature(this.domainDims[c]):this.relative?this.domainDims[c].getChange():this.domainDims[c].getValue();b[c]=d}return this.mappingFunction.apply(this,b)};function Parameter(a,b,c){this.name=a;this.value=b;this.change=0;this.isInteger=c;this.updaters=[];this.observers=[]}Parameter.prototype.getName=function(){return this.name};Parameter.prototype.getValue=function(){return this.value};Parameter.prototype.getChange=function(){return this.change};Parameter.prototype.addUpdater=function(a){0>this.updaters.indexOf(a)&&(this.updaters.push(a),a.updatedParameterChanged(this.value))};
Parameter.prototype.removeUpdater=function(a){a=this.updaters.indexOf(a);-1<a&&this.updaters.splice(a,1)};Parameter.prototype.addObserver=function(a){this.observers.push(a)};Parameter.prototype.removeObserver=function(a){a=this.observers.indexOf(a);-1<a&&this.observers.splice(a,1)};Parameter.prototype.getObservers=function(){return this.observers};Parameter.prototype.update=function(a,b){this.setValueAndNotify(b,a)};Parameter.prototype.relativeUpdate=function(a,b){this.update(this.value+a,b)};
Parameter.prototype.requestValue=function(){for(var a=0;a<this.updaters.length;a++){var b=this.updaters[a].requestValue();if(b&&b!=this.value){this.setValueAndNotify(this.updaters[a],b);break}}return this.value};Parameter.prototype.notifyObservers=function(){for(var a=0;a<this.observers.length;a++)this.observers[a].observedParameterChanged(this)};
Parameter.prototype.setValueAndNotify=function(a,b){if(!isNaN(b)&&(this.isInteger&&(b=Math.round(b)),isNaN(this.value)||1E-6<Math.abs(b-this.value))){this.change=b-this.value;this.value=b;for(var c=0;c<this.updaters.length;c++)this.updaters[c]!=a&&this.updaters[c].updatedParameterChanged(this.value);this.change&&this.notifyObservers()}};function Rendering(a){var b=[],c=[];this.play=function(){a&&a.getParameter(PLAY).update(1)};this.stop=function(){a&&a.getParameter(PLAY).update(0)};this.addMapping=function(a){b.push(a);a.updateParameter()};this.getMappings=function(){return b};this.addNavigator=function(a,b){c.push([a,b])};this.toJson=function(){var d={mappings:[],navigators:[]};a&&(d.topDymo=a.getUri());for(var e=0;e<b.length;e++)d.mappings.push(b[e].toJson());for(e=0;e<b.length;e++)d.navigators.push({dymos:c[e][0],type:c[e][1].getType()});
return d}};function FunctionTools(){}FunctionTools.IDENTITY_JSON={args:["a"],body:"return a;"};FunctionTools.inverted={};FunctionTools.created={};FunctionTools.createFunction=function(a,b){FunctionTools.created[b]||(FunctionTools.created[b]=Function.apply(null,a.concat(b)));return FunctionTools.created[b]};
FunctionTools.invertFunction=function(a){var b=FunctionTools.toReturnValueString(a);FunctionTools.inverted[a]||(FunctionTools.inverted[a]=FunctionTools.toJavaScriptFunction(FunctionTools.invertReturnValue(b)));return FunctionTools.inverted[a]};
FunctionTools.invertReturnValue=function(a){var b;try{b=math.parse(a)}catch(e){e instanceof SyntaxError||console.log(e);return}for(var c=a=new math.expression.node.SymbolNode("a");b;)if(b.isSymbolNode)a.name=b.name,b=void 0;else if(b.isParenthesisNode)b=b.content;else if(b.isOperatorNode){var d=FunctionTools.getInvertedOperator(b.op);if("+"==b.op||"*"==b.op)if(b.args[0].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[0]]),b=FunctionTools.ifNextNode(b.args[1]);
else if(b.args[1].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[1]]),b=FunctionTools.ifNextNode(b.args[0]);else return;else if("-"==b.op||"/"==b.op)if(b.args[0].isConstantNode)c=new math.expression.node.OperatorNode(b.op,FunctionTools.getOperatorName(b.op),[b.args[0],c]),b=FunctionTools.ifNextNode(b.args[1]);else if(b.args[1].isConstantNode)c=new math.expression.node.OperatorNode(d,FunctionTools.getOperatorName(d),[c,b.args[1]]),b=FunctionTools.ifNextNode(b.args[0]);
else return}else return;return c.toString()};FunctionTools.toJavaScriptFunction=function(a){return new Function("a","return "+a+";")};FunctionTools.toReturnValueString=function(a){return a.substring(a.indexOf("return ")+7,a.indexOf(";"))};FunctionTools.ifNextNode=function(a){if(a.isOperatorNode||a.isParenthesisNode||a.isSymbolNode)return a};FunctionTools.getInvertedOperator=function(a){if("+"==a)return"-";if("-"==a)return"+";if("*"==a)return"/";if("/"==a)return"*"};
FunctionTools.getOperatorName=function(a){if("+"==a)return"add";if("-"==a)return"subtract";if("*"==a)return"multiply";if("/"==a)return"divide"};function PolygonTools(){}PolygonTools.isPointInPolygon=function(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!c);return c};PolygonTools.getArea=function(a){var b=0,c,d,e=0;for(d=a.length-1;e<a.length;d=e,e++)c=a[e],d=a[d],b+=c[0]*d[1],b-=c[1]*d[0];return b/2};
PolygonTools.getCentroid=function(a){var b,c,d,e=0,f=0,g=0;for(c=a.length-1;g<a.length;c=g,g++)b=a[g],c=a[c],d=b[0]*c[1]-c[0]*b[1],e+=(b[0]+c[0])*d,f+=(b[1]+c[1])*d;d=6*PolygonTools.getArea(a);return{0:e/d,1:f/d}};function sqDist(a,b){return Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2)}
PolygonTools.getDistanceFromSegment=function(a,b,c){var d=sqDist(b,c);if(0==d)return sqDist(a,b);d=((a[0]-b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return 0>d?sqDist(a,b):1<d?sqDist(a,c):Math.sqrt(sqDist(a,{0:b[0]+d*(c[0]-b[0]),1:b[1]+d*(c[1]-b[1])}))};PolygonTools.getMinDistanceFromEdge=function(a,b){for(var c=Number.POSITIVE_INFINITY,d=0;d<a.length;d++)var e=PolygonTools.getDistanceFromSegment(b,a[d],a[(d+1)%a.length]),c=Math.min(e,c);return c};
PolygonTools.howFarIsPointInPolygon=function(a,b,c){return PolygonTools.isPointInPolygon(a,c)?(b=Math.sqrt(Math.pow(c[0]-b[0],2)+Math.pow(c[1]-b[1],2)),a=PolygonTools.getMinDistanceFromEdge(a,c),Math.sqrt((1-b)*a/Math.abs(b+a))):0};PolygonTools.getPolygonFunctionArgs=function(a){return["a","b","return PolygonTools.isPointInPolygon("+getPolygonOrPointString(a)+", {0:a, 1:b});"]};
PolygonTools.getInterpolatedPolygonFunctionArgs=function(a){var b=getPolygonOrPointString(a);a=getPolygonOrPointString(PolygonTools.getCentroid(a));return["a","b","return PolygonTools.howFarIsPointInPolygon("+b+","+a+", {0:a, 1:b});"]};function getPolygonOrPointString(a){return JSON.stringify(a).replace(/"/g,"'")};function DymoNavigator(a,b){function c(a){var b=e(a);if(b){l[a.getLevel()]=b;if(b.getType()==ONE_SHOT_NAVIGATOR)return b.getCurrentParts();a=b.getCurrentParts();return(a=d(a))?a:d(b.getNextParts())}return[a]}function d(a){if(a&&0<a.length){for(var b=[],d=0,e=a.length;d<e;d++){var f=c(a[d]);f&&(f.length?b=b.concat(f):b.push(f))}if(0<b.length)return b}}function e(a){if(!g.has(a)){for(var c=0,d=f.length;c<d;c++)f[c][0](a)&&a.hasParts()&&g.set(a,f[c][1].getCopy(a));g.has(a)||(b&&a.hasParts()?g.set(a,
b.getCopy(a)):g.set(a,new OneShotNavigator(a)))}return g.get(a)}var f=[],g,l;g=new Map;l=[];this.reset=function(a){if(a){var b=a.getAllDymosInHierarchy();b.splice(b.indexOf(a),1);a=0;for(var c=b.length;a<c;a++){var d=g.delete(b[a]);(d=l.indexOf(d))&&l.splice(d,1)}}else g=new Map,l=[]};this.addSubsetNavigator=function(a,b){f.push([a,b])};this.getPosition=function(b,c){c||(c=a);for(var d=0;d<b;){if(!g.has(c))return;c=g.get(c).getCurrentParts()[0];d++}if(g.has(c))return g.get(c).getPartsNavigated()};
this.setPosition=function(b,c,d){d||(d=a);for(var f=0;f<=c&&d;){var g=e(d);f==c?(g.setPartsNavigated(b),this.reset(d)):d=g.getCurrentParts()?g.getCurrentParts()[0]:void 0;f++}};this.getNextParts=function(){return c(a)}};function OneShotNavigator(a){var b=!1;this.getType=function(){return ONE_SHOT_NAVIGATOR};this.getCopy=function(a){return new OneShotNavigator(a)};this.getCurrentParts=function(){if(!b)return b=!0,[a]};this.getNextParts=function(){return this.getCurrentParts()}};function SequentialNavigator(a,b){var c=0;this.resetPartsNavigated=function(){c=0};this.setPartsNavigated=function(a){c=a};this.getPartsNavigated=function(){return c};this.getType=function(){return SEQUENTIAL_NAVIGATOR};this.getCopy=function(a){return new SequentialNavigator(a,b)};this.getDymo=function(){return a};this.getCurrentParts=function(){if(0<a.getParts().length){if(a.getType()==PARALLEL){var d;d=0>=c?a.getParts():void 0;return d}b?(d=a.getParts().length,d=a.getPart(d-c)):d=a.getPart(c);d=
d?[d]:void 0;return d}};this.getNextParts=function(){c++;return this.getCurrentParts()}};function SimilarityNavigator(a){function b(b){if(b&&0<b.length)for(var f=0;f<b.length;f++)if(0<b[f].getSimilars().length&&Math.random()<c.leapingProbability.getValue()){var g=b[f].getSimilars(),l=Math.floor(Math.random()*g.length);if(c.continueAfterLeaping.getValue()){var h=a.getParts().indexOf(l);h&&(d=h+1)}b[f]=g[l]}return b}var c=this,d=0;this.leapingProbability=new Parameter(LEAPING_PROBABILITY,.5);this.continueAfterLeaping=new Parameter(CONTINUE_AFTER_LEAPING,0,!0);this.resetPartsPlayed=function(){d=
0};this.getType=function(){return SIMILARITY_NAVIGATOR};this.getCopy=function(a){a=new SimilarityNavigator(a);a.leapingProbability.update(this.leapingProbability.getValue(),this);a.continueAfterLeaping.update(this.continueAfterLeaping.getValue(),this);return a};this.getCurrentParts=function(){if(0<a.getParts().length){if(a.getType()==PARALLEL){var c;0>=d?(d++,c=a.getParts()):c=void 0;return b(c)}(c=a.getPart(d))?(c.hasParts()||d++,c=[c]):c=void 0;return b(c)}};this.getNextParts=function(){d++;return this.getCurrentParts()}}
;function inheritPrototype(a,b){var c=Object.create(b.prototype);c.constructor=a;a.prototype=c};function SoundTouch(a){this.rateTransposer=new RateTransposer(!1);this.tdStretch=new Stretch(!1,a);this._inputBuffer=new FifoSampleBuffer;this._intermediateBuffer=new FifoSampleBuffer;this._outputBuffer=new FifoSampleBuffer;this.tempo=this._rate=0;this.virtualTempo=this.virtualRate=this.virtualPitch=1;this._calculateEffectiveRateAndTempo()}
extend(SoundTouch.prototype,{clear:function(){this.rateTransposer.clear();this.tdStretch.clear()},clone:function(){var a=new SoundTouch;a.rate=this._rate;a.tempo=this.tempo;return a},get rate(){return this._rate},set rate(a){this.virtualRate=a;this._calculateEffectiveRateAndTempo()},set rateChange(a){this.rate=1+.01*a},get tempo(){return this._tempo},set tempo(a){this.virtualTempo=a;this._calculateEffectiveRateAndTempo()},set tempoChange(a){this.tempo=1+.01*a},set pitch(a){this.virtualPitch=a;this._calculateEffectiveRateAndTempo()},
set pitchOctaves(a){this.pitch=Math.exp(.69314718056*a);this._calculateEffectiveRateAndTempo()},set pitchSemitones(a){this.pitchOctaves=a/12},get inputBuffer(){return this._inputBuffer},get outputBuffer(){return this._outputBuffer},_calculateEffectiveRateAndTempo:function(){var a=this._tempo,b=this._rate;this._tempo=this.virtualTempo/this.virtualPitch;this._rate=this.virtualRate*this.virtualPitch;testFloatEqual(this._tempo,a)&&(this.tdStretch.tempo=this._tempo);testFloatEqual(this._rate,b)&&(this.rateTransposer.rate=
this._rate);1<this._rate?this._outputBuffer!=this.rateTransposer.outputBuffer&&(this.tdStretch.inputBuffer=this._inputBuffer,this.tdStretch.outputBuffer=this._intermediateBuffer,this.rateTransposer.inputBuffer=this._intermediateBuffer,this.rateTransposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.tdStretch.outputBuffer&&(this.rateTransposer.inputBuffer=this._inputBuffer,this.rateTransposer.outputBuffer=this._intermediateBuffer,this.tdStretch.inputBuffer=this._intermediateBuffer,this.tdStretch.outputBuffer=
this._outputBuffer)},process:function(){1<this._rate?(this.tdStretch.process(),this.rateTransposer.process()):(this.rateTransposer.process(),this.tdStretch.process())}});function FifoSampleBuffer(){this._vector=new Float32Array;this._frameCount=this._position=0}
FifoSampleBuffer.prototype={get vector(){return this._vector},get position(){return this._position},get startIndex(){return 2*this._position},get frameCount(){return this._frameCount},get endIndex(){return 2*(this._position+this._frameCount)},clear:function(){this.receive();this.rewind()},put:function(a){this._frameCount+=a},putSamples:function(a,b,c){b=2*(b||0);0<=c||(c=(a.length-b)/2);var d=2*c;this.ensureCapacity(c+this._frameCount);var e=this.endIndex;this._vector.set(a.subarray(b,b+d),e);this._frameCount+=
c},putBuffer:function(a,b,c){b=b||0;0<=c||(c=a.frameCount-b);this.putSamples(a.vector,a.position+b,c)},receive:function(a){if(!(0<=a)||a>this._frameCount)a=this._frameCount;this._frameCount-=a;this._position+=a},receiveSamples:function(a,b){var c=this.startIndex;a.set(this._vector.subarray(c,c+2*b));this.receive(b)},extract:function(a,b,c){b=this.startIndex+2*b;a.set(this._vector.subarray(b,b+2*c))},ensureCapacity:function(a){a*=2;this._vector.length<a?(a=new Float32Array(a),a.set(this._vector.subarray(this.startIndex,
this.endIndex)),this._vector=a,this._position=0):this.rewind()},ensureAdditionalCapacity:function(a){this.ensureCapacity(this.frameCount+a)},rewind:function(){0<this._position&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}};function extend(a,b){for(var c in b){var d=b.__lookupGetter__(c),e=b.__lookupSetter__(c);d||e?(d&&a.__defineGetter__(c,d),e&&a.__defineSetter__(c,e)):a[c]=b[c]}return a}function testFloatEqual(a,b){return 1E-10<(a>b?a-b:b-a)}
function FilterSupport(a){this._pipe=a}
FilterSupport.prototype={get pipe(){return this._pipe},get inputBuffer(){return this._pipe.inputBuffer},get outputBuffer(){return this._pipe.outputBuffer},fillOutputBuffer:function(a){for(;this.outputBuffer.frameCount<a;){this.fillInputBuffer(16-this.inputBuffer.frameCount);if(16>this.inputBuffer.frameCount)break;this._pipe.process()}},clear:function(){this._pipe.clear();this.outputBufferPosition=0},get position(){return this._position},set position(a){if(a>this._position)throw new RangeError("New position may not be greater than current position");
var b=this.outputBufferPosition-(this._position-a);if(0>b)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=b;this._position=a},get sourcePosition(){return this._sourcePosition},set sourcePosition(a){this.clear();this._sourcePosition=a},fillInputBuffer:function(a){var b=new Float32Array(2*a);a=this.sourceSound.extract(b,a,this._sourcePosition);this._sourcePosition+=a;this.inputBuffer.putSamples(b,0,a)},extract:function(a,b){this.fillOutputBuffer(this.outputBufferPosition+
b);var c=Math.min(b,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(a,this.outputBufferPosition,c);var d=this.outputBufferPosition+c;this.outputBufferPosition=Math.min(this.historyBufferSize,d);this.outputBuffer.receive(Math.max(d-this.historyBufferSize,0));this._position+=c;return c},handleSampleData:function(a){this.extract(a.data,4096)}};
function SimpleFilter(a,b){FilterSupport.call(this,b);this.sourceSound=a;this.historyBufferSize=22050;this._position=this.outputBufferPosition=this._sourcePosition=0}extend(SimpleFilter.prototype,FilterSupport.prototype);function AbstractFifoSamplePipe(a){a?(this.inputBuffer=new FifoSampleBuffer,this.outputBuffer=new FifoSampleBuffer):this.inputBuffer=this.outputBuffer=null}
AbstractFifoSamplePipe.prototype={get inputBuffer(){return this._inputBuffer},set inputBuffer(a){this._inputBuffer=a},get outputBuffer(){return this._outputBuffer},set outputBuffer(a){this._outputBuffer=a},clear:function(){this._inputBuffer.clear();this._outputBuffer.clear()}};function RateTransposer(a){AbstractFifoSamplePipe.call(this,a);this._reset();this.rate=1}extend(RateTransposer.prototype,AbstractFifoSamplePipe.prototype);
extend(RateTransposer.prototype,{set rate(a){this._rate=a},_reset:function(){this.prevSampleR=this.prevSampleL=this.slopeCount=0},clone:function(){var a=new RateTransposer;a.rate=this._rate;return a},process:function(){var a=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(a/this._rate+1);a=this._transpose(a);this._inputBuffer.receive();this._outputBuffer.put(a)},_transpose:function(a){if(0==a)return 0;for(var b=this._inputBuffer.vector,c=this._inputBuffer.startIndex,d=this._outputBuffer.vector,
e=this._outputBuffer.endIndex,f=0,g=0;1>this.slopeCount;)d[e+2*g]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*b[c],d[e+2*g+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*b[c+1],g++,this.slopeCount+=this._rate;--this.slopeCount;if(1!=a)a:for(;;){for(;1<this.slopeCount;)if(--this.slopeCount,f++,f>=a-1)break a;var l=c+2*f;d[e+2*g]=(1-this.slopeCount)*b[l]+this.slopeCount*b[l+2];d[e+2*g+1]=(1-this.slopeCount)*b[l+1]+this.slopeCount*b[l+3];g++;this.slopeCount+=this._rate}this.prevSampleL=
b[c+2*a-2];this.prevSampleR=b[c+2*a-1];return g}});
var USE_AUTO_SEQUENCE_LEN=0,DEFAULT_SEQUENCE_MS=USE_AUTO_SEQUENCE_LEN,USE_AUTO_SEEKWINDOW_LEN=0,DEFAULT_SEEKWINDOW_MS=USE_AUTO_SEEKWINDOW_LEN,DEFAULT_OVERLAP_MS=8,_SCAN_OFFSETS=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],AUTOSEQ_TEMPO_LOW=.5,AUTOSEQ_TEMPO_TOP=2,
AUTOSEQ_AT_MIN=125,AUTOSEQ_AT_MAX=50,AUTOSEQ_K=(AUTOSEQ_AT_MAX-AUTOSEQ_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEQ_C=AUTOSEQ_AT_MIN-AUTOSEQ_K*AUTOSEQ_TEMPO_LOW,AUTOSEEK_AT_MIN=25,AUTOSEEK_AT_MAX=15,AUTOSEEK_K=(AUTOSEEK_AT_MAX-AUTOSEEK_AT_MIN)/(AUTOSEQ_TEMPO_TOP-AUTOSEQ_TEMPO_LOW),AUTOSEEK_C=AUTOSEEK_AT_MIN-AUTOSEEK_K*AUTOSEQ_TEMPO_LOW;
function Stretch(a,b){AbstractFifoSamplePipe.call(this,a);this.bQuickSeek=!0;this.bMidBufferDirty=!1;this.pMidBuffer=null;this.overlapLength=0;this.bAutoSeekSetting=this.bAutoSeqSetting=!0;this._tempo=1;this.setParameters(b,DEFAULT_SEQUENCE_MS,DEFAULT_SEEKWINDOW_MS,DEFAULT_OVERLAP_MS)}extend(Stretch.prototype,AbstractFifoSamplePipe.prototype);
extend(Stretch.prototype,{clear:function(){AbstractFifoSamplePipe.prototype.clear.call(this);this._clearMidBuffer()},_clearMidBuffer:function(){this.bMidBufferDirty&&(this.bMidBufferDirty=!1,this.pMidBuffer=null)},setParameters:function(a,b,c,d){0<a&&(this.sampleRate=a);0<d&&(this.overlapMs=d);0<b?(this.sequenceMs=b,this.bAutoSeqSetting=!1):this.bAutoSeqSetting=!0;0<c?(this.seekWindowMs=c,this.bAutoSeekSetting=!1):this.bAutoSeekSetting=!0;this.calcSeqParameters();this.calculateOverlapLength(this.overlapMs);
this.tempo=this._tempo},set tempo(a){this._tempo=a;this.calcSeqParameters();this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength);this.skipFract=0;this.sampleReq=Math.max(Math.floor(this.nominalSkip+.5)+this.overlapLength,this.seekWindowLength)+this.seekLength},get inputChunkSize(){return this.sampleReq},get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)},calculateOverlapLength:function(a){a=this.sampleRate*a/1E3;16>a&&(a=16);this.overlapLength=
a-a%8;this.pRefMidBuffer=new Float32Array(2*this.overlapLength);this.pMidBuffer=new Float32Array(2*this.overlapLength)},checkLimits:function(a,b,c){return a<b?b:a>c?c:a},calcSeqParameters:function(){var a;this.bAutoSeqSetting&&(a=AUTOSEQ_C+AUTOSEQ_K*this._tempo,a=this.checkLimits(a,AUTOSEQ_AT_MAX,AUTOSEQ_AT_MIN),this.sequenceMs=Math.floor(a+.5));this.bAutoSeekSetting&&(a=AUTOSEEK_C+AUTOSEEK_K*this._tempo,a=this.checkLimits(a,AUTOSEEK_AT_MAX,AUTOSEEK_AT_MIN),this.seekWindowMs=Math.floor(a+.5));this.seekWindowLength=
Math.floor(this.sampleRate*this.sequenceMs/1E3);this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1E3)},set quickSeek(a){this.bQuickSeek=a},clone:function(){var a=new Stretch;a.tempo=this.tempo;a.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs);return a},seekBestOverlapPosition:function(){return this.bQuickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()},seekBestOverlapPositionStereo:function(){var a,b,c,d;this.precalcCorrReferenceStereo();
b=Number.MIN_VALUE;for(d=a=0;d<this.seekLength;d++)c=this.calcCrossCorrStereo(2*d,this.pRefMidBuffer),c>b&&(b=c,a=d);return a},seekBestOverlapPositionStereoQuick:function(){var a,b,c,d,e,f,g;this.precalcCorrReferenceStereo();c=Number.MIN_VALUE;for(e=f=b=0;4>e;e++){for(a=0;_SCAN_OFFSETS[e][a];){g=f+_SCAN_OFFSETS[e][a];if(g>=this.seekLength)break;d=this.calcCrossCorrStereo(2*g,this.pRefMidBuffer);d>c&&(c=d,b=g);a++}f=b}return b},precalcCorrReferenceStereo:function(){var a,b,c;for(a=0;a<this.overlapLength;a++)c=
a*(this.overlapLength-a),b=2*a,this.pRefMidBuffer[b]=this.pMidBuffer[b]*c,this.pRefMidBuffer[b+1]=this.pMidBuffer[b+1]*c},calcCrossCorrStereo:function(a,b){var c=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var d,e,f;d=0;for(e=2;e<2*this.overlapLength;e+=2)f=e+a,d+=c[f]*b[e]+c[f+1]*b[e+1];return d},overlap:function(a){this.overlapStereo(2*a)},overlapStereo:function(a){var b=this._inputBuffer.vector;a+=this._inputBuffer.startIndex;var c=this._outputBuffer.vector,d=this._outputBuffer.endIndex,
e,f,g,l,h,t,n;l=1/this.overlapLength;for(e=0;e<this.overlapLength;e++)g=(this.overlapLength-e)*l,h=e*l,f=2*e,t=f+a,n=f+d,c[n+0]=b[t+0]*h+this.pMidBuffer[f+0]*g,c[n+1]=b[t+1]*h+this.pMidBuffer[f+1]*g},process:function(){var a,b;if(null==this.pMidBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.pMidBuffer=new Float32Array(2*this.overlapLength);this._inputBuffer.receiveSamples(this.pMidBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;)a=this.seekBestOverlapPosition(),
this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(a)),this._outputBuffer.put(this.overlapLength),b=this.seekWindowLength-2*this.overlapLength,0<b&&this._outputBuffer.putBuffer(this._inputBuffer,a+this.overlapLength,b),a=this.inputBuffer.startIndex+2*(a+this.seekWindowLength-this.overlapLength),this.pMidBuffer.set(this._inputBuffer.vector.subarray(a,a+2*this.overlapLength)),this.skipFract+=this.nominalSkip,a=Math.floor(this.skipFract),this.skipFract-=a,this._inputBuffer.receive(a)}});
extend(Stretch.prototype,{get tempo(){return this._tempo}});
