function AudioProcessor(a){function d(a){return{extract:function(c,d,h){for(var g=[],k=0;k<a.numberOfChannels;k++)g.push(a.getChannelData(k));for(k=0;k<d;k++)for(var m=0;m<g.length;m++)c[k*g.length+m%g.length]=g[m][k+h];return Math.min(d,g[0].length-h)}}}this.timeStretch=function(b,c){var f=new SoundTouch(b.sampleRate);f.tempo=c;for(var h=d(b),f=new SimpleFilter(h,f),h=a.createBuffer(b.numberOfChannels,1/c*b.length,b.sampleRate),g=[],k=0;k<b.numberOfChannels;k++)g.push(h.getChannelData(k));for(var m=
new Float32Array(2048),n=f.extract(m,1024),p=0;n;){for(k=0;k<n;k++)for(var u=0;u<g.length;u++)g[u][k+p]=m[k*g.length+u%g.length];p+=n;n=f.extract(m,1024)}return h}};function AudioProcessorSource(a,d,b){var c=this,f=new SoundTouch(d.sampleRate);this.stretchRatio={setValue:function(a){f.tempo=a},getValue:function(){return f.tempo}};this.playbackRate={setValue:function(a){f.rate=a},getValue:function(){return f.rate}};var h=new SimpleFilter({extract:function(a,c,b){for(var f=[],h=0;h<d.numberOfChannels;h++)f.push(d.getChannelData(h));for(h=0;h<c;h++)for(var g=0;g<f.length;g++)a[h*f.length+g%f.length]=f[g][h+b];return Math.min(c,f[0].length-b)}},f),g=a.createScriptProcessor(1024,
2,d.numberOfChannels),k=new Float32Array(2048);g.onaudioprocess=function(a){for(var b=[],f=0;f<d.numberOfChannels;f++)b.push(a.outputBuffer.getChannelData(f));a=h.extract(k,1024);0==a&&c.stop();for(f=0;f<a;f++)for(var g=0;g<b.length;g++)b[g][f]=k[f*b.length+g%b.length]};this.start=function(a){setTimeout(function(){g.connect(b)},a)};this.stop=function(){g.disconnect()}};function Scheduler(a,d,b){function c(){0<l&&l--;0==l&&d&&d(l)}function f(e){var c=e.getUri(),b;if(w[c])for(b=y[c],l=0;l<b.length;l++)h(c,b[l].getDymo().getUri(),b[l]);else{b=n(e);w[c]={};for(var l=0;l<b.length;l++){var d=b[l].getDymo();h(c,d.getUri(),b[l]);v[c]=d.getParameter(ONSET).getValue()}}var g;g=t[c]?t[c]-a.currentTime:.1;d=a.currentTime+g;for(l=0;l<b.length;l++)b[l].play(d);setTimeout(function(){for(var e=[],a=0;a<b.length;a++)e.push(b[a].getDymo());m(e)},g);(l=n(e))?(y[c]=l,l=l[0].getDymo().getParameter(ONSET).getValue(),
g=l-v[c],-1!=l?(t[c]=d+g,v[c]=l):t[c]=d+b[0].getDuration()/b[0].getParameterValue(PLAYBACK_RATE),t[c]&&(r=setTimeout(function(){f(e)},1E3*(t[c]-a.currentTime-.1)))):(t[c]=d+b[0].getDuration()/b[0].getParameterValue(PLAYBACK_RATE),r=setTimeout(function(){k(e)},1E3*(t[c]-a.currentTime)))}function h(e,a,c){w[e][a]=c}function g(e,a){var c=w[e.getUri()];if(c)for(var l in c)c[l][a].call(c[l])}function k(e){window.clearTimeout(r);var a=e.getUri();w[a]=null;y[a]=null;t[a]=null;e.resetPartsPlayed();m([])}
function m(e){for(var a=[],c=0;c<e.length;c++)for(var l=e[c];null!=l;)0>a.indexOf(l.getUri())&&a.push(l.getUri()),l=l.getParent();u.urisOfPlayingDymos=a;b&&b()}function n(c){if(c=c.getNextParts()){for(var l=[],b=0;b<c.length;b++)if(c[b].getSourcePath()){var f=q[c[b].getSourcePath()];f&&l.push(new Source(c[b],a,f,e))}return l}}function p(e,c,b){l++;c.src=e;c.ctx=a;c.onload=b;c.onerror=function(){console.log("Error loading audio ",e)};c.send()}var u=this,x="",q={},w={},y={},t={},v={};this.urisOfPlayingDymos=
[];this.listenerOrientation=new Parameter(this,0);var e=a.createConvolver();e.connect(a.destination);var l=0,r;this.setReverbFile=function(a){var l=new AudioSampleLoader;p(a,l,function(){e.buffer=l.response;c()})};this.setDymoBasePath=function(e){x=e};this.getDymoBasePath=function(){return x};this.addSourceFile=function(e){if(!q[e]){var a=new AudioSampleLoader;p(x+e,a,function(){q[e]=a.response;c()})}};this.getBuffer=function(e){return q[e.getSourcePath()]};this.play=function(e){e.updatePartOrder(ONSET);
f(e)};this.pause=function(e){g(e,"pause")};this.stop=function(e){g(e,"stop");k(e)};this.getSources=function(e){return w[e.getUri()]};this.updateListenerOrientation=function(){var e=this.listenerOrientation.value/180*Math.PI;a.listener.setOrientation(Math.sin(e),0,-Math.cos(e),0,1,0)};this.listenerOrientation=new Parameter(this,this.updateListenerOrientation,0)};function Source(a,d,b,c){function f(e,a){g(e,a.getValue());a.addObserver(p)}function h(){for(var e=0;e<z.length;e++){var c=a.getParameter(z[e]);c&&c.removeObserver(p)}}function g(e,a,c){c&&(a+=p.getParameterValue(e));0>a&&0<=A.indexOf(e)&&(a=0);c=a;r[e]&&(r[e].value||0==r[e].value?r[e].value=c:r[e].setValue(c));0<=B.indexOf(e)?(0==r[DISTANCE].value&&(r[DISTANCE].value=-.01),y.setPosition(r[PAN].value,r[HEIGHT].value,r[DISTANCE].value)):e==LOOP&&(l.loop=1==a)}function k(){u=!1;var e=d.currentTime;
r[AMPLITUDE].setValueAtTime(r[AMPLITUDE].value,e);r[AMPLITUDE].linearRampToValueAtTime(0,e+.02);l.stop(e+.04)}function m(e,a){if(e||0==e)return Math.round(e*a.sampleRate)}function n(e,a,c){c=Math.min(e.length-a,c);for(var l=d.createBuffer(e.numberOfChannels,c,e.sampleRate),b=0;b<e.numberOfChannels;b++)for(var f=l.getChannelData(b),r=e.getChannelData(b),g=0;g<c;g++)f[g]=r[a+g];return l}var p=this,u,x,q=d.createGain();q.connect(d.destination);var w=d.createGain();w.connect(c);w.gain.value=0;q.connect(w);
var y=d.createPanner();y.connect(q);c=d.createBiquadFilter();c.type="lowpass";c.frequency.value=2E4;c.connect(y);var t=a.getSegment(),v=t[0],e=t[1];v||(v=0);e||(e=b.duration-v);t=a.getParameter(TIME_STRETCH_RATIO).getValue();if(1!=t){if(0!=v||e<b.duration)b=n(b,m(v,b),m(e+.3,b));b=(new AudioProcessor(d)).timeStretch(b,t);v=e/t;b=n(b,0,m(v+.02,b));e=v}else if(0!=v||e<b.duration)b=n(b,m(v,b),m(e+.02,b));(function(e,a){for(var c=.02*e.sampleRate,l=0;l<e.numberOfChannels;l++)for(var b=e.getChannelData(l),
f=0;f<c;f++)b[f]*=f/c,b[a-f-1]*=f/c})(b,b.length);var l=d.createBufferSource();l.connect(c);l.buffer=b;var r={};r[AMPLITUDE]=q.gain;r[PLAYBACK_RATE]=l.playbackRate;r[TIME_STRETCH_RATIO]={value:0};r[REVERB]=w.gain;r[FILTER]=c.frequency;r[PAN]={value:0};r[HEIGHT]={value:0};r[DISTANCE]={value:0};r[LOOP]={value:0};var z=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER,PAN,HEIGHT,DISTANCE,LOOP],A=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER],B=[PAN,HEIGHT,DISTANCE];f(AMPLITUDE,a.getParameter(AMPLITUDE));
f(PLAYBACK_RATE,a.getParameter(PLAYBACK_RATE));f(TIME_STRETCH_RATIO,a.getParameter(TIME_STRETCH_RATIO));f(REVERB,a.getParameter(REVERB));f(PAN,a.getParameter(PAN));f(HEIGHT,a.getParameter(HEIGHT));f(DISTANCE,a.getParameter(DISTANCE));f(LOOP,a.getParameter(LOOP));this.observedParameterChanged=function(e){g(e.getName(),e.getChange(),!0)};this.getDymo=function(){return a};this.getDuration=function(){return e};this.isLoopingAndPlaying=function(){return l.loop&&u};this.getParameterValue=function(e){if(r[e])return r[e].value||
0==r[e].value?r[e].value:r[e].getValue()};this.play=function(e){l.onended=h;l.start(e);u=!0};this.pause=function(){u?(k(),x=!0):x&&(x=!1,this.play())};this.stop=function(){u&&(h(),k())}};function BrownianControls(){function a(){c=setInterval(function(){var a=b[BROWNIAN_MAX_STEP_SIZE].getValue(),a=2*a*Math.random()-a,a=d.brownianControl.getValue()+a,a=Math.min(Math.max(a,0),1);d.brownianControl.update(a)},b[BROWNIAN_FREQUENCY].getValue())}var d=this,b={};b[BROWNIAN_FREQUENCY]=new Parameter(BROWNIAN_FREQUENCY,100);b[BROWNIAN_FREQUENCY].addObserver(this);b[BROWNIAN_MAX_STEP_SIZE]=new Parameter(BROWNIAN_MAX_STEP_SIZE,.1);b[BROWNIAN_MAX_STEP_SIZE].addObserver(this);this.brownianControl=
new Control(BROWNIAN,AUTO_CONTROL,b);this.brownianControl.update(.5);var c;a();this.getParameter=function(a){return b[a]};this.observedParameterChanged=function(b){b.getName()==BROWNIAN_FREQUENCY&&(clearInterval(c),a())}};function RampControls(){function a(){g=setInterval(function(){var a=1/b.duration*b.frequency;f||(a*=-1);c+=a;0<c&&1>c?b.linearRampControl.update(c):1<=c?(b.linearRampControl.update(1),d()):0>=c&&(b.linearRampControl.update(0),d())},b.frequency)}function d(){clearInterval(g);g=void 0;f=!f}var b=this;this.frequency=100;this.duration=1E4;var c=0,f=!0,h={};h[RAMP_TRIGGER]=new Parameter(RAMP_TRIGGER,0);h[RAMP_TRIGGER].addObserver(this);this.linearRampControl=new Control(RAMP,AUTO_CONTROL,h);var g;this.getParameter=
function(a){return h[a]};this.observedParameterChanged=function(c){c.getName()==RAMP_TRIGGER&&(g?d():a())}};function StatsControls(){function a(){c=setInterval(function(){d.randomControl.update(Math.random())},b[STATS_FREQUENCY].getValue())}var d=this,b={};b[STATS_FREQUENCY]=new Parameter(STATS_FREQUENCY,300);b[STATS_FREQUENCY].addObserver(this);this.randomControl=new Control(RANDOM,AUTO_CONTROL,b);var c;a();this.getParameter=function(a){return b[a]};this.observedParameterChanged=function(b){b.getName()==STATS_FREQUENCY&&(clearInterval(c),a())}};function UIControl(a,d){var b=this;this.value=a.getValue();a.setUpdateFunction(function(a){b.value=a;d&&setTimeout(function(){d.$apply()},10)});this.getName=function(){return a.getName()};this.getType=function(){return a.getType()};this.update=function(){a.getType()==BUTTON&&(this.value=1-this.value);1==this.value?a.update(1):0==this.value?a.update(0):a.update(this.value)}};function OntologyLoader2(a,d,b){};function DymoLoader(a,d,b){function c(e,l,b,d,g){var h=new XMLHttpRequest;h.addEventListener("load",function(){l=l?l.replace('"'+e+'"',this.responseText):this.responseText;var a=f(l);a?c(a,l,b,d,g):d(g(JSON.parse(l),b))});h.open("GET",a.getDymoBasePath()+e);h.send()}function f(e){var a=e.indexOf(".json");if(0<=a){if(a!=e.indexOf("context.json")+7){var c=e.substring(0,a).lastIndexOf('"');return e.substring(c+1,a+5)}return f(e.substring(a+1))}}function h(e,a){var c=g(e,a);k(e,a);return[c,a]}function g(e,
c){var b=new DynamicMusicObject(e["@id"],a,e.ct);c[e["@id"]]=b;b.setSourcePath(e.source);e.navigator&&b.setNavigator(q(e.navigator,b));for(var d in e)0>v.indexOf(d)&&(e[d].type==FEATURE?b.setFeature(d,e[d].value):e[d].type==PARAMETER&&u(b,d,e[d].value));if(e.parts)for(d=0;d<e.parts.length;d++)b.addPart(g(e.parts[d],c));return b}function k(e,a){var c=a[e["@id"]];if(e.similars)for(var b=0;b<e.similars.length;b++)c.addSimilar(a[e.similars[b]]);if(e.mappings)for(b=0;b<e.mappings.length;b++)c.addMapping(n(e.mappings[b],
a,c));if(e.parts)for(b=0;b<e.parts.length;b++)k(e.parts[b],a)}function m(e,a){for(var c=new Rendering(a[e.topDymo]),b={},d=0;d<e.mappings.length;d++)c.addMapping(n(e.mappings[d],a,void 0,b));return[c,b]}function n(e,a,c,b){if(e.controls){for(var d=[],f=0;f<e.controls.length;f++)d.push(b[e.controls[f]]);return p(e,a,c,d,b)}if(e.dymos){var d=[],g;if(e.dymos instanceof Array)for(f=0;f<e.dymos.length;f++)d.push(a[e.dymos[f]]);else g=e.dymos,f=Object.keys(a).map(function(e){return a[e]}),Array.prototype.push.apply(d,
f.filter(eval(e.dymos)));return p(e,a,c,d,b,g)}}function p(e,a,c,b,d,f){a=e.relative;for(var g=[],h=0;h<e.domainDims.length;h++){var k=e.domainDims[h].name,n=e.domainDims[h].type;n!=FEATURE&&(n==PARAMETER?k=c?u(c,k,0):new Parameter(k,0):d?(d[k]||(d[k]=w(n,k)),k=d[k]):k=w(n,k));g.push(k)}return new Mapping(g,a,e["function"],b,e.parameter,f)}function u(e,a,c){var b=e.getParameter(a);b?b.update(c):(b=new Parameter(a,c),e.addParameter(b));return b}function x(e,a){for(var c=0;c<e.length;c++)if(e[c])for(var b=
0;b<e[c].length;b++){var d=a["dymo"+c],f=a["dymo"+e[c][b]];d&&f&&d.addSimilar(f)}}function q(e,a){return e==SIMILARITY_NAVIGATOR?new SimilarityNavigator(a):new SequentialNavigator(a)}function w(e,a,c){if(e==ACCELEROMETER_X)return y(0);if(e==ACCELEROMETER_Y)return y(1);if(e==ACCELEROMETER_Z)return y(2);if(e==TILT_X)return y(3);if(e==TILT_Y)return y(4);if(e==GEOLOCATION_LATITUDE)return t(0);if(e==GEOLOCATION_LONGITUDE)return t(1);if(e==GEOLOCATION_DISTANCE)return t(2);if(e==COMPASS_HEADING)return d.compassWatcher||
(d.compassWatcher=new CompassWatcher(d)),e=d.compassWatcher.headingControl,e;if(e==SLIDER||e==TOGGLE||e==BUTTON)return new Control(a,e);if(e==RANDOM)return e=(new StatsControls).randomControl,e;if(e==BROWNIAN)return e=(new BrownianControls).brownianControl,e;if(e==RAMP)return e=(new RampControls).linearRampControl,e}function y(e){d.accelerometerWatcher||(d.accelerometerWatcher=new AccelerometerWatcher(d));if(0==e)return d.accelerometerWatcher.xControl;if(1==e)return d.accelerometerWatcher.yControl;
if(2==e)return d.accelerometerWatcher.zControl;if(3==e)return d.accelerometerWatcher.tiltXControl;if(4==e)return d.accelerometerWatcher.tiltYControl}function t(e){d.geolocationWatcher||(d.geolocationWatcher=new GeolocationWatcher(d));return 0==e?d.geolocationWatcher.latitudeControl:1==e?d.geolocationWatcher.longitudeControl:d.geolocationWatcher.distanceControl}var v="@id @type ct source navigator similars mappings parts".split(" ");this.loadDymoFromJson=function(e,b,d){a.setDymoBasePath(e);c(b,"",
{},d,h)};this.parseDymoFromJson=function(e,a){a(h(e,{}))};this.loadRenderingFromJson=function(e,a,b){c(e,"",a,b,m)};this.loadGraphFromJson=function(e,a,b){c(e,"",a,b,x)}};function DymoWriter(a){function d(c,b){a.post(b,c).success(function(a){console.log("written json to "+b)})}function b(a){a.addTriple("_:","http://www.w3.org/1999/02/22-rdf-syntax-ns#type","dmo:DMO");a.addTriple("_:","ch:hasPart","ch:test2")}this.writeDymoToJson=function(a,b,h){a["@context"]="http://purl.org/ontology/dymo/context.json";h||(h="dymo.json");d(a,b+h)};this.writeRenderingToJson=function(a,b){d(a,b+"rendering.json")};this.writeDmoToRdf=function(a){a=N3.Writer({prefixes:{ch:"rdf/charm.n3#"}});
a=N3.Writer({prefixes:{dmo:"rdf/dmo.n3#"}});a=N3.Writer({prefixes:{mb:"rdf/mobile.n3#"}});b(a);a.end(function(a,b){console.log(b)})}};var DYMO="Dymo",PARALLEL="parallel",SEQUENTIAL="sequential",DYMO_TYPES=[PARALLEL,SEQUENTIAL],FEATURE="Feature",PARAMETER="Parameter",SEQUENTIAL_NAVIGATOR="SequentialNavigator",SIMILARITY_NAVIGATOR="SimilarityNavigator",PLAY="Play",LOOP="Loop",ONSET="Onset",DURATION_RATIO="DurationRatio",AMPLITUDE="Amplitude",PLAYBACK_RATE="PlaybackRate",TIME_STRETCH_RATIO="TimeStretchRatio",PAN="Pan",DISTANCE="Distance",HEIGHT="Height",REVERB="Reverb",FILTER="Filter",PART_INDEX="PartIndex",PART_COUNT="PartCount",
PART_ORDER="PartOrder",LISTENER_ORIENTATION="ListenerOrientation",STATS_FREQUENCY="StatsFrequency",BROWNIAN_FREQUENCY="BrownianFrequency",BROWNIAN_MAX_STEP_SIZE="BrownianMaxStepSize",RAMP_TRIGGER="RampTrigger",LEAPING_PROBABILITY="LeapingProbability",CONTINUE_AFTER_LEAPING="ContinueAfterLeaping",PARAMETERS=[PLAY,LOOP,ONSET,DURATION_RATIO,AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,PAN,DISTANCE,HEIGHT,REVERB,FILTER,PART_INDEX,PART_COUNT,PART_ORDER,LISTENER_ORIENTATION,STATS_FREQUENCY],LEVEL="level",
INDEX="index",ONSET_FEATURE="onset",PITCH_FEATURE="pitch",DURATION_FEATURE="duration",AUTO_CONTROL="AutoControl",SLIDER="Slider",TOGGLE="Toggle",BUTTON="Button",ACCELEROMETER_X="AccelerometerX",ACCELEROMETER_Y="AccelerometerY",ACCELEROMETER_Z="AccelerometerZ",TILT_X="TiltX",TILT_Y="TiltY",GEOLOCATION_LATITUDE="GeolocationLatitude",GEOLOCATION_LONGITUDE="GeolocationLongitude",GEOLOCATION_DISTANCE="GeolocationDistance",COMPASS_HEADING="CompassHeading",RANDOM="Random",BROWNIAN="Brownian",RAMP="Ramp",
CONTROLS=[SLIDER,TOGGLE,ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,COMPASS_HEADING,RANDOM,BROWNIAN,RAMP],UI_CONTROLS=[SLIDER,TOGGLE,BUTTON];function Control(a,d,b){function c(a,b){if(void 0==h||1E-6<Math.abs(a-h))h=a,f(b)}function f(a){for(var b=0;b<m.length;b++)m[b]!=a&&m[b].updateParameter(h,this)}var h,g,k,m=[],n,p,u;this.getName=function(){return a};this.getParameter=function(a){if(b)return b[a]};this.getValue=function(){return h};this.getType=function(){return d};this.getReferenceValue=function(){return g};this.setReferenceAverageCount=function(a){k=a;this.resetReferenceValue()};this.resetReferenceValue=function(){g=h=void 0;p=n=
0};this.setUpdateFunction=function(a){u=a};this.addMapping=function(a){m.push(a);a.updateParameter(h,this)};this.removeMapping=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.backpropagate=function(a,b){isFinite(a)&&(c(a,b),u&&u(h))};this.update=function(a){k&&n<k?(p+=a,n++,n==k&&(g=p/=k)):isNaN(a)||(g&&(a-=g),c(a))}};function DynamicMusicObject(a,d,b){function c(e,a){a[e.getUri()]=e;for(var b=0;b<e.getParts().length;b++)c(e.getParts()[b],a)}function f(a,b,c,d){var g=a-b,h=d.getParts();if(d.getLevel()==c&&0==g)return d;if(d.getLevel()>=c-1)return g<h.length?h[g]:b+h.length;for(d=0;d<h.length;d++)if(b=f(a,b,c,h[d]),isNaN(b))return b}function h(a,b,c){var d=b.toFlatJson();a.nodes.push(d);c&&a.links.push(k(c,d));for(c=0;c<b.getParts().length;c++)h(a,b.getParts()[c],d)}function g(a,b,c){c||(c={});c[b.getUri()]||(c[b.getUri()]=
b.toFlatJson());var d=c[b.getUri()];a.nodes.push(d);for(var f=0;f<b.getSimilars().length;f++){var h=b.getSimilars()[f];c[h.getUri()]||(c[h.getUri()]=h.toFlatJson());a.links.push(k(d,c[h.getUri()]))}for(f=0;f<b.getParts().length;f++)g(a,b.getParts()[f],c)}function k(a,b){return{source:a,target:b,value:1}}var m=this,n=null,p=[],u=[],x={},q={},w=[],y=[],t;q[PLAY]=new Parameter(PLAY,0,!0);q[LOOP]=new Parameter(LOOP,0,!0);q[ONSET]=new Parameter(ONSET,-1);q[DURATION_RATIO]=new Parameter(DURATION_RATIO,
1);q[AMPLITUDE]=new Parameter(AMPLITUDE,1);q[PLAYBACK_RATE]=new Parameter(PLAYBACK_RATE,1);q[TIME_STRETCH_RATIO]=new Parameter(TIME_STRETCH_RATIO,1);q[PAN]=new Parameter(PAN,0);q[DISTANCE]=new Parameter(DISTANCE,0);q[HEIGHT]=new Parameter(HEIGHT,0);q[REVERB]=new Parameter(REVERB,0);q[FILTER]=new Parameter(FILTER,0);q[PART_INDEX]=new Parameter(PART_INDEX,0,!0);q[PART_COUNT]=new Parameter(PART_COUNT,Number.POSITIVE_INFINITY,!0);q[PLAY].addObserver(m);q[PART_INDEX].addObserver(m);q[PART_COUNT].addObserver(m);
var v=new SequentialNavigator(this);this.setType=function(a){b=a};this.getType=function(){return b};this.getUri=function(){return a};this.setParent=function(a){n=a;for(var b in q)b!=PLAY&&b!=PART_COUNT&&b!=PART_INDEX&&y.push(new Mapping([a.getParameter(b)],!0,void 0,[this],b));a=n.getMappings();var c=this.getDymoMap(),c=Object.keys(c).map(function(a){return c[a]});for(b=0;b<a.length;b++){var d=a[b].getDymoConstraint();d&&(d=a[b].getTargets().concat(c.filter(eval(d))),a[b].setTargets(d))}};this.removeParent=
function(){for(var a=0;a<y.length;a++)y[a].disconnect();y=[];for(var b=n.getMappings(),c=this,a=0;a<b.length;a++){var d=b[a].getTargets(),d=d.filter(function(a){return!a.isSubDymoOf(c)});b[a].setTargets(d)}n=null};this.getParent=function(){return n};this.isSubDymoOf=function(a){for(var b=this;b;){if(b==a)return!0;b=b.getParent()}return!1};this.getDymoMap=function(){var a={};c(this,a);return a};this.getLevel=function(){return n?n.getLevel()+1:0};this.getIndex=function(){if(n)return n.getParts().indexOf(this)};
this.addPart=function(a){p.push(a);a.setParent(this)};this.removePart=function(a){p.splice(p.indexOf(a));a.removeParent(this)};this.replacePart=function(a,b){p[a]&&p[a].removeParent(this);p[a]=b;b.setParent(this)};this.getPart=function(a){return p[a]};this.getParts=function(){return p};this.getNthPart=function(a,b){return f(a,0,b,this)};this.setSourcePath=function(a){(t=a)&&d&&d.addSourceFile(a)};this.getSourcePath=function(){return n&&!t?n.getSourcePath():t};this.addSimilar=function(a){u.push(a)};
this.getSimilars=function(a){return u};this.getFeatures=function(){return x};this.setFeature=function(a,b){x[a]=b};this.getFeature=function(a){if(a===LEVEL)return this.getLevel();if(a===INDEX)return this.getIndex();if(x.hasOwnProperty(a))return x[a];if(n)return n.getFeature(a);for(var b=[],c=0;c<p.length;c++)if(p[c]){var d=p[c].getFeatureWithoutLookingFurther(a);isNaN(d)||b.push(d)}if(0<b.length)return b};this.getFeatureWithoutLookingFurther=function(a){if(x[a])return x[a]};this.getMappings=function(){return w};
this.getSegment=function(){return[this.getFeature("time"),q[DURATION_RATIO].getValue()*this.getFeature("duration")]};this.addParameter=function(a){q[a.getName()]=a};this.getParameter=function(a){return a==LISTENER_ORIENTATION?d.listenerOrientation:a==PART_ORDER?void 0:q[a]};this.addMapping=function(a){w.push(a)};this.observedParameterChanged=function(a){a.getName()==PLAY&&(0<a.getChange()?d.play(m):d.stop(m))};this.setNavigator=function(a){v=a};this.getNavigator=function(){return v};this.resetPartsPlayed=
function(){v.resetPartsPlayed();for(var a=0;a<p.length;a++)p[a].resetPartsPlayed()};this.updatePartOrder=function(a){p&&p[0]&&!isNaN(p[0].getFeature(a))?p.sort(function(b,c){return b.getFeature(a)-c.getFeature(a)}):p&&p.sort(function(b,c){return b.getParameter(a).getValue()-c.getParameter(a).getValue()})};this.getNextParts=function(){return v.getNextParts()};this.toJsonHierarchy=function(){for(var a=this.toFlatJson(),b=0;b<p.length;b++)a.parts.push(p[b].toJsonHierarchy());return a};this.toJsonHierarchyGraph=
function(){var a={nodes:[],links:[]};h(a,this);return a};this.toJsonSimilarityGraph=function(){var a={nodes:[],links:[]};g(a,this);return a};this.toFlatJson=function(){var c={"@id":a,"@type":DYMO};b&&(c.ct=b);t&&(c.source=t);v instanceof SimilarityNavigator&&(c.navigator=SIMILARITY_NAVIGATOR);for(var d in x)c[d]=this.getFeatureJson(d);if(0<w.length)for(c.mappings=[],d=0;d<w.length;d++)c.mappings.push(w[d].toJson());0<p.length&&(c.parts=[]);if(0<u.length)for(c.similars=[],d=0;d<u.length;d++)c.similars.push(u[d].getUri());
return c};this.getFeatureJson=function(a){return{value:x[a],type:FEATURE,adt:a.charAt(0).toUpperCase()+a.slice(1)}}};function LinearFunction(){this.getValue=function(a){return a}}function TriangleFunction(a,d){this.getValue=function(b){b=Math.abs(a-b);return b<d?1-b/d:0}}function RectangleFunction(a,d){this.getValue=function(b){return Math.abs(a-b)<d?1:0}};function Mapping(a,d,b,c,f,h){function g(b){for(var c=[],f=0;f<a.length;f++){var g;g="string"===typeof a[f]||a[f]instanceof String?b.getFeature(a[f]):d?a[f].getChange():a[f].getValue();c[f]=g}return m.apply(this,c)}var k=new FunctionInverter;b||(b='new Function("a", "return a;");');var m=eval(b),n,p=k.invert(k.toReturnValueString(b));p&&(n=eval(k.toJavaScriptFunctionString(p)));this.getTargets=function(){return c};this.setTargets=function(a){c=a;for(a=0;a<c.length;a++)c[a].getParameter(f).addUpdater(this)};
this.getDymoConstraint=function(){return h};this.disconnect=function(){for(var b=0;b<a.length;b++)a[b].removeMapping?a[b].removeMapping(this):a[b].removeObserver&&a[b].removeObserver(this);for(b=0;b<c.length;b++)c[b].getParameter(f).removeUpdater(this)};this.updateParameter=function(){for(var a=0;a<c.length;a++)d?c[a].getParameter(f).relativeUpdate(g(c[a]),this):c[a].getParameter(f).update(g(c[a]),this)};this.observedParameterChanged=function(a){this.updateParameter()};this.updatedParameterChanged=
function(b){a[0].backpropagate&&!d&&(n&&(b=n(b)),a[0].backpropagate(b,this))};this.requestValue=function(b){for(var c=0;c<a.length;c++)a[c].requestValue&&a[c].requestValue();return g(b)};this.toJson=function(){for(var d=[],g=0;g<a.length;g++)a[g]instanceof Control?d.push({name:a[g].getName(),type:a[g].getType()}):a[g]instanceof Parameter?d.push({name:a[g].getName(),type:"Parameter"}):d.push({name:a[g],type:"Feature"});var d={domainDims:d,"function":b},g=c.filter(function(a){return a instanceof DynamicMusicObject}).map(function(a){return a.getUri()}),
h=c.filter(function(a){return!(a instanceof DynamicMusicObject)}).map(function(a){return a.getUri()});0<g.length&&(d.dymos=g);0<h.length&&(d.controls=h);d.parameter=f;return d};for(k=0;k<a.length;k++)a[k].addMapping?a[k].addMapping(this):a[k].addObserver&&a[k].addObserver(this);for(k=0;k<c.length;k++)c[k].getParameter(f).addUpdater(this)};function Parameter(a,d,b){function c(a,c){if(!isNaN(c)&&(b&&(c=Math.round(c)),1E-6<Math.abs(c-h))){g=c-h;h=c;for(var d=0;d<k.length;d++)k[d]!=a&&k[d].updatedParameterChanged(h);if(g)for(d=0;d<m.length;d++)m[d].observedParameterChanged(f)}}var f=this,h=d,g=0,k=[],m=[];this.getName=function(){return a};this.getValue=function(){return h};this.getChange=function(){return g};this.addUpdater=function(a){0>k.indexOf(a)&&(k.push(a),a.updatedParameterChanged(h))};this.removeUpdater=function(a){a=k.indexOf(a);
-1<a&&k.splice(a,1)};this.addObserver=function(a){m.push(a)};this.removeObserver=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.getObservers=function(){return m};this.update=function(a,b){c(b,a)};this.relativeUpdate=function(a,b){this.update(h+a,b)};this.requestValue=function(){for(var a=0;a<this.updaters.length;a++){var b=k[a].requestValue();if(b&&b!=h){c(k[a],b);break}}return h}};function Rendering(a){var d=[];this.play=function(){a&&a.getParameter(PLAY).update(1)};this.stop=function(){a&&a.getParameter(PLAY).update(0)};this.addMapping=function(a){d.push(a);a.updateParameter()};this.getMappings=function(){return d};this.toJson=function(){var b={mappings:[]};a&&(b.topDymo=a.getUri());for(var c=0;c<d.length;c++)b.mappings.push(d[c].toJson());return b}};function FunctionInverter(){function a(a){if(a.isOperatorNode||a.isParenthesisNode||a.isSymbolNode)return a}function d(a){if("+"==a)return"-";if("-"==a)return"+";if("*"==a)return"/";if("/"==a)return"*"}function b(a){if("+"==a)return"add";if("-"==a)return"subtract";if("*"==a)return"multiply";if("/"==a)return"divide"}this.invert=function(c){var f;try{f=math.parse(c)}catch(k){!k instanceof SyntaxError&&console.log(k);return}for(var h=c=new math.expression.node.SymbolNode("a");f;)if(f.isSymbolNode)c.name=
f.name,f=void 0;else if(f.isParenthesisNode)f=f.content;else if(f.isOperatorNode){var g=d(f.op);if("+"==f.op||"*"==f.op)if(f.args[0].isConstantNode)h=new math.expression.node.OperatorNode(g,b(g),[h,f.args[0]]),f=a(f.args[1]);else if(f.args[1].isConstantNode)h=new math.expression.node.OperatorNode(g,b(g),[h,f.args[1]]),f=a(f.args[0]);else return;else if("-"==f.op||"/"==f.op)if(f.args[0].isConstantNode)h=new math.expression.node.OperatorNode(f.op,b(f.op),[f.args[0],h]),f=a(f.args[1]);else if(f.args[1].isConstantNode)h=
new math.expression.node.OperatorNode(g,b(g),[h,f.args[1]]),f=a(f.args[0]);else return}else return;return h.toString()};this.toJavaScriptFunctionString=function(a){return'new Function("a", "return '+a+';");'};this.toReturnValueString=function(a){return a.substring(a.indexOf("return ")+7,a.indexOf(";"))}};function PolygonTools(){}PolygonTools.isPointInPolygon=function(a,d){for(var b=!1,c=-1,f=a.length,h=f-1;++c<f;h=c)(a[c][1]<=d[1]&&d[1]<a[h][1]||a[h][1]<=d[1]&&d[1]<a[c][1])&&d[0]<(a[h][0]-a[c][0])*(d[1]-a[c][1])/(a[h][1]-a[c][1])+a[c][0]&&(b=!b);return b};PolygonTools.getArea=function(a){var d=0,b,c,f=0;for(c=a.length-1;f<a.length;c=f,f++)b=a[f],c=a[c],d+=b[0]*c[1],d-=b[1]*c[0];return d/2};
PolygonTools.getCentroid=function(a){var d,b,c,f=0,h=0,g=0;for(b=a.length-1;g<a.length;b=g,g++)d=a[g],b=a[b],c=d[0]*b[1]-b[0]*d[1],f+=(d[0]+b[0])*c,h+=(d[1]+b[1])*c;c=6*PolygonTools.getArea(a);return{0:f/c,1:h/c}};function sqDist(a,d){return Math.pow(a[0]-d[0],2)+Math.pow(a[1]-d[1],2)}
PolygonTools.getDistanceFromSegment=function(a,d,b){var c=sqDist(d,b);if(0==c)return sqDist(a,d);c=((a[0]-d[0])*(b[0]-d[0])+(a[1]-d[1])*(b[1]-d[1]))/c;return 0>c?sqDist(a,d):1<c?sqDist(a,b):Math.sqrt(sqDist(a,{0:d[0]+c*(b[0]-d[0]),1:d[1]+c*(b[1]-d[1])}))};PolygonTools.getMinDistanceFromEdge=function(a,d){for(var b=Number.POSITIVE_INFINITY,c=0;c<a.length;c++)var f=PolygonTools.getDistanceFromSegment(d,a[c],a[(c+1)%a.length]),b=Math.min(f,b);return b};
PolygonTools.howFarIsPointInPolygon=function(a,d,b){return PolygonTools.isPointInPolygon(a,b)?(d=Math.sqrt(Math.pow(b[0]-d[0],2)+Math.pow(b[1]-d[1],2)),a=PolygonTools.getMinDistanceFromEdge(a,b),Math.sqrt((1-d)*a/Math.abs(d+a))):0};PolygonTools.getPolygonFunctionString=function(a){return'new Function("a", "b", "return PolygonTools.isPointInPolygon('+getPolygonOrPointString(a)+', {0:a, 1:b});");'};
PolygonTools.getInterpolatedPolygonFunctionString=function(a){var d=getPolygonOrPointString(a);a=getPolygonOrPointString(PolygonTools.getCentroid(a));return'new Function("a", "b", "return PolygonTools.howFarIsPointInPolygon('+d+","+a+', {0:a, 1:b});");'};function getPolygonOrPointString(a){return JSON.stringify(a).replace(/"/g,"'")};function SequentialNavigator(a){var d=!1,b=0;this.resetPartsPlayed=function(){b=0};this.setPartsPlayed=function(a){b=a};this.getPartsPlayed=function(){return b};this.getNextParts=function(){var c=a.getParts();if(0<c.length){if(a.getType()==PARALLEL){for(var f=[],h=0;h<c.length;h++){var g=c[h].getNextParts();g&&(!g.length||0<g.length)&&(f=f.concat(g))}if(0<f.length)return console.log(f.map(function(a){return a.getIndex()})),f}else for(d=!0;b<c.length&&b<a.getParameter(PART_COUNT).getValue();){if((g=
c[b].getNextParts())&&(!g.length||0<g.length))return!g instanceof Array&&(g=[g]),g;b++}b=0;d=!1;return null}if(d)return d=!1,null;d=!0;return[a]}};function SimilarityNavigator(a){function d(c){for(var d=0;d<c.length;d++)if(0<c[d].getSimilars().length&&Math.random()<b.leapingProbability.getValue()){var k=c[d].getSimilars(),m=Math.floor(Math.random()*k.length);if(b.continueAfterLeaping.getValue()){var n=a.getParts().indexOf(m);n&&(f=n+1)}c[d]=k[m]}}var b=this,c=!1,f=0;this.leapingProbability=new Parameter(LEAPING_PROBABILITY,.5);this.continueAfterLeaping=new Parameter(CONTINUE_AFTER_LEAPING,0,!0);this.resetPartsPlayed=function(){f=0};this.getNextParts=
function(){var b=a.getParts();if(0<b.length){if(a.getType()==PARALLEL){for(var g=[],k=0;k<b.length;k++){var m=b[k].getNextParts();m&&(!m.length||0<m.length)&&(g=g.concat(m))}if(0<g.length)return d(g),g}else for(c=!0;f<b.length&&f<a.getParameter(PART_COUNT).getValue();){if((m=b[f].getNextParts())&&(!m.length||0<m.length))return!m instanceof Array&&(m=[m]),d(m),m;f++}f=0;c=!1;return null}if(c)return c=!1,null;c=!0;return[a]}};
