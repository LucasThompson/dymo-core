function AudioProcessor(b){function f(b){return{extract:function(a,e,f){for(var h=[],k=0;k<b.numberOfChannels;k++)h.push(b.getChannelData(k));for(k=0;k<e;k++)for(var m=0;m<h.length;m++)a[k*h.length+m%h.length]=h[m][k+f];return Math.min(e,h[0].length-f)}}}this.timeStretch=function(c,a){var e=new SoundTouch(c.sampleRate);e.tempo=a;for(var g=f(c),e=new SimpleFilter(g,e),g=b.createBuffer(c.numberOfChannels,1/a*c.length,c.sampleRate),h=[],k=0;k<c.numberOfChannels;k++)h.push(g.getChannelData(k));for(var m=
new Float32Array(2048),n=e.extract(m,1024),p=0;n;){for(k=0;k<n;k++)for(var u=0;u<h.length;u++)h[u][k+p]=m[k*h.length+u%h.length];p+=n;n=e.extract(m,1024)}return g}};function AudioProcessorSource(b,f,c){var a=this,e=new SoundTouch(f.sampleRate);this.stretchRatio={setValue:function(b){e.tempo=b},getValue:function(){return e.tempo}};this.playbackRate={setValue:function(b){e.rate=b},getValue:function(){return e.rate}};var g=new SimpleFilter({extract:function(b,a,c){for(var e=[],g=0;g<f.numberOfChannels;g++)e.push(f.getChannelData(g));for(g=0;g<a;g++)for(var k=0;k<e.length;k++)b[g*e.length+k%e.length]=e[k][g+c];return Math.min(a,e[0].length-c)}},e),h=b.createScriptProcessor(1024,
2,f.numberOfChannels),k=new Float32Array(2048);h.onaudioprocess=function(b){for(var e=[],c=0;c<f.numberOfChannels;c++)e.push(b.outputBuffer.getChannelData(c));b=g.extract(k,1024);0==b&&a.stop();for(c=0;c<b;c++)for(var h=0;h<e.length;h++)e[h][c]=k[c*e.length+h%e.length]};this.start=function(b){setTimeout(function(){h.connect(c)},b)};this.stop=function(){h.disconnect()}};function Scheduler(b,f,c){function a(){0<l&&l--;0==l&&f&&f(l)}function e(d){var a=d.getUri(),c;if(w[a])for(c=y[a],l=0;l<c.length;l++)g(a,c[l].getDymo().getUri(),c[l]);else{c=n(d);w[a]={};for(var l=0;l<c.length;l++){var f=c[l].getDymo();g(a,f.getUri(),c[l]);v[a]=f.getParameter(ONSET).getValue()}}var h;h=t[a]?t[a]-b.currentTime:.1;f=b.currentTime+h;for(l=0;l<c.length;l++)c[l].play(f);setTimeout(function(){for(var d=[],a=0;a<c.length;a++)d.push(c[a].getDymo());m(d)},h);(l=n(d))?(y[a]=l,l=l[0].getDymo().getParameter(ONSET).getValue(),
h=l-v[a],-1!=l?(t[a]=f+h,v[a]=l):t[a]=f+c[0].getDuration()/c[0].getParameterValue(PLAYBACK_RATE),t[a]&&(r=setTimeout(function(){e(d)},1E3*(t[a]-b.currentTime-.1)))):(t[a]=f+c[0].getDuration()/c[0].getParameterValue(PLAYBACK_RATE),r=setTimeout(function(){k(d)},1E3*(t[a]-b.currentTime)))}function g(d,a,b){w[d][a]=b}function h(d,a){var b=w[d.getUri()];if(b)for(var l in b)b[l][a].call(b[l])}function k(d){window.clearTimeout(r);var a=d.getUri();w[a]=null;y[a]=null;t[a]=null;d.resetPartsPlayed();m([])}
function m(d){for(var a=[],b=0;b<d.length;b++)for(var l=d[b];null!=l;)0>a.indexOf(l.getUri())&&a.push(l.getUri()),l=l.getParent();u.urisOfPlayingDymos=a;c&&c()}function n(a){if(a=a.getNextParts()){for(var l=[],c=0;c<a.length;c++)if(a[c].getSourcePath()){var e=q[a[c].getSourcePath()];e&&l.push(new Source(a[c],b,e,d))}return l}}function p(d,a,c){l++;a.src=d;a.ctx=b;a.onload=c;a.onerror=function(){console.log("Error loading audio ",d)};a.send()}var u=this,x="",q={},w={},y={},t={},v={};this.urisOfPlayingDymos=
[];this.listenerOrientation=new Parameter(this,0);var d=b.createConvolver();d.connect(b.destination);var l=0,r;this.setReverbFile=function(b){var l=new AudioSampleLoader;p(b,l,function(){d.buffer=l.response;a()})};this.setDymoBasePath=function(d){x=d};this.getDymoBasePath=function(){return x};this.addSourceFile=function(d){if(!q[d]){var b=new AudioSampleLoader;p(x+d,b,function(){q[d]=b.response;a()})}};this.getBuffer=function(d){return q[d.getSourcePath()]};this.play=function(d){d.updatePartOrder(ONSET);
e(d)};this.pause=function(d){h(d,"pause")};this.stop=function(d){h(d,"stop");k(d)};this.getSources=function(d){return w[d.getUri()]};this.updateListenerOrientation=function(){var d=this.listenerOrientation.value/180*Math.PI;b.listener.setOrientation(Math.sin(d),0,-Math.cos(d),0,1,0)}};function Source(b,f,c,a){function e(d,a){h(d,a.getValue());a.addObserver(p)}function g(){for(var d=0;d<z.length;d++){var a=b.getParameter(z[d]);a&&a.removeObserver(p)}}function h(d,a,b){b&&(a+=p.getParameterValue(d));0>a&&0<=A.indexOf(d)&&(a=0);b=a;r[d]&&(r[d].value||0==r[d].value?r[d].value=b:r[d].setValue(b));0<=B.indexOf(d)?(0==r[DISTANCE].value&&(r[DISTANCE].value=-.01),y.setPosition(r[PAN].value,r[HEIGHT].value,r[DISTANCE].value)):d==LOOP&&(l.loop=1==a)}function k(){u=!1;var d=f.currentTime;
r[AMPLITUDE].setValueAtTime(r[AMPLITUDE].value,d);r[AMPLITUDE].linearRampToValueAtTime(0,d+.02);l.stop(d+.04)}function m(d,a){if(d||0==d)return Math.round(d*a.sampleRate)}function n(d,a,b){b=Math.min(d.length-a,b);for(var l=f.createBuffer(d.numberOfChannels,b,d.sampleRate),c=0;c<d.numberOfChannels;c++)for(var e=l.getChannelData(c),r=d.getChannelData(c),g=0;g<b;g++)e[g]=r[a+g];return l}var p=this,u,x,q=f.createGain();q.connect(f.destination);var w=f.createGain();w.connect(a);w.gain.value=0;q.connect(w);
var y=f.createPanner();y.connect(q);a=f.createBiquadFilter();a.type="lowpass";a.frequency.value=2E4;a.connect(y);var t=b.getSegment(),v=t[0],d=t[1];v||(v=0);d||(d=c.duration-v);t=b.getParameter(TIME_STRETCH_RATIO).getValue();if(1!=t){if(0!=v||d<c.duration)c=n(c,m(v,c),m(d+.3,c));c=(new AudioProcessor(f)).timeStretch(c,t);v=d/t;c=n(c,0,m(v+.02,c));d=v}else if(0!=v||d<c.duration)c=n(c,m(v,c),m(d+.02,c));(function(d,a){for(var b=.02*d.sampleRate,l=0;l<d.numberOfChannels;l++)for(var c=d.getChannelData(l),
e=0;e<b;e++)c[e]*=e/b,c[a-e-1]*=e/b})(c,c.length);var l=f.createBufferSource();l.connect(a);l.buffer=c;var r={};r[AMPLITUDE]=q.gain;r[PLAYBACK_RATE]=l.playbackRate;r[TIME_STRETCH_RATIO]={value:0};r[REVERB]=w.gain;r[FILTER]=a.frequency;r[PAN]={value:0};r[HEIGHT]={value:0};r[DISTANCE]={value:0};r[LOOP]={value:0};var z=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER,PAN,HEIGHT,DISTANCE,LOOP],A=[AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,REVERB,FILTER],B=[PAN,HEIGHT,DISTANCE];e(AMPLITUDE,b.getParameter(AMPLITUDE));
e(PLAYBACK_RATE,b.getParameter(PLAYBACK_RATE));e(TIME_STRETCH_RATIO,b.getParameter(TIME_STRETCH_RATIO));e(REVERB,b.getParameter(REVERB));e(PAN,b.getParameter(PAN));e(HEIGHT,b.getParameter(HEIGHT));e(DISTANCE,b.getParameter(DISTANCE));e(LOOP,b.getParameter(LOOP));this.observedParameterChanged=function(d){h(d.getName(),d.getChange(),!0)};this.getDymo=function(){return b};this.getDuration=function(){return d};this.isLoopingAndPlaying=function(){return l.loop&&u};this.getParameterValue=function(d){if(r[d])return r[d].value||
0==r[d].value?r[d].value:r[d].getValue()};this.play=function(d){l.onended=g;l.start(d);u=!0};this.pause=function(){u?(k(),x=!0):x&&(x=!1,this.play())};this.stop=function(){u&&(g(),k())}};function BrownianControls(){function b(){a=setInterval(function(){var a=c[BROWNIAN_MAX_STEP_SIZE].getValue(),a=2*a*Math.random()-a,a=f.brownianControl.getValue()+a,a=Math.min(Math.max(a,0),1);f.brownianControl.update(a)},c[BROWNIAN_FREQUENCY].getValue())}var f=this,c={};c[BROWNIAN_FREQUENCY]=new Parameter(BROWNIAN_FREQUENCY,100);c[BROWNIAN_FREQUENCY].addObserver(this);c[BROWNIAN_MAX_STEP_SIZE]=new Parameter(BROWNIAN_MAX_STEP_SIZE,.1);c[BROWNIAN_MAX_STEP_SIZE].addObserver(this);this.brownianControl=
new Control(BROWNIAN,AUTO_CONTROL,c);this.brownianControl.update(.5);var a;b();this.getParameter=function(a){return c[a]};this.observedParameterChanged=function(c){c.getName()==BROWNIAN_FREQUENCY&&(clearInterval(a),b())}};function RampControls(){function b(){h=setInterval(function(){var b=1/c.duration*c.frequency;e||(b*=-1);a+=b;0<a&&1>a?c.linearRampControl.update(a):1<=a?(c.linearRampControl.update(1),f()):0>=a&&(c.linearRampControl.update(0),f())},c.frequency)}function f(){clearInterval(h);h=void 0;e=!e}var c=this;this.frequency=100;this.duration=1E4;var a=0,e=!0,g={};g[RAMP_TRIGGER]=new Parameter(RAMP_TRIGGER,0);g[RAMP_TRIGGER].addObserver(this);this.linearRampControl=new Control(RAMP,AUTO_CONTROL,g);var h;this.getParameter=
function(a){return g[a]};this.observedParameterChanged=function(a){a.getName()==RAMP_TRIGGER&&(h?f():b())}};function StatsControls(){function b(){a=setInterval(function(){f.randomControl.update(Math.random())},c[STATS_FREQUENCY].getValue())}var f=this,c={};c[STATS_FREQUENCY]=new Parameter(STATS_FREQUENCY,300);c[STATS_FREQUENCY].addObserver(this);this.randomControl=new Control(RANDOM,AUTO_CONTROL,c);var a;b();this.getParameter=function(a){return c[a]};this.observedParameterChanged=function(c){c.getName()==STATS_FREQUENCY&&(clearInterval(a),b())}};function UIControl(b,f){var c=this;this.value=b.getValue();b.setUpdateFunction(function(a){c.value=a;f&&setTimeout(function(){f.$apply()},10)});this.getName=function(){return b.getName()};this.getType=function(){return b.getType()};this.update=function(){b.getType()==BUTTON&&(this.value=1-this.value);1==this.value?b.update(1):0==this.value?b.update(0):b.update(this.value)}};function OntologyLoader2(b,f,c){};function DymoLoader(b,f,c){function a(d,l,c,f,g){var h=new XMLHttpRequest;h.addEventListener("load",function(){l=l?l.replace('"'+d+'"',this.responseText):this.responseText;var b=e(l);b?a(b,l,c,f,g):f(g(JSON.parse(l),c))});h.open("GET",b.getDymoBasePath()+d);h.send()}function e(d){var a=d.indexOf(".json");if(0<=a){if(a!=d.indexOf("context.json")+7){var b=d.substring(0,a).lastIndexOf('"');return d.substring(b+1,a+5)}return e(d.substring(a+1))}}function g(d,a){var b=h(d,a);k(d,a);return[b,a]}function h(d,
a){var c=new DynamicMusicObject(d["@id"],b,d.ct);a[d["@id"]]=c;c.setSourcePath(d.source);d.navigator&&c.setNavigator(q(d.navigator,c));for(var e in d)0>v.indexOf(e)&&(d[e].type==FEATURE?c.setFeature(e,d[e].value):d[e].type==PARAMETER&&u(c,e,d[e].value));if(d.parts)for(e=0;e<d.parts.length;e++)c.addPart(h(d.parts[e],a));return c}function k(d,a){var b=a[d["@id"]];if(d.similars)for(var c=0;c<d.similars.length;c++)b.addSimilar(a[d.similars[c]]);if(d.mappings)for(c=0;c<d.mappings.length;c++)b.addMapping(n(d.mappings[c],
a,b));if(d.parts)for(c=0;c<d.parts.length;c++)k(d.parts[c],a)}function m(d,a){for(var b=new Rendering(a[d.topDymo]),c={},e=0;e<d.mappings.length;e++)b.addMapping(n(d.mappings[e],a,void 0,c));return[b,c]}function n(d,a,b,c){if(d.controls){for(var e=[],f=0;f<d.controls.length;f++)e.push(c[d.controls[f]]);return p(d,a,b,e,c)}if(d.dymos){var e=[],g;if(d.dymos instanceof Array)for(f=0;f<d.dymos.length;f++)e.push(a[d.dymos[f]]);else g=Function.apply(null,d.dymos),f=Object.keys(a).map(function(d){return a[d]}),
Array.prototype.push.apply(e,f.filter(g));return p(d,a,b,e,c,g)}}function p(d,a,b,c,e,f){a=d.relative;for(var g=[],h=0;h<d.domainDims.length;h++){var k=d.domainDims[h].name,n=d.domainDims[h].type;n!=FEATURE&&(n==PARAMETER?k=b?u(b,k,0):new Parameter(k,0):e?(e[k]||(e[k]=w(n,k)),k=e[k]):k=w(n,k));g.push(k)}return new Mapping(g,a,d["function"],c,d.parameter,f)}function u(d,a,b){var c=d.getParameter(a);c?c.update(b):(c=new Parameter(a,b),d.addParameter(c));return c}function x(d,a){for(var b=0;b<d.length;b++)if(d[b])for(var c=
0;c<d[b].length;c++){var e=a["dymo"+b],f=a["dymo"+d[b][c]];e&&f&&e.addSimilar(f)}}function q(d,a){return d==SIMILARITY_NAVIGATOR?new SimilarityNavigator(a):new SequentialNavigator(a)}function w(d,a){if(d==ACCELEROMETER_X)return y(0);if(d==ACCELEROMETER_Y)return y(1);if(d==ACCELEROMETER_Z)return y(2);if(d==TILT_X)return y(3);if(d==TILT_Y)return y(4);if(d==GEOLOCATION_LATITUDE)return t(0);if(d==GEOLOCATION_LONGITUDE)return t(1);if(d==GEOLOCATION_DISTANCE)return t(2);if(d==COMPASS_HEADING){var b;f.compassWatcher||
(f.compassWatcher=new CompassWatcher);b=f.compassWatcher.headingControl;return b}if(d==SLIDER||d==TOGGLE||d==BUTTON)return new Control(a,d);if(d==RANDOM)return b=(new StatsControls).randomControl,b;if(d==BROWNIAN)return b=(new BrownianControls).brownianControl,b;if(d==RAMP)return b=(new RampControls).linearRampControl,b}function y(d){f.accelerometerWatcher||(f.accelerometerWatcher=new AccelerometerWatcher);if(0==d)return f.accelerometerWatcher.xControl;if(1==d)return f.accelerometerWatcher.yControl;
if(2==d)return f.accelerometerWatcher.zControl;if(3==d)return f.accelerometerWatcher.tiltXControl;if(4==d)return f.accelerometerWatcher.tiltYControl}function t(d){f.geolocationWatcher||(f.geolocationWatcher=new GeolocationWatcher);return 0==d?f.geolocationWatcher.latitudeControl:1==d?f.geolocationWatcher.longitudeControl:f.geolocationWatcher.distanceControl}var v="@id @type ct source navigator similars mappings parts".split(" ");this.loadDymoFromJson=function(d,c,e){b.setDymoBasePath(d);a(c,"",{},
e,g)};this.parseDymoFromJson=function(d,a){a(g(d,{}))};this.loadRenderingFromJson=function(d,b,c){a(d,"",b,c,m)};this.loadGraphFromJson=function(d,b,c){a(d,"",b,c,x)}};function DymoWriter(b){function f(a){a.addTriple("_:","http://www.w3.org/1999/02/22-rdf-syntax-ns#type","dmo:DMO");a.addTriple("_:","ch:hasPart","ch:test2")}function c(a,b){var c=new XMLHttpRequest;c.send(b);c.addEventListener("save",function(){console.log("saved "+a)});c.addEventListener("error",function(){console.log("saving "+a+" failed")});c.open("POST",a);c.send()}this.writeDymoToJson=function(a,b,f){a["@context"]="http://purl.org/ontology/dymo/context.json";f||(f="dymo.json");c(b+f,a)};this.writeRenderingToJson=
function(a,b){c(b+"rendering.json",a)};this.writeDmoToRdf=function(a){a=N3.Writer({prefixes:{ch:"rdf/charm.n3#",dmo:"rdf/dmo.n3#",mb:"rdf/mobile.n3#"}});f(a);a.end(function(a,b){console.log(b)})}};var DYMO="Dymo",PARALLEL="parallel",SEQUENTIAL="sequential",DYMO_TYPES=[PARALLEL,SEQUENTIAL],FEATURE="Feature",PARAMETER="Parameter",SEQUENTIAL_NAVIGATOR="SequentialNavigator",SIMILARITY_NAVIGATOR="SimilarityNavigator",PLAY="Play",LOOP="Loop",ONSET="Onset",DURATION_RATIO="DurationRatio",AMPLITUDE="Amplitude",PLAYBACK_RATE="PlaybackRate",TIME_STRETCH_RATIO="TimeStretchRatio",PAN="Pan",DISTANCE="Distance",HEIGHT="Height",REVERB="Reverb",FILTER="Filter",PART_INDEX="PartIndex",PART_COUNT="PartCount",
PART_ORDER="PartOrder",LISTENER_ORIENTATION="ListenerOrientation",STATS_FREQUENCY="StatsFrequency",BROWNIAN_FREQUENCY="BrownianFrequency",BROWNIAN_MAX_STEP_SIZE="BrownianMaxStepSize",RAMP_TRIGGER="RampTrigger",LEAPING_PROBABILITY="LeapingProbability",CONTINUE_AFTER_LEAPING="ContinueAfterLeaping",PARAMETERS=[PLAY,LOOP,ONSET,DURATION_RATIO,AMPLITUDE,PLAYBACK_RATE,TIME_STRETCH_RATIO,PAN,DISTANCE,HEIGHT,REVERB,FILTER,PART_INDEX,PART_COUNT,PART_ORDER,LISTENER_ORIENTATION,STATS_FREQUENCY],LEVEL="level",
INDEX="index",ONSET_FEATURE="onset",PITCH_FEATURE="pitch",DURATION_FEATURE="duration",AUTO_CONTROL="AutoControl",SLIDER="Slider",TOGGLE="Toggle",BUTTON="Button",ACCELEROMETER_X="AccelerometerX",ACCELEROMETER_Y="AccelerometerY",ACCELEROMETER_Z="AccelerometerZ",TILT_X="TiltX",TILT_Y="TiltY",GEOLOCATION_LATITUDE="GeolocationLatitude",GEOLOCATION_LONGITUDE="GeolocationLongitude",GEOLOCATION_DISTANCE="GeolocationDistance",COMPASS_HEADING="CompassHeading",RANDOM="Random",BROWNIAN="Brownian",RAMP="Ramp",
CONTROLS=[SLIDER,TOGGLE,ACCELEROMETER_X,ACCELEROMETER_Y,ACCELEROMETER_Z,TILT_X,TILT_Y,GEOLOCATION_LATITUDE,GEOLOCATION_LONGITUDE,GEOLOCATION_DISTANCE,COMPASS_HEADING,RANDOM,BROWNIAN,RAMP],UI_CONTROLS=[SLIDER,TOGGLE,BUTTON];function Control(b,f,c){function a(a,b){if(void 0==g||1E-6<Math.abs(a-g))g=a,e(b)}function e(a){for(var b=0;b<m.length;b++)m[b]!=a&&m[b].updateParameter(g,this)}var g,h,k,m=[],n,p,u;this.getName=function(){return b};this.getParameter=function(a){if(c)return c[a]};this.getValue=function(){return g};this.getType=function(){return f};this.getReferenceValue=function(){return h};this.setReferenceAverageCount=function(a){k=a;this.resetReferenceValue()};this.resetReferenceValue=function(){h=g=void 0;p=n=
0};this.setUpdateFunction=function(a){u=a};this.addMapping=function(a){m.push(a);a.updateParameter(g,this)};this.removeMapping=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.backpropagate=function(b,c){isFinite(b)&&(a(b,c),u&&u(g))};this.update=function(b){k&&n<k?(p+=b,n++,n==k&&(h=p/=k)):isNaN(b)||(h&&(b-=h),a(b))}};function DynamicMusicObject(b,f,c){function a(d,b){b[d.getUri()]=d;for(var c=0;c<d.getParts().length;c++)a(d.getParts()[c],b)}function e(d,a,b,c){var f=d-a,g=c.getParts();if(c.getLevel()==b&&0==f)return c;if(c.getLevel()>=b-1)return f<g.length?g[f]:a+g.length;for(c=0;c<g.length;c++)if(a=e(d,a,b,g[c]),isNaN(a))return a}function g(d,a,b){var c=a.toFlatJson();d.nodes.push(c);b&&d.links.push(k(b,c));for(b=0;b<a.getParts().length;b++)g(d,a.getParts()[b],c)}function h(d,a,b){b||(b={});b[a.getUri()]||(b[a.getUri()]=
a.toFlatJson());var c=b[a.getUri()];d.nodes.push(c);for(var e=0;e<a.getSimilars().length;e++){var f=a.getSimilars()[e];b[f.getUri()]||(b[f.getUri()]=f.toFlatJson());d.links.push(k(c,b[f.getUri()]))}for(e=0;e<a.getParts().length;e++)h(d,a.getParts()[e],b)}function k(a,b){return{source:a,target:b,value:1}}var m=this,n=null,p=[],u=[],x={},q={},w=[],y=[],t;q[PLAY]=new Parameter(PLAY,0,!0);q[LOOP]=new Parameter(LOOP,0,!0);q[ONSET]=new Parameter(ONSET,-1);q[DURATION_RATIO]=new Parameter(DURATION_RATIO,
1);q[AMPLITUDE]=new Parameter(AMPLITUDE,1);q[PLAYBACK_RATE]=new Parameter(PLAYBACK_RATE,1);q[TIME_STRETCH_RATIO]=new Parameter(TIME_STRETCH_RATIO,1);q[PAN]=new Parameter(PAN,0);q[DISTANCE]=new Parameter(DISTANCE,0);q[HEIGHT]=new Parameter(HEIGHT,0);q[REVERB]=new Parameter(REVERB,0);q[FILTER]=new Parameter(FILTER,0);q[PART_INDEX]=new Parameter(PART_INDEX,0,!0);q[PART_COUNT]=new Parameter(PART_COUNT,Number.POSITIVE_INFINITY,!0);q[PLAY].addObserver(m);q[PART_INDEX].addObserver(m);q[PART_COUNT].addObserver(m);
var v=new SequentialNavigator(this);this.setType=function(a){c=a};this.getType=function(){return c};this.getUri=function(){return b};this.setParent=function(a){n=a;for(var b in q)b!=PLAY&&b!=PART_COUNT&&b!=PART_INDEX&&y.push(new Mapping([a.getParameter(b)],!0,void 0,[this],b));a=n.getMappings();var c=this.getDymoMap(),c=Object.keys(c).map(function(a){return c[a]});for(b=0;b<a.length;b++){var e=a[b].getDymoConstraint();e&&(e=a[b].getTargets().concat(c.filter(e)),a[b].setTargets(e))}};this.removeParent=
function(){for(var a=0;a<y.length;a++)y[a].disconnect();y=[];for(var b=n.getMappings(),c=this,a=0;a<b.length;a++){var e=b[a].getTargets(),e=e.filter(function(a){return!a.isSubDymoOf(c)});b[a].setTargets(e)}n=null};this.getParent=function(){return n};this.isSubDymoOf=function(a){for(var b=this;b;){if(b==a)return!0;b=b.getParent()}return!1};this.getDymoMap=function(){var b={};a(this,b);return b};this.getLevel=function(){return n?n.getLevel()+1:0};this.getIndex=function(){if(n)return n.getParts().indexOf(this)};
this.addPart=function(a){p.push(a);a.setParent(this)};this.removePart=function(a){p.splice(p.indexOf(a));a.removeParent(this)};this.replacePart=function(a,b){p[a]&&p[a].removeParent(this);p[a]=b;b.setParent(this)};this.getPart=function(a){return p[a]};this.getParts=function(){return p};this.getNthPart=function(a,b){return e(a,0,b,this)};this.setSourcePath=function(a){(t=a)&&f&&f.addSourceFile(a)};this.getSourcePath=function(){return n&&!t?n.getSourcePath():t};this.addSimilar=function(a){u.push(a)};
this.getSimilars=function(a){return u};this.getFeatures=function(){return x};this.setFeature=function(a,b){x[a]=b};this.getFeature=function(a){if(a===LEVEL)return this.getLevel();if(a===INDEX)return this.getIndex();if(x.hasOwnProperty(a))return x[a];if(n)return n.getFeature(a);for(var b=[],c=0;c<p.length;c++)if(p[c]){var e=p[c].getFeatureWithoutLookingFurther(a);isNaN(e)||b.push(e)}if(0<b.length)return b};this.getFeatureWithoutLookingFurther=function(a){if(x[a])return x[a]};this.getMappings=function(){return w};
this.getSegment=function(){return[this.getFeature("time"),q[DURATION_RATIO].getValue()*this.getFeature("duration")]};this.addParameter=function(a){q[a.getName()]=a};this.getParameter=function(a){return a==LISTENER_ORIENTATION?f.listenerOrientation:a==PART_ORDER?void 0:q[a]};this.addMapping=function(a){w.push(a)};this.observedParameterChanged=function(a){a.getName()==PLAY&&(0<a.getChange()?f.play(m):f.stop(m))};this.setNavigator=function(a){v=a};this.getNavigator=function(){return v};this.resetPartsPlayed=
function(){v.resetPartsPlayed();for(var a=0;a<p.length;a++)p[a].resetPartsPlayed()};this.updatePartOrder=function(a){p&&p[0]&&!isNaN(p[0].getFeature(a))?p.sort(function(b,c){return b.getFeature(a)-c.getFeature(a)}):p&&p.sort(function(b,c){return b.getParameter(a).getValue()-c.getParameter(a).getValue()})};this.getNextParts=function(){return v.getNextParts()};this.toJsonHierarchy=function(){for(var a=this.toFlatJson(),b=0;b<p.length;b++)a.parts.push(p[b].toJsonHierarchy());return a};this.toJsonHierarchyGraph=
function(){var a={nodes:[],links:[]};g(a,this);return a};this.toJsonSimilarityGraph=function(){var a={nodes:[],links:[]};h(a,this);return a};this.toFlatJson=function(){var a={"@id":b,"@type":DYMO};c&&(a.ct=c);t&&(a.source=t);v instanceof SimilarityNavigator&&(a.navigator=SIMILARITY_NAVIGATOR);for(var e in x)a[e]=this.getFeatureJson(e);if(0<w.length)for(a.mappings=[],e=0;e<w.length;e++)a.mappings.push(w[e].toJson());0<p.length&&(a.parts=[]);if(0<u.length)for(a.similars=[],e=0;e<u.length;e++)a.similars.push(u[e].getUri());
return a};this.getFeatureJson=function(a){return{value:x[a],type:FEATURE,adt:a.charAt(0).toUpperCase()+a.slice(1)}}};function Mapping(b,f,c,a,e,g){function h(a){for(var c=[],e=0;e<b.length;e++){var g;g="string"===typeof b[e]||b[e]instanceof String?a.getFeature(b[e]):f?b[e].getChange():b[e].getValue();c[e]=g}return m.apply(this,c)}var k=new FunctionInverter;c||(c=["a","return a;"]);var m=Function.apply(null,c),n,p=k.invert(k.toReturnValueString(c[c.length-1]));p&&(n=k.toJavaScriptFunction(p));this.getTargets=function(){return a};this.setTargets=function(b){a=b;for(b=0;b<a.length;b++)a[b].getParameter(e).addUpdater(this)};
this.getDymoConstraint=function(){return g};this.disconnect=function(){for(var c=0;c<b.length;c++)b[c].removeMapping?b[c].removeMapping(this):b[c].removeObserver&&b[c].removeObserver(this);for(c=0;c<a.length;c++)a[c].getParameter(e).removeUpdater(this)};this.updateParameter=function(){for(var b=0;b<a.length;b++)f?a[b].getParameter(e).relativeUpdate(h(a[b]),this):a[b].getParameter(e).update(h(a[b]),this)};this.observedParameterChanged=function(a){this.updateParameter()};this.updatedParameterChanged=
function(a){b[0].backpropagate&&!f&&(n&&(a=n(a)),b[0].backpropagate(a,this))};this.requestValue=function(a){for(var c=0;c<b.length;c++)b[c].requestValue&&b[c].requestValue();return h(a)};this.toJson=function(){for(var f=[],g=0;g<b.length;g++)b[g]instanceof Control?f.push({name:b[g].getName(),type:b[g].getType()}):b[g]instanceof Parameter?f.push({name:b[g].getName(),type:"Parameter"}):f.push({name:b[g],type:"Feature"});var f={domainDims:f,"function":c},g=a.filter(function(a){return a instanceof DynamicMusicObject}).map(function(a){return a.getUri()}),
h=a.filter(function(a){return!(a instanceof DynamicMusicObject)}).map(function(a){return a.getUri()});0<g.length&&(f.dymos=g);0<h.length&&(f.controls=h);f.parameter=e;return f};for(k=0;k<b.length;k++)b[k].addMapping?b[k].addMapping(this):b[k].addObserver&&b[k].addObserver(this);for(k=0;k<a.length;k++)a[k].getParameter(e).addUpdater(this)};function Parameter(b,f,c){function a(a,b){if(!isNaN(b)&&(c&&(b=Math.round(b)),1E-6<Math.abs(b-g))){h=b-g;g=b;for(var f=0;f<k.length;f++)k[f]!=a&&k[f].updatedParameterChanged(g);if(h)for(f=0;f<m.length;f++)m[f].observedParameterChanged(e)}}var e=this,g=f,h=0,k=[],m=[];this.getName=function(){return b};this.getValue=function(){return g};this.getChange=function(){return h};this.addUpdater=function(a){0>k.indexOf(a)&&(k.push(a),a.updatedParameterChanged(g))};this.removeUpdater=function(a){a=k.indexOf(a);
-1<a&&k.splice(a,1)};this.addObserver=function(a){m.push(a)};this.removeObserver=function(a){a=m.indexOf(a);-1<a&&m.splice(a,1)};this.getObservers=function(){return m};this.update=function(b,c){a(c,b)};this.relativeUpdate=function(a,b){this.update(g+a,b)};this.requestValue=function(){for(var b=0;b<k.length;b++){var c=k[b].requestValue();if(c&&c!=g){a(k[b],c);break}}return g}};function Rendering(b){var f=[];this.play=function(){b&&b.getParameter(PLAY).update(1)};this.stop=function(){b&&b.getParameter(PLAY).update(0)};this.addMapping=function(b){f.push(b);b.updateParameter()};this.getMappings=function(){return f};this.toJson=function(){var c={mappings:[]};b&&(c.topDymo=b.getUri());for(var a=0;a<f.length;a++)c.mappings.push(f[a].toJson());return c}};function FunctionInverter(){function b(a){if(a.isOperatorNode||a.isParenthesisNode||a.isSymbolNode)return a}function f(a){if("+"==a)return"-";if("-"==a)return"+";if("*"==a)return"/";if("/"==a)return"*"}function c(a){if("+"==a)return"add";if("-"==a)return"subtract";if("*"==a)return"multiply";if("/"==a)return"divide"}this.invert=function(a){var e;try{e=math.parse(a)}catch(k){k instanceof SyntaxError||console.log(k);return}for(var g=a=new math.expression.node.SymbolNode("a");e;)if(e.isSymbolNode)a.name=
e.name,e=void 0;else if(e.isParenthesisNode)e=e.content;else if(e.isOperatorNode){var h=f(e.op);if("+"==e.op||"*"==e.op)if(e.args[0].isConstantNode)g=new math.expression.node.OperatorNode(h,c(h),[g,e.args[0]]),e=b(e.args[1]);else if(e.args[1].isConstantNode)g=new math.expression.node.OperatorNode(h,c(h),[g,e.args[1]]),e=b(e.args[0]);else return;else if("-"==e.op||"/"==e.op)if(e.args[0].isConstantNode)g=new math.expression.node.OperatorNode(e.op,c(e.op),[e.args[0],g]),e=b(e.args[1]);else if(e.args[1].isConstantNode)g=
new math.expression.node.OperatorNode(h,c(h),[g,e.args[1]]),e=b(e.args[0]);else return}else return;return g.toString()};this.toJavaScriptFunction=function(a){return new Function("a","return "+a+";")};this.toReturnValueString=function(a){return a.substring(a.indexOf("return ")+7,a.indexOf(";"))}};function PolygonTools(){}PolygonTools.isPointInPolygon=function(b,f){for(var c=!1,a=-1,e=b.length,g=e-1;++a<e;g=a)(b[a][1]<=f[1]&&f[1]<b[g][1]||b[g][1]<=f[1]&&f[1]<b[a][1])&&f[0]<(b[g][0]-b[a][0])*(f[1]-b[a][1])/(b[g][1]-b[a][1])+b[a][0]&&(c=!c);return c};PolygonTools.getArea=function(b){var f=0,c,a,e=0;for(a=b.length-1;e<b.length;a=e,e++)c=b[e],a=b[a],f+=c[0]*a[1],f-=c[1]*a[0];return f/2};
PolygonTools.getCentroid=function(b){var f,c,a,e=0,g=0,h=0;for(c=b.length-1;h<b.length;c=h,h++)f=b[h],c=b[c],a=f[0]*c[1]-c[0]*f[1],e+=(f[0]+c[0])*a,g+=(f[1]+c[1])*a;a=6*PolygonTools.getArea(b);return{0:e/a,1:g/a}};function sqDist(b,f){return Math.pow(b[0]-f[0],2)+Math.pow(b[1]-f[1],2)}
PolygonTools.getDistanceFromSegment=function(b,f,c){var a=sqDist(f,c);if(0==a)return sqDist(b,f);a=((b[0]-f[0])*(c[0]-f[0])+(b[1]-f[1])*(c[1]-f[1]))/a;return 0>a?sqDist(b,f):1<a?sqDist(b,c):Math.sqrt(sqDist(b,{0:f[0]+a*(c[0]-f[0]),1:f[1]+a*(c[1]-f[1])}))};PolygonTools.getMinDistanceFromEdge=function(b,f){for(var c=Number.POSITIVE_INFINITY,a=0;a<b.length;a++)var e=PolygonTools.getDistanceFromSegment(f,b[a],b[(a+1)%b.length]),c=Math.min(e,c);return c};
PolygonTools.howFarIsPointInPolygon=function(b,f,c){return PolygonTools.isPointInPolygon(b,c)?(f=Math.sqrt(Math.pow(c[0]-f[0],2)+Math.pow(c[1]-f[1],2)),b=PolygonTools.getMinDistanceFromEdge(b,c),Math.sqrt((1-f)*b/Math.abs(f+b))):0};PolygonTools.getPolygonFunctionArgs=function(b){return["a","b","return PolygonTools.isPointInPolygon("+getPolygonOrPointString(b)+", {0:a, 1:b});"]};
PolygonTools.getInterpolatedPolygonFunctionArgs=function(b){var f=getPolygonOrPointString(b);b=getPolygonOrPointString(PolygonTools.getCentroid(b));return["a","b","return PolygonTools.howFarIsPointInPolygon("+f+","+b+", {0:a, 1:b});"]};function getPolygonOrPointString(b){return JSON.stringify(b).replace(/"/g,"'")};function SequentialNavigator(b){var f=!1,c=0;this.resetPartsPlayed=function(){c=0};this.setPartsPlayed=function(a){c=a};this.getPartsPlayed=function(){return c};this.getNextParts=function(){var a=b.getParts();if(0<a.length){if(b.getType()==PARALLEL){for(var e=[],g=0;g<a.length;g++){var h=a[g].getNextParts();h&&(!h.length||0<h.length)&&(e=e.concat(h))}if(0<e.length)return console.log(e.map(function(a){return a.getIndex()})),e}else for(f=!0;c<a.length&&c<b.getParameter(PART_COUNT).getValue();){if((h=
a[c].getNextParts())&&(!h.length||0<h.length))return h instanceof Array||(h=[h]),h;c++}c=0;f=!1;return null}if(f)return f=!1,null;f=!0;return[b]}};function SimilarityNavigator(b){function f(a){for(var f=0;f<a.length;f++)if(0<a[f].getSimilars().length&&Math.random()<c.leapingProbability.getValue()){var k=a[f].getSimilars(),m=Math.floor(Math.random()*k.length);if(c.continueAfterLeaping.getValue()){var n=b.getParts().indexOf(m);n&&(e=n+1)}a[f]=k[m]}}var c=this,a=!1,e=0;this.leapingProbability=new Parameter(LEAPING_PROBABILITY,.5);this.continueAfterLeaping=new Parameter(CONTINUE_AFTER_LEAPING,0,!0);this.resetPartsPlayed=function(){e=0};this.getNextParts=
function(){var c=b.getParts();if(0<c.length){if(b.getType()==PARALLEL){for(var h=[],k=0;k<c.length;k++){var m=c[k].getNextParts();m&&(!m.length||0<m.length)&&(h=h.concat(m))}if(0<h.length)return f(h),h}else for(a=!0;e<c.length&&e<b.getParameter(PART_COUNT).getValue();){if((m=c[e].getNextParts())&&(!m.length||0<m.length))return m instanceof Array||(m=[m]),f(m),m;e++}e=0;a=!1;return null}if(a)return a=!1,null;a=!0;return[b]}};
